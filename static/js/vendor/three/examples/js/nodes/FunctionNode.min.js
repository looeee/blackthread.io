THREE.FunctionNode=function(t,e,i,o){t=t||"",this.isMethod="string"!=typeof e,this.useKeywords=!0,THREE.TempNode.call(this,this.isMethod?null:e),this.isMethod?this.eval(t,e,i,o):this.eval(t,i,o)},THREE.FunctionNode.rDeclaration=/^([a-z_0-9]+)\s([a-z_0-9]+)\s?\((.*?)\)/i,THREE.FunctionNode.rProperties=/[a-z_0-9]+/gi,THREE.FunctionNode.prototype=Object.create(THREE.TempNode.prototype),THREE.FunctionNode.prototype.constructor=THREE.FunctionNode,THREE.FunctionNode.prototype.nodeType="Function",THREE.FunctionNode.prototype.isShared=function(t,e){return!this.isMethod},THREE.FunctionNode.prototype.getType=function(t){return t.getTypeByFormat(this.type)},THREE.FunctionNode.prototype.getInputByName=function(t){for(var e=this.inputs.length;e--;)if(this.inputs[e].name===t)return this.inputs[e]},THREE.FunctionNode.prototype.getIncludeByName=function(t){for(var e=this.includes.length;e--;)if(this.includes[e].name===t)return this.includes[e]},THREE.FunctionNode.prototype.generate=function(t,e){for(var i,o=0,s=this.value,n=0;n<this.includes.length;n++)t.include(this.includes[n],this);for(var r in this.extensions)t.material.extensions[r]=!0;for(;i=THREE.FunctionNode.rProperties.exec(this.value);){var h=i[0],u=!this.isMethod||!this.getInputByName(h),d=h;if(this.keywords[h]||this.useKeywords&&u&&THREE.NodeLib.containsKeyword(h)){var c=this.keywords[h];if(!c){var a=THREE.NodeLib.getKeywordData(h);a.cache&&(c=t.keywords[h]),c=c||THREE.NodeLib.getKeyword(h,t),a.cache&&(t.keywords[h]=c)}d=c.build(t)}h!=d&&(s=s.substring(0,i.index+o)+d+s.substring(i.index+h.length+o),o+=d.length-h.length),void 0===this.getIncludeByName(d)&&THREE.NodeLib.contains(d)&&t.include(THREE.NodeLib.get(d))}return"source"===e?s:this.isMethod?(t.include(this,!1,s),this.name):t.format("("+s+")",this.getType(t),e)},THREE.FunctionNode.prototype.eval=function(t,e,i,o){if(t=(t||"").trim(),this.includes=e||[],this.extensions=i||{},this.keywords=o||{},this.isMethod){var s=t.match(THREE.FunctionNode.rDeclaration);if(this.inputs=[],s&&4==s.length){this.type=s[1],this.name=s[2];var n=s[3].match(THREE.FunctionNode.rProperties);if(n)for(var r=0;r<n.length;){var h,u,d=n[r++];"in"==d||"out"==d||"inout"==d?h=n[r++]:(h=d,d=""),u=n[r++],this.inputs.push({name:u,type:h,qualifier:d})}}else this.type="",this.name=""}this.value=t},THREE.FunctionNode.prototype.toJSON=function(t){var e=this.getJSONNode(t);if(!e){for(var i in(e=this.createJSONNode(t)).src=this.value,e.isMethod=this.isMethod,e.useKeywords=this.useKeywords,this.isMethod||(e.out=this.type),e.extensions=JSON.parse(JSON.stringify(this.extensions)),e.keywords={},this.keywords)e.keywords[i]=this.keywords[i].toJSON(t).uuid;if(this.includes.length){e.includes=[];for(var o=0;o<this.includes.length;o++)e.includes.push(this.includes[o].toJSON(t).uuid)}}return e};