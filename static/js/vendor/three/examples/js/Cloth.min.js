var lastTime,DAMPING=.03,DRAG=1-DAMPING,MASS=.1,restDistance=25,xSegs=10,ySegs=10,clothFunction=plane(restDistance*xSegs,restDistance*ySegs),cloth=new Cloth(xSegs,ySegs),GRAVITY=981*1.4,gravity=new THREE.Vector3(0,-GRAVITY,0).multiplyScalar(MASS),TIMESTEP=.018,TIMESTEP_SQ=TIMESTEP*TIMESTEP,pins=[],wind=!0,windStrength=2,windForce=new THREE.Vector3(0,0,0),ballPosition=new THREE.Vector3(0,-45,0),ballSize=60,tmpForce=new THREE.Vector3;function plane(t,i){return function(o,s){var e=(o-.5)*t,n=(s+.5)*i;return new THREE.Vector3(e,n,0)}}function Particle(t,i,o,s){this.position=clothFunction(t,i),this.previous=clothFunction(t,i),this.original=clothFunction(t,i),this.a=new THREE.Vector3(0,0,0),this.mass=s,this.invMass=1/s,this.tmp=new THREE.Vector3,this.tmp2=new THREE.Vector3}Particle.prototype.addForce=function(t){this.a.add(this.tmp2.copy(t).multiplyScalar(this.invMass))},Particle.prototype.integrate=function(t){var i=this.tmp.subVectors(this.position,this.previous);i.multiplyScalar(DRAG).add(this.position),i.add(this.a.multiplyScalar(t)),this.tmp=this.previous,this.previous=this.position,this.position=i,this.a.set(0,0,0)};var diff=new THREE.Vector3;function satisfyConstraints(t,i,o){diff.subVectors(i.position,t.position);var s=diff.length();if(0!==s){var e=diff.multiplyScalar(1-o/s).multiplyScalar(.5);t.position.add(e),i.position.sub(e)}}function Cloth(t,i){t=t||10,i=i||10,this.w=t,this.h=i;var o,s,e=[],n=[];for(s=0;s<=i;s++)for(o=0;o<=t;o++)e.push(new Particle(o/t,s/i,0,MASS));for(s=0;s<i;s++)for(o=0;o<t;o++)n.push([e[r(o,s)],e[r(o,s+1)],restDistance]),n.push([e[r(o,s)],e[r(o+1,s)],restDistance]);for(o=t,s=0;s<i;s++)n.push([e[r(o,s)],e[r(o,s+1)],restDistance]);for(s=i,o=0;o<t;o++)n.push([e[r(o,s)],e[r(o+1,s)],restDistance]);function r(i,o){return i+o*(t+1)}this.particles=e,this.constraints=n,this.index=r}function simulate(t){if(lastTime){var i,o,s,e,n,r;if(wind){var a,l,c=clothGeometry.faces;for(s=cloth.particles,i=0,o=c.length;i<o;i++)l=(a=c[i]).normal,tmpForce.copy(l).normalize().multiplyScalar(l.dot(windForce)),s[a.a].addForce(tmpForce),s[a.b].addForce(tmpForce),s[a.c].addForce(tmpForce)}for(i=0,o=(s=cloth.particles).length;i<o;i++)(e=s[i]).addForce(gravity),e.integrate(TIMESTEP_SQ);for(o=(n=cloth.constraints).length,i=0;i<o;i++)satisfyConstraints((r=n[i])[0],r[1],r[2]);if(ballPosition.z=90*-Math.sin(Date.now()/600),ballPosition.x=70*Math.cos(Date.now()/400),sphere.visible)for(i=0,o=(s=cloth.particles).length;i<o;i++){var p=(e=s[i]).position;diff.subVectors(p,ballPosition),diff.length()<ballSize&&(diff.normalize().multiplyScalar(ballSize),p.copy(ballPosition).add(diff))}for(i=0,o=(s=cloth.particles).length;i<o;i++)(p=(e=s[i]).position).y<-250&&(p.y=-250);for(i=0,o=pins.length;i<o;i++){var h=s[pins[i]];h.position.copy(h.original),h.previous.copy(h.original)}}else lastTime=t}