THREE.TimelinerController=function(t,e,i){this._scene=t,this._trackInfo=e,this._onUpdate=i,this._mixer=new THREE.AnimationMixer(t),this._clip=null,this._action=null,this._tracks={},this._propRefs={},this._channelNames=[]},THREE.TimelinerController.prototype={constructor:THREE.TimelinerController,init:function(t){for(var e=[],i=this._trackInfo,r=0,n=i.length;r!==n;++r){var s=i[r];e.push(this._addTrack(s.type,s.propertyPath,s.initialValue,s.interpolation))}this._clip=new THREE.AnimationClip("editclip",0,e),this._action=this._mixer.clipAction(this._clip).play()},setDisplayTime:function(t){this._action.time=t,this._mixer.update(0),this._onUpdate()},setDuration:function(t){this._clip.duration=t},getChannelNames:function(){return this._channelNames},getChannelKeyTimes:function(t){return this._tracks[t].times},setKeyframe:function(t,e){var i=this._tracks[t],r=i.times,n=Timeliner.binarySearch(r,e),s=i.values,a=i.getValueSize(),l=n*a;if(n<0){l=(n=~n)*a;for(var h=r.length+1,o=s.length+a,c=h-1;c!==n;--c)r[c]=r[c-1];c=o-1;for(var u=l+a-1;c!==u;--c)s[c]=s[c-a]}r[n]=e,this._propRefs[t].getValue(s,l)},delKeyframe:function(t,e){var i=this._tracks[t],r=i.times,n=Timeliner.binarySearch(r,e);if(r.length>1&&n>=0){for(var s=r.length-1,a=i.values,l=i.getValueSize(),h=a.length-l,o=n;o!==s;++o)r[o]=r[o+1];r.pop();for(var c=n*l;c!==h;++c)a[c]=a[c+l];a.length=h}},moveKeyframe:function(t,e,i,r){var n=this._tracks[t],s=n.times,a=Timeliner.binarySearch(s,e);if(a>=0){for(var l=r?s.length:a+1,h=s[a-1]<=e||!r&&e>=s[a+1];a!==l;)s[a++]+=i;h&&this._sort(n)}},serialize:function(){for(var t={duration:this._clip.duration,channels:{}},e=this._channelNames,i=this._tracks,r=t.channels,n=0,s=e.length;n!==s;++n){var a=e[n],l=i[a];r[a]={times:l.times,values:l.values}}return t},deserialize:function(t){var e=this._channelNames,i=this._tracks,r=t.channels;this.setDuration(t.duration);for(var n=0,s=e.length;n!==s;++n){var a=e[n],l=i[a],h=r[a];this._setArray(l.times,h.times),this._setArray(l.values,h.values)}this.setDisplayTime(this._mixer.time)},_sort:function(t){var e=t.times,i=THREE.AnimationUtils.getKeyframeOrder(e);this._setArray(e,THREE.AnimationUtils.sortedArray(e,1,i));var r=t.values,n=t.getValueSize();this._setArray(r,THREE.AnimationUtils.sortedArray(r,n,i))},_setArray:function(t,e){t.length=0,t.push.apply(t,e)},_addTrack:function(t,e,i,r){var n=new t(e,[0],i,r);return n.times=Array.prototype.slice.call(n.times),n.values=Array.prototype.slice.call(n.values),this._channelNames.push(e),this._tracks[e]=n,this._propRefs[e]=new THREE.PropertyBinding(this._scene,e),n}};