THREE.MMDLoader=function(e){THREE.Loader.call(this),this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.parser=new MMDParser.Parser,this.textureCrossOrigin=null},THREE.MMDLoader.prototype=Object.create(THREE.Loader.prototype),THREE.MMDLoader.prototype.constructor=THREE.MMDLoader,THREE.MMDLoader.prototype.defaultToonTextures=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="],THREE.MMDLoader.prototype.setTextureCrossOrigin=function(e){this.textureCrossOrigin=e},THREE.MMDLoader.prototype.load=function(e,t,r,a,n){var o=this;this.loadModel(e,function(e){o.loadVmds(t,function(t){o.pourVmdIntoModel(e,t),r(e)},a,n)},a,n)},THREE.MMDLoader.prototype.loadModel=function(e,t,r,a){var n=this,o=THREE.LoaderUtils.extractUrlBase(e),i=this.extractExtension(e);this.loadFileAsBuffer(e,function(e){t(n.createModel(e,i,o,r,a))},r,a)},THREE.MMDLoader.prototype.createModel=function(e,t,r,a,n){return this.createMesh(this.parseModel(e,t),r,a,n)},THREE.MMDLoader.prototype.loadVmd=function(e,t,r,a){var n=this;this.loadFileAsBuffer(e,function(e){t(n.parseVmd(e))},r,a)},THREE.MMDLoader.prototype.loadVmds=function(e,t,r,a){var n=this,o=[];e=e.slice(),function i(){var s=e.shift();n.loadVmd(s,function(r){o.push(r),e.length>0?i():t(n.mergeVmds(o))},r,a)}()},THREE.MMDLoader.prototype.loadAudio=function(e,t,r,a){var n=new THREE.AudioListener,o=new THREE.Audio(n);new THREE.AudioLoader(this.manager).load(e,function(e){o.setBuffer(e),t(o,n)},r,a)},THREE.MMDLoader.prototype.loadVpd=function(e,t,r,a,n){var o=this;(n&&"unicode"===n.charcode?this.loadFileAsText:this.loadFileAsShiftJISText).bind(this)(e,function(e){t(o.parseVpd(e))},r,a)},THREE.MMDLoader.prototype.parseModel=function(e,t){switch(t.toLowerCase()){case"pmd":return this.parsePmd(e);case"pmx":return this.parsePmx(e);default:throw"extension "+t+" is not supported."}},THREE.MMDLoader.prototype.parsePmd=function(e){return this.parser.parsePmd(e,!0)},THREE.MMDLoader.prototype.parsePmx=function(e){return this.parser.parsePmx(e,!0)},THREE.MMDLoader.prototype.parseVmd=function(e){return this.parser.parseVmd(e,!0)},THREE.MMDLoader.prototype.parseVpd=function(e){return this.parser.parseVpd(e,!0)},THREE.MMDLoader.prototype.mergeVmds=function(e){return this.parser.mergeVmds(e)},THREE.MMDLoader.prototype.pourVmdIntoModel=function(e,t,r){this.createAnimation(e,t,r)},THREE.MMDLoader.prototype.pourVmdIntoCamera=function(e,t,r){var a=new THREE.MMDLoader.DataCreationHelper;!function(){for(var n,o,i=a.createOrderedMotionArray(t.cameras),s=[],u=[],l=[],p=[],h=[],d=[],c=[],A=[],f=[],m=new THREE.Quaternion,E=new THREE.Euler,g=new THREE.Vector3,M=new THREE.Vector3,y=function(e,t){e.push(t.x),e.push(t.y),e.push(t.z)},T=function(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)},v=function(e,t,r,a,n){if(r.length>2){r=r.slice(),a=a.slice(),n=n.slice();for(var o=a.length/r.length,i=3===o?12:4,s=1,u=2,l=r.length;u<l;u++){for(var p=0;p<o;p++)if(a[s*o+p]!==a[(s-1)*o+p]||a[s*o+p]!==a[u*o+p]){s++;break}if(u>s){for(r[s]=r[u],p=0;p<o;p++)a[s*o+p]=a[u*o+p];for(p=0;p<i;p++)n[s*i+p]=n[u*i+p]}}r.length=s+1,a.length=(s+1)*o,n.length=(s+1)*i}return new THREE.MMDLoader[t](e,r,a,n)},R=0;R<i.length;R++){var H=i[R],x=H.frameNum/30,C=H.position,b=H.rotation,B=H.distance,k=H.fov,I=H.interpolation;g.set(0,0,-B),M.set(C[0],C[1],C[2]),E.set(-b[0],-b[1],-b[2]),m.setFromEuler(E),g.add(M),g.applyQuaternion(m),s.length>0&&x<s[s.length-1]+.05&&(s[s.length-1]=x-1e-13),s.push(x),y(u,M),(n=l).push((o=m).x),n.push(o.y),n.push(o.z),n.push(o.w),y(p,g),h.push(k);for(var D=0;D<3;D++)T(d,I,D);for(T(c,I,3),D=0;D<3;D++)T(A,I,4);T(f,I,5)}if(0!==s.length){var w=[];w.push(v(".center","VectorKeyframeTrackEx",s,u,d)),w.push(v(".quaternion","QuaternionKeyframeTrackEx",s,l,c)),w.push(v(".position","VectorKeyframeTrackEx",s,p,A)),w.push(v(".fov","NumberKeyframeTrackEx",s,h,f));var L=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r,-1,w);void 0===e.center&&(e.center=new THREE.Vector3(0,0,0)),void 0===e.animations&&(e.animations=[]),e.animations.push(L)}}()},THREE.MMDLoader.prototype.extractExtension=function(e){var t=e.lastIndexOf(".");return t<0?null:e.slice(t+1)},THREE.MMDLoader.prototype.loadFile=function(e,t,r,a,n,o){var i=new THREE.FileLoader(this.manager);return void 0!==o&&i.setMimeType(o),i.setResponseType(n),i.load(e,function(e){t(e)},r,a)},THREE.MMDLoader.prototype.loadFileAsBuffer=function(e,t,r,a){this.loadFile(e,t,r,a,"arraybuffer")},THREE.MMDLoader.prototype.loadFileAsText=function(e,t,r,a){this.loadFile(e,t,r,a,"text")},THREE.MMDLoader.prototype.loadFileAsShiftJISText=function(e,t,r,a){this.loadFile(e,t,r,a,"text","text/plain; charset=shift_jis")},THREE.MMDLoader.prototype.createMesh=function(e,t,r,a){var n=this,o=new THREE.BufferGeometry,i=[],s={vertices:[],uvs:[],normals:[],skinIndices:[],skinWeights:[],indices:[]};return function(){for(var t=0;t<e.metadata.vertexCount;t++){for(var r=e.vertices[t],a=0,n=r.position.length;a<n;a++)s.vertices.push(r.position[a]);for(a=0,n=r.normal.length;a<n;a++)s.normals.push(r.normal[a]);for(a=0,n=r.uv.length;a<n;a++)s.uvs.push(r.uv[a]);for(a=0;a<4;a++)s.skinIndices.push(r.skinIndices.length-1>=a?r.skinIndices[a]:0);for(a=0;a<4;a++)s.skinWeights.push(r.skinWeights.length-1>=a?r.skinWeights[a]:0)}}(),function(){for(var t=0;t<e.metadata.faceCount;t++)for(var r=e.faces[t],a=0,n=r.indices.length;a<n;a++)s.indices.push(r.indices[a])}(),function(){for(var t=[],r=e.rigidBodies,a={},n=0,i=r.length;n<i;n++){var s=r[n],u=a[s.boneIndex];u=void 0===u?s.type:Math.max(s.type,u),a[s.boneIndex]=u}for(n=0;n<e.metadata.boneCount;n++){var l={},p=e.bones[n];l.parent=p.parentIndex,l.name=p.name,l.pos=[p.position[0],p.position[1],p.position[2]],l.rotq=[0,0,0,1],l.scl=[1,1,1],-1!==l.parent&&(l.pos[0]-=e.bones[l.parent].position[0],l.pos[1]-=e.bones[l.parent].position[1],l.pos[2]-=e.bones[l.parent].position[2]),l.rigidBodyType=void 0!==a[n]?a[n]:-1,t.push(l)}o.bones=t}(),function(){var t=[];if("pmd"===e.metadata.format)for(var r=0;r<e.metadata.ikCount;r++){var a=e.iks[r];(i={}).target=a.target,i.effector=a.effector,i.iteration=a.iteration,i.maxAngle=4*a.maxAngle,i.links=[];for(var n=0;n<a.links.length;n++)(s={}).index=a.links[n].index,e.bones[s.index].name.indexOf("ひざ")>=0&&(s.limitation=new THREE.Vector3(1,0,0)),i.links.push(s);t.push(i)}else for(r=0;r<e.metadata.boneCount;r++)if(void 0!==(a=e.bones[r].ik)){var i;for((i={}).target=r,i.effector=a.effector,i.iteration=a.iteration,i.maxAngle=a.maxAngle,i.links=[],n=0;n<a.links.length;n++){var s;(s={}).index=a.links[n].index,s.enabled=!0,1===a.links[n].angleLimitation&&(s.limitation=new THREE.Vector3(1,0,0)),i.links.push(s)}t.push(i)}o.iks=t}(),function(){if("pmd"!==e.metadata.format){for(var t=[],r=0;r<e.metadata.boneCount;r++){var a=e.bones[r],n=a.grant;if(void 0!==n){var i={};i.index=r,i.parentIndex=n.parentIndex,i.ratio=n.ratio,i.isLocal=n.isLocal,i.affectRotation=n.affectRotation,i.affectPosition=n.affectPosition,i.transformationClass=a.transformationClass,t.push(i)}}t.sort(function(e,t){return e.transformationClass-t.transformationClass}),o.grants=t}}(),function(){function t(t,r,a){for(var n=0;n<r.elementCount;n++){var o,i=r.elements[n];o="pmd"===e.metadata.format?e.morphs[0].elements[i.index].index:i.index,u=o,l=i,p=a,(s=t).array[3*u+0]+=l.position[0]*p,s.array[3*u+1]+=l.position[1]*p,s.array[3*u+2]+=l.position[2]*p}var s,u,l,p}for(var r=[],a=[],n=0;n<e.metadata.morphCount;n++){var i=e.morphs[n],u={name:i.name},l=new THREE.Float32BufferAttribute(3*e.metadata.vertexCount,3);l.name=i.name;for(var p=0;p<3*e.metadata.vertexCount;p++)l.array[p]=s.vertices[p];if("pmd"===e.metadata.format)0!==n&&t(l,i,1);else if(0===i.type)for(p=0;p<i.elementCount;p++){var h=e.morphs[i.elements[p].index],d=i.elements[p].ratio;1===h.type&&t(l,h,d)}else 1===i.type?t(l,i,1):2===i.type||3===i.type||4===i.type||5===i.type||6===i.type||7===i.type||i.type;r.push(u),a.push(l)}o.morphTargets=r,o.morphAttributes.position=a}(),function(){var s,u={},l=new THREE.TextureLoader(n.manager),p=new THREE.TGALoader(n.manager),h=document.createElement("canvas"),d=h.getContext("2d"),c=0,A=[];function f(e,o){var i;if(void 0===o&&(o={}),!0===o.defaultTexturePath)try{i=n.defaultToonTextures[parseInt(e.match("toon([0-9]{2}).bmp$")[1])]}catch(t){console.warn("THREE.MMDLoader: "+e+" seems like not right default texture path. Using toon00.bmp instead."),i=n.defaultToonTextures[0]}else i=t+e;if(void 0!==u[i])return i;var s=THREE.Loader.Handlers.get(i);null===s&&(s=e.indexOf(".tga")>=0?p:l);var c=s.load(i,function(e){if(!0===o.isToonTexture){var t=e.image,r=t.width,a=t.height;h.width=r,h.height=a,d.clearRect(0,0,r,a),d.translate(r/2,a/2),d.rotate(.5*Math.PI),d.translate(-r/2,-a/2),d.drawImage(t,0,0),e.image=d.getImageData(0,0,r,a)}e.flipY=!1,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping;for(var n=0;n<c.readyCallbacks.length;n++)c.readyCallbacks[n](c);delete c.readyCallbacks},r,a);return!0===o.sphericalReflectionMapping&&(c.mapping=THREE.SphericalReflectionMapping),c.readyCallbacks=[],u[i]=c,i}function m(e,t){return void 0===t[e]&&console.warn("THREE.MMDLoader: Undefined texture",e),t[e]}null!==n.textureCrossOrigin&&l.setCrossOrigin(n.textureCrossOrigin);for(var E=0;E<e.metadata.materialCount;E++){var g=e.materials[E],M={};if(M.faceOffset=c,M.faceNum=g.faceCount,c+=g.faceCount,M.name=g.name,M.color=new THREE.Color(g.diffuse[0],g.diffuse[1],g.diffuse[2]),M.opacity=g.diffuse[3],M.specular=new THREE.Color(g.specular[0],g.specular[1],g.specular[2]),M.shininess=g.shininess,1===M.opacity?(M.side=THREE.FrontSide,M.transparent=!1):(M.side=THREE.DoubleSide,M.transparent=!0),"pmd"===e.metadata.format){if(g.fileName){var y=g.fileName,T=[],v=y.lastIndexOf("*");v>=0?(T.push(y.slice(0,v)),T.push(y.slice(v+1))):T.push(y);for(var R=0;R<T.length;R++)(H=T[R]).indexOf(".sph")>=0||H.indexOf(".spa")>=0?(M.envMap=f(H,{sphericalReflectionMapping:!0}),H.indexOf(".sph")>=0?M.envMapType=THREE.MultiplyOperation:M.envMapType=THREE.AddOperation):M.map=f(H)}}else{if(-1!==g.textureIndex){var H=e.textures[g.textureIndex];M.map=f(H)}-1===g.envTextureIndex||1!==g.envFlag&&2!=g.envFlag||(H=e.textures[g.envTextureIndex],M.envMap=f(H,{sphericalReflectionMapping:!0}),1===g.envFlag?M.envMapType=THREE.MultiplyOperation:M.envMapType=THREE.AddOperation)}var x=void 0===M.map?1:.2;M.emissive=new THREE.Color(g.ambient[0]*x,g.ambient[1]*x,g.ambient[2]*x),A.push(M)}for(E=0;E<A.length;E++){var C=A[E],b=e.materials[E];if(g=new THREE.MeshToonMaterial,o.addGroup(3*C.faceOffset,3*C.faceNum,E),void 0!==C.name&&(g.name=C.name),g.skinning=o.bones.length>0,g.morphTargets=o.morphTargets.length>0,g.lights=!0,g.side="pmx"===e.metadata.format&&1==(1&b.flag)?THREE.DoubleSide:C.side,g.transparent=C.transparent,g.fog=!0,g.blending=THREE.CustomBlending,g.blendSrc=THREE.SrcAlphaFactor,g.blendDst=THREE.OneMinusSrcAlphaFactor,g.blendSrcAlpha=THREE.SrcAlphaFactor,g.blendDstAlpha=THREE.DstAlphaFactor,void 0!==C.map){function B(e){e.map.readyCallbacks.push(function(t){function r(e,t){var r=e.width,a=e.height,n=Math.round(t.x*r)%r,o=Math.round(t.y*a)%a;n<0&&(n+=r),o<0&&(o+=a);var i=o*r+n;return e.data[4*i+3]}var a=void 0!==t.image.data?t.image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");return r.drawImage(e,0,0),r.getImageData(0,0,t.width,t.height)}(t.image),n=o.index.array.slice(3*e.faceOffset,3*e.faceOffset+3*e.faceNum);(function(e,t,a){var n=e.width,o=e.height;if(e.data.length/(n*o)!=4)return!1;for(var i=0;i<a.length;i+=3){for(var s={x:0,y:0},u=0;u<3;u++){var l=a[3*i+u],p={x:t[2*l+0],y:t[2*l+1]};if(r(e,p)<253)return!0;s.x+=p.x,s.y+=p.y}if(s.x/=3,s.y/=3,r(e,s)<253)return!0}return!1})(a,o.attributes.uv.array,n)&&(e.transparent=!0),delete e.faceOffset,delete e.faceNum})}g.faceOffset=C.faceOffset,g.faceNum=C.faceNum,g.map=m(C.map,u),B(g)}if(void 0!==C.envMap&&(g.envMap=m(C.envMap,u),g.combine=C.envMapType),g.opacity=C.opacity,g.color=C.color,void 0!==C.emissive&&(g.emissive=C.emissive),g.specular=C.specular,g.shininess=Math.max(C.shininess,1e-4),"pmd"===e.metadata.format){g.outlineParameters={thickness:1===b.edgeFlag?.003:0,color:new THREE.Color(0,0,0),alpha:1},0===g.outlineParameters.thickness&&(g.outlineParameters.visible=!1);var k=f(I=-1===b.toonIndex?"toon00.bmp":e.toonTextures[b.toonIndex].fileName,{isToonTexture:!0,defaultTexturePath:(s=I,10===s.length&&null!==s.match(/toon(10|0[0-9]).bmp/))});g.gradientMap=m(k,u)}else{var I,D;if(g.outlineParameters={thickness:b.edgeSize/300,color:new THREE.Color(b.edgeColor[0],b.edgeColor[1],b.edgeColor[2]),alpha:b.edgeColor[3]},0!=(16&b.flag)&&0!==g.outlineParameters.thickness||(g.outlineParameters.visible=!1),-1===b.toonIndex||0!==b.toonFlag){var w=b.toonIndex+1;I="toon"+(w<10?"0"+w:w)+".bmp",D=!0}else I=e.textures[b.toonIndex],D=!1;k=f(I,{isToonTexture:!0,defaultTexturePath:D}),g.gradientMap=m(k,u)}i.push(g)}if("pmx"===e.metadata.format){function L(e,t){if(8===e.type)for(var r=0;r<t.length;r++){var a=t[r];if(-1!==a.index){var n=i[a.index];n.opacity!==a.diffuse[3]&&(n.transparent=!0)}}}for(E=0;E<e.morphs.length;E++){var P=e.morphs[E],Q=P.elements;if(0===P.type)for(R=0;R<Q.length;R++){var S=e.morphs[Q[R].index];L(S,S.elements)}else L(P,Q)}}}(),function(){for(var t=[],r=[],a=0;a<e.metadata.rigidBodyCount;a++){for(var n=e.rigidBodies[a],i=Object.keys(n),s={},u=0;u<i.length;u++)s[h=i[u]]=n[h];if("pmx"===e.metadata.format&&-1!==s.boneIndex){var l=e.bones[s.boneIndex];s.position[0]-=l.position[0],s.position[1]-=l.position[1],s.position[2]-=l.position[2]}t.push(s)}for(a=0;a<e.metadata.constraintCount;a++){var p=e.constraints[a];for(i=Object.keys(p),s={},u=0;u<i.length;u++){var h;s[h=i[u]]=p[h]}var d=t[s.rigidBodyIndex1],c=t[s.rigidBodyIndex2];0!==d.type&&2===c.type&&-1!==d.boneIndex&&-1!==c.boneIndex&&e.bones[c.boneIndex].parentIndex===d.boneIndex&&(c.type=1),r.push(s)}o.rigidBodies=t,o.constraints=r}(),o.setIndex(s.indices),o.addAttribute("position",new THREE.Float32BufferAttribute(s.vertices,3)),o.addAttribute("normal",new THREE.Float32BufferAttribute(s.normals,3)),o.addAttribute("uv",new THREE.Float32BufferAttribute(s.uvs,2)),o.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(s.skinIndices,4)),o.addAttribute("skinWeight",new THREE.Float32BufferAttribute(s.skinWeights,4)),o.computeBoundingSphere(),o.mmdFormat=e.metadata.format,new THREE.SkinnedMesh(o,i)},THREE.MMDLoader.prototype.createAnimation=function(e,t,r){var a=new THREE.MMDLoader.DataCreationHelper;!function(){if(0!==t.metadata.motionCount){for(var n=e.geometry.bones,o=a.createOrderedMotionArrays(n,t.motions,"boneName"),i=[],s=function(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)},u=0;u<o.length;u++){for(var l=[],p=[],h=[],d=[],c=[],A=n[u],f=o[u],m=0;m<f.length;m++){var E=f[m].frameNum/30,g=f[m].position,M=f[m].rotation,y=f[m].interpolation;l.push(E);for(var T=0;T<3;T++)p.push(A.pos[T]+g[T]);for(T=0;T<4;T++)h.push(M[T]);for(T=0;T<3;T++)s(d,y,T);s(c,y,3)}if(0!==l.length){var v=".bones["+A.name+"]";i.push(new THREE.MMDLoader.VectorKeyframeTrackEx(v+".position",l,p,d)),i.push(new THREE.MMDLoader.QuaternionKeyframeTrackEx(v+".quaternion",l,h,c))}}var R=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r,-1,i);void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(R)}}(),function(){if(0!==t.metadata.morphCount){for(var n=a.createOrderedMotionArrays(e.geometry.morphTargets,t.morphs,"morphName"),o=[],i=0;i<n.length;i++){for(var s=[],u=[],l=n[i],p=0;p<l.length;p++)s.push(l[p].frameNum/30),u.push(l[p].weight);0!==s.length&&o.push(new THREE.NumberKeyframeTrack(".morphTargetInfluences["+i+"]",s,u))}var h=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r+"Morph",-1,o);void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(h)}}()},THREE.MMDLoader.DataCreationHelper=function(){},THREE.MMDLoader.DataCreationHelper.prototype={constructor:THREE.MMDLoader.DataCreationHelper,toCharcodeStrings:function(e){for(var t="",r=0;r<e.length;r++)t+="0x"+("0000"+e[r].charCodeAt().toString(16)).substr(-4);return t},createDictionary:function(e){for(var t={},r=0;r<e.length;r++)t[e[r].name]=r;return t},initializeMotionArrays:function(e){for(var t=[],r=0;r<e.length;r++)t[r]=[];return t},sortMotionArray:function(e){e.sort(function(e,t){return e.frameNum-t.frameNum})},sortMotionArrays:function(e){for(var t=0;t<e.length;t++)this.sortMotionArray(e[t])},createMotionArray:function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t},createMotionArrays:function(e,t,r,a){for(var n=0;n<e.length;n++){var o=e[n],i=r[o[a]];void 0!==i&&t[i].push(o)}},createOrderedMotionArray:function(e){var t=this.createMotionArray(e);return this.sortMotionArray(t),t},createOrderedMotionArrays:function(e,t,r){var a=this.createDictionary(e),n=this.initializeMotionArrays(e);return this.createMotionArrays(t,n,a,r),this.sortMotionArrays(n),n}},THREE.MMDLoader.VectorKeyframeTrackEx=function(e,t,r,a){this.interpolationParameters=new Float32Array(a),THREE.VectorKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.VectorKeyframeTrackEx.prototype=Object.create(THREE.VectorKeyframeTrack.prototype),THREE.MMDLoader.VectorKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.VectorKeyframeTrackEx,THREE.MMDLoader.VectorKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.VectorKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.VectorKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.QuaternionKeyframeTrackEx=function(e,t,r,a){this.interpolationParameters=new Float32Array(a),THREE.QuaternionKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype=Object.create(THREE.QuaternionKeyframeTrack.prototype),THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.QuaternionKeyframeTrackEx,THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.NumberKeyframeTrackEx=function(e,t,r,a){this.interpolationParameters=new Float32Array(a),THREE.NumberKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.NumberKeyframeTrackEx.prototype=Object.create(THREE.NumberKeyframeTrack.prototype),THREE.MMDLoader.NumberKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.NumberKeyframeTrackEx,THREE.MMDLoader.NumberKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.NumberKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.NumberKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.CubicBezierInterpolation=function(e,t,r,a,n){THREE.Interpolant.call(this,e,t,r,a),this.params=n},THREE.MMDLoader.CubicBezierInterpolation.prototype=Object.create(THREE.LinearInterpolant.prototype),THREE.MMDLoader.CubicBezierInterpolation.prototype.constructor=THREE.MMDLoader.CubicBezierInterpolation,THREE.MMDLoader.CubicBezierInterpolation.prototype.interpolate_=function(e,t,r,a){var n=this.resultBuffer,o=this.sampleValues,i=this.valueSize,s=e*i,u=s-i,l=(r-t)/(a-t);if(4===i){var p=this.params[4*e+0],h=this.params[4*e+1],d=this.params[4*e+2],c=this.params[4*e+3],A=this._calculate(p,h,d,c,l);THREE.Quaternion.slerpFlat(n,0,o,u,o,s,A)}else if(3===i)for(var f=0;f!==i;++f){p=this.params[12*e+4*f+0],h=this.params[12*e+4*f+1],d=this.params[12*e+4*f+2],c=this.params[12*e+4*f+3],A=this._calculate(p,h,d,c,l);n[f]=o[u+f]*(1-A)+o[s+f]*A}else{p=this.params[4*e+0],h=this.params[4*e+1],d=this.params[4*e+2],c=this.params[4*e+3],A=this._calculate(p,h,d,c,l);n[0]=o[u]*(1-A)+o[s]*A}return n},THREE.MMDLoader.CubicBezierInterpolation.prototype._calculate=function(e,t,r,a,n){for(var o,i,s,u=.5,l=u,p=1-l,h=Math,d=0;d<15;d++){var c=(o=3*p*p*l)*e+(i=3*p*l*l)*t+(s=l*l*l)-n;if(h.abs(c)<1e-5)break;u/=2,p=1-(l+=c<0?u:-u)}return o*r+i*a+s},THREE.MMDAudioManager=function(e,t,r){var a=null===r||void 0===r?{}:r;this.audio=e,this.listener=t,this.elapsedTime=0,this.currentTime=0,this.delayTime=void 0!==a.delayTime?a.delayTime:0,this.audioDuration=this.audio.buffer.duration,this.duration=this.audioDuration+this.delayTime},THREE.MMDAudioManager.prototype={constructor:THREE.MMDAudioManager,control:function(e){this.elapsed+=e,this.currentTime+=e,this.checkIfStopAudio()&&this.audio.stop(),this.checkIfStartAudio()&&this.audio.play()},checkIfStartAudio:function(){if(this.audio.isPlaying)return!1;for(;this.currentTime>=this.duration;)this.currentTime-=this.duration;return!(this.currentTime<this.delayTime)&&(this.audio.startTime=this.currentTime-this.delayTime,!0)},checkIfStopAudio:function(){return!!this.audio.isPlaying&&this.currentTime>=this.duration}},THREE.MMDGrantSolver=function(e){this.mesh=e},THREE.MMDGrantSolver.prototype={constructor:THREE.MMDGrantSolver,update:function(){var e=new THREE.Quaternion;return function(){for(var t=0;t<this.mesh.geometry.grants.length;t++){var r=this.mesh.geometry.grants[t],a=this.mesh.skeleton.bones[r.index],n=this.mesh.skeleton.bones[r.parentIndex];r.isLocal?(r.affectPosition,r.affectRotation):(r.affectPosition,r.affectRotation&&(e.set(0,0,0,1),e.slerp(n.quaternion,r.ratio),a.quaternion.multiply(e)))}}}()},THREE.MMDHelper=function(){this.meshes=[],this.doAnimation=!0,this.doIk=!0,this.doGrant=!0,this.doPhysics=!0,this.doCameraAnimation=!0,this.sharedPhysics=!1,this.masterPhysics=null,this.audioManager=null,this.camera=null},THREE.MMDHelper.prototype={constructor:THREE.MMDHelper,add:function(e){if(!(e instanceof THREE.SkinnedMesh))throw new Error("THREE.MMDHelper.add() accepts only THREE.SkinnedMesh instance.");void 0===e.mixer&&(e.mixer=null),void 0===e.ikSolver&&(e.ikSolver=null),void 0===e.grantSolver&&(e.grantSolver=null),void 0===e.physics&&(e.physics=null),void 0===e.looped&&(e.looped=!1),this.meshes.push(e),this.initBackupBones(e)},setAudio:function(e,t,r){this.audioManager=new THREE.MMDAudioManager(e,t,r)},setCamera:function(e){e.mixer=null,this.camera=e},setPhysicses:function(e){for(var t=0;t<this.meshes.length;t++)this.setPhysics(this.meshes[t],e)},setPhysics:function(e,t){if(void 0===(t=void 0===t?{}:Object.assign({},t)).world&&this.sharedPhysics){var r=this.getMasterPhysics();null!==r&&(t.world=r.world)}var a=void 0!==t.warmup?t.warmup:60,n=new THREE.MMDPhysics(e,t);null!==e.mixer&&void 0!==e.mixer&&!0!==t.preventAnimationWarmup&&(this.animateOneMesh(0,e),n.reset()),n.warmup(a),this.updateIKParametersDependingOnPhysicsEnabled(e,!0),e.physics=n},getMasterPhysics:function(){if(null!==this.masterPhysics)return this.masterPhysics;for(var e=0,t=this.meshes.length;e<t;e++){var r=this.meshes[e].physics;if(void 0!==r&&null!==r)return this.masterPhysics=r,this.masterPhysics}return null},enablePhysics:function(e){this.doPhysics=!0===e;for(var t=0,r=this.meshes.length;t<r;t++)this.updateIKParametersDependingOnPhysicsEnabled(this.meshes[t],e)},updateIKParametersDependingOnPhysicsEnabled:function(e,t){for(var r=e.geometry.iks,a=e.geometry.bones,n=0,o=r.length;n<o;n++)for(var i=r[n].links,s=0,u=i.length;s<u;s++){var l=i[s];l.enabled=!0!==t||!(a[l.index].rigidBodyType>0)}},setAnimations:function(){for(var e=0;e<this.meshes.length;e++)this.setAnimation(this.meshes[e])},setAnimation:function(e){if(void 0!==e.geometry.animations){e.mixer=new THREE.AnimationMixer(e),e.mixer.addEventListener("loop",function(e){e.action._clip.tracks.length>0&&0!==e.action._clip.tracks[0].name.indexOf(".bones")||(e.target._root.looped=!0)});for(var t=!1,r=!1,a=0;a<e.geometry.animations.length;a++){var n=e.geometry.animations[a],o=e.mixer.clipAction(n);n.tracks.length>0&&0===n.tracks[0].name.indexOf(".morphTargetInfluences")?r||(o.play(),r=!0):t||(o.play(),t=!0)}t&&(e.ikSolver=new THREE.CCDIKSolver(e),void 0!==e.geometry.grants&&(e.grantSolver=new THREE.MMDGrantSolver(e)))}},setCameraAnimation:function(e){void 0!==e.animations&&(e.mixer=new THREE.AnimationMixer(e),e.mixer.clipAction(e.animations[0]).play())},unifyAnimationDuration:function(e){e=void 0===e?{}:e;for(var t=0,r=this.camera,a=this.audioManager,n=0;n<this.meshes.length;n++){if(null!==(s=this.meshes[n].mixer))for(var o=0;o<s._actions.length;o++){var i=s._actions[o];t=Math.max(t,i._clip.duration)}}if(null!==r&&null!==r.mixer){var s=r.mixer;for(n=0;n<s._actions.length;n++){i=s._actions[n];t=Math.max(t,i._clip.duration)}}null!==a&&(t=Math.max(t,a.duration)),void 0!==e.afterglow&&(t+=e.afterglow);for(n=0;n<this.meshes.length;n++){if(null!==(s=this.meshes[n].mixer))for(o=0;o<s._actions.length;o++){(i=s._actions[o])._clip.duration=t}}if(null!==r&&null!==r.mixer)for(s=r.mixer,n=0;n<s._actions.length;n++){(i=s._actions[n])._clip.duration=t}null!==a&&(a.duration=t)},controlAudio:function(e){null!==this.audioManager&&this.audioManager.control(e)},animate:function(e){this.controlAudio(e);for(var t=0;t<this.meshes.length;t++)this.animateOneMesh(e,this.meshes[t]);this.sharedPhysics&&this.updateSharedPhysics(e),this.animateCamera(e)},animateOneMesh:function(e,t){var r=t.mixer,a=t.ikSolver,n=t.grantSolver,o=t.physics;null!==r&&!0===this.doAnimation&&(this.restoreBones(t),r.update(e),this.backupBones(t)),null!==a&&!0===this.doIk&&a.update(),null!==n&&!0===this.doGrant&&n.update(),!0===t.looped&&(null!==o&&o.reset(),t.looped=!1),null!==o&&this.doPhysics&&!this.sharedPhysics&&o.update(e)},updateSharedPhysics:function(e){if(0!==this.meshes.length&&this.doPhysics&&this.sharedPhysics){var t=this.getMasterPhysics();if(null!==t){for(var r=0,a=this.meshes.length;r<a;r++){null!==(n=this.meshes[r].physics)&&void 0!==n&&n.updateRigidBodies()}t.stepSimulation(e);for(r=0,a=this.meshes.length;r<a;r++){var n;null!==(n=this.meshes[r].physics)&&void 0!==n&&n.updateBones()}}}},animateCamera:function(e){if(null!==this.camera){var t=this.camera.mixer;null!==t&&void 0!==this.camera.center&&!0===this.doCameraAnimation&&(t.update(e),this.camera.updateProjectionMatrix(),this.camera.up.set(0,1,0),this.camera.up.applyQuaternion(this.camera.quaternion),this.camera.lookAt(this.camera.center))}},poseAsVpd:function(e,t,r){void 0===r&&(r={}),!0!==r.preventResetPose&&e.pose();for(var a=e.skeleton.bones,n=t.bones,o={},i=0;i<a.length;i++)o[a[i].name]=i;var s=new THREE.Vector3,u=new THREE.Quaternion;for(i=0;i<n.length;i++){var l=n[i],p=o[l.name];if(void 0!==p){var h=a[p],d=l.translation,c=l.quaternion;s.set(d[0],d[1],d[2]),u.set(c[0],c[1],c[2],c[3]),h.position.add(s),h.quaternion.multiply(u)}}(e.updateMatrixWorld(!0),!0!==r.preventIk)&&new THREE.CCDIKSolver(e).update(r.saveOriginalBonesBeforeIK);!0!==r.preventGrant&&void 0!==e.geometry.grants&&new THREE.MMDGrantSolver(e).update()},initBackupBones:function(e){e.skeleton.backupBones=[];for(var t=0;t<e.skeleton.bones.length;t++)e.skeleton.backupBones.push(e.skeleton.bones[t].clone())},backupBones:function(e){e.skeleton.backupBoneIsSaved=!0;for(var t=0;t<e.skeleton.bones.length;t++){var r=e.skeleton.backupBones[t],a=e.skeleton.bones[t];r.position.copy(a.position),r.quaternion.copy(a.quaternion)}},restoreBones:function(e){if(!0===e.skeleton.backupBoneIsSaved){e.skeleton.backupBoneIsSaved=!1;for(var t=0;t<e.skeleton.bones.length;t++){var r=e.skeleton.bones[t],a=e.skeleton.backupBones[t];r.position.copy(a.position),r.quaternion.copy(a.quaternion)}}}};