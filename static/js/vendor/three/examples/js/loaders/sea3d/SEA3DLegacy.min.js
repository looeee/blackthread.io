"use strict";Object.assign(THREE.SEA3D.prototype,{_onHead:THREE.SEA3D.prototype.onHead,_updateTransform:THREE.SEA3D.prototype.updateTransform,_readMorph:THREE.SEA3D.prototype.readMorph,_readVertexAnimation:THREE.SEA3D.prototype.readVertexAnimation,_readGeometryBuffer:THREE.SEA3D.prototype.readGeometryBuffer,_readLine:THREE.SEA3D.prototype.readLine,_getModifier:THREE.SEA3D.prototype.getModifier,_readAnimation:THREE.SEA3D.prototype.readAnimation}),THREE.SEA3D.prototype.isLegacy=function(t){var e=t.sea3d;return"S3D"===e.sign&&e.config.legacy},THREE.SEA3D.prototype.flipVec3=function(t){if(t){for(var e=2;e<t.length;)t[e]=-t[e],e+=3;return t}},THREE.SEA3D.prototype.addVector=function(t,e){if(t){for(var i=0;i<t.length;i++)t[i]+=e[i];return t}},THREE.SEA3D.prototype.expandJoints=function(t){for(var e=4*t.numVertex,i=t.isBig?new Uint32Array(e):new Uint16Array(e),r=new Float32Array(e),n=0,o=t.jointPerVertex,a=0;a<t.numVertex;a++){var s=4*a,E=a*o;i[s]=t.joint[E],o>1&&(i[s+1]=t.joint[E+1]),o>2&&(i[s+2]=t.joint[E+2]),o>3&&(i[s+3]=t.joint[E+3]),r[s]=t.weight[E],o>1&&(r[s+1]=t.weight[E+1]),o>2&&(r[s+2]=t.weight[E+2]),o>3&&(r[s+3]=t.weight[E+3]),n=r[s]+r[s+1]+r[s+2]+r[s+3],r[s]+=1-n}t.joint=i,t.weight=r,t.jointPerVertex=4},THREE.SEA3D.prototype.compressJoints=function(t){for(var e=4*t.numVertex,i=t.isBig?new Uint32Array(e):new Uint16Array(e),r=new Float32Array(e),n=0,o=t.jointPerVertex,a=0;a<t.numVertex;a++){var s=4*a,E=a*o;i[s]=t.joint[E],i[s+1]=t.joint[E+1],i[s+2]=t.joint[E+2],i[s+3]=t.joint[E+3],r[s]=t.weight[E],r[s+1]=t.weight[E+1],r[s+2]=t.weight[E+2],r[s+3]=t.weight[E+3],n=r[s]+r[s+1]+r[s+2]+r[s+3],r[s]+=1-n}t.joint=i,t.weight=r,t.jointPerVertex=4},THREE.SEA3D.prototype.flipIndexes=function(t){for(var e=1;e<t.length;){var i=t[e+1];t[e+1]=t[e],t[e]=i,e+=3}return t},THREE.SEA3D.prototype.flipBoneMatrix=function(){var t=new THREE.Vector3;return function(e){var i=THREE.SEA3D.VECBUF.setFromMatrixPosition(e);return i.z=-i.z,e.setPosition(t),e.multiplyMatrices(THREE.SEA3D.MTXBUF.makeRotationZ(THREE.Math.degToRad(180)),e),e.setPosition(i),e}}(),THREE.SEA3D.prototype.flipScaleMatrix=function(){var t=new THREE.Vector3,e=new THREE.Quaternion,i=new THREE.Vector3;return function(r,n,o,a){return o&&r.multiplyMatrices(o,r),r.decompose(t,e,i),i.z=-i.z,r.compose(t,e,i),n&&r.multiplyMatrices(r,THREE.SEA3D.MTXBUF.makeRotationZ(THREE.Math.degToRad(180))),o&&(o=o.clone(),this.flipScaleMatrix(o,a),r.multiplyMatrices(o.getInverse(o),r)),r}}(),THREE.SEA3D.prototype.flipDefaultAnimation=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.Vector3,r=new THREE.Quaternion,n=new THREE.Vector3,o=new THREE.Vector3,a=new THREE.Quaternion,s=new THREE.Vector3;return function(E,p,c){if(!E.isFliped){for(var f=E.dataList,h=[],l=0;l<f.length;l++){var m=f[l],A=m.data,y=m.kind,d=A.length/m.blockSize;switch(y){case SEA3D.Animation.POSITION:case SEA3D.Animation.ROTATION:case SEA3D.Animation.SCALE:h.push({kind:y,numFrames:d,raw:A})}}if(h.length>0){d=h[0].numFrames;var T=void 0;c?(t.identity(),T=this.flipScaleMatrix(e.copy(p.matrixWorld))):(p.parent&&(T=this.flipScaleMatrix(e.copy(p.parent.matrixWorld))),this.flipScaleMatrix(t.copy(p.matrix),!1,T)),t.decompose(i,r,n);for(var u,R,S=0;S<d;S++){for(u=0;u<h.length;u++){A=h[u].raw;switch(y=h[u].kind){case SEA3D.Animation.POSITION:R=3*S,i.set(A[R],A[R+1],A[R+2]);break;case SEA3D.Animation.ROTATION:R=4*S,r.set(A[R],A[R+1],A[R+2],A[R+3]);break;case SEA3D.Animation.SCALE:R=4*S,n.set(A[R],A[R+1],A[R+2])}}for(t.compose(i,r,n),this.flipScaleMatrix(t,!1,e),t.decompose(o,a,s),u=0;u<h.length;u++){A=h[u].raw;switch(y=h[u].kind){case SEA3D.Animation.POSITION:A[R=3*S]=o.x,A[R+1]=o.y,A[R+2]=o.z;break;case SEA3D.Animation.ROTATION:A[R=4*S]=a.x,A[R+1]=a.y,A[R+2]=a.z,A[R+3]=a.w;break;case SEA3D.Animation.SCALE:A[R=3*S]=s.x,A[R+1]=s.y,A[R+2]=s.z}}}}E.isFliped=!0}}}(),THREE.SEA3D.prototype.readAnimation=function(t){this.isLegacy(t)||this._readAnimation(t)},THREE.SEA3D.prototype.getModifier=function(t){var e=t.sea;if(this.isLegacy(e)&&!e.done)switch(e.done=!0,e.type){case SEA3D.SkeletonAnimation.prototype.type:return this.readSkeletonAnimationLegacy(e,t.skeleton),e.tag;case SEA3D.Animation.prototype.type:case SEA3D.MorphAnimation.prototype.type:case SEA3D.UVWAnimation.prototype.type:return t.scope instanceof THREE.Object3D&&this.flipDefaultAnimation(e,t.scope,t.relative),this._readAnimation(e),e.tag;case SEA3D.Morph.prototype.type:this.readMorphLegacy(e,t.geometry)}return this._getModifier(t)},THREE.SEA3D.prototype.updateTransform=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4;return function(i,r){this.isLegacy(r)?(r.transform?t.fromArray(r.transform):t.makeTranslation(r.position.x,r.position.y,r.position.z),this.flipScaleMatrix(t,!1,i.parent?i.parent.matrixWorld:e,i.parent instanceof THREE.Bone),i.position.setFromMatrixPosition(t),i.scale.setFromMatrixScale(t),t.scale(THREE.SEA3D.VECBUF.set(1/i.scale.x,1/i.scale.y,1/i.scale.z)),i.rotation.setFromRotationMatrix(t),i.updateMatrixWorld()):this._updateTransform(i,r)}}(),THREE.SEA3D.prototype.readSkeleton=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.Matrix4,r=new THREE.Vector3,n=new THREE.Quaternion;return function(o){for(var a=[],s=o.sea3d.config.legacy,E=0;E<o.joint.length;E++){var p=o.joint[E];t.fromArray(p.inverseBindMatrix),e.getInverse(t),s&&this.flipBoneMatrix(e),p.parentIndex>-1&&(t.fromArray(o.joint[p.parentIndex].inverseBindMatrix),i.getInverse(t),s&&this.flipBoneMatrix(i),i.getInverse(i),e.multiplyMatrices(i,e)),r.setFromMatrixPosition(e),n.setFromRotationMatrix(e),a[E]={name:p.name,pos:[r.x,r.y,r.z],rotq:[n.x,n.y,n.z,n.w],parent:p.parentIndex}}return this.domain.bones=this.bones=this.bones||[],this.bones.push(this.objects[o.name+".sklq"]=o.tag=a),a}}(),THREE.SEA3D.prototype.readSkeletonAnimationLegacy=function(){var t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.Matrix4,r=new THREE.Matrix4;return function(n,o){if(n.tag)return n.tag;for(var a=[],s=1e3/n.frameRate/1e3,E=[1,1,1],p=0;p<n.sequence.length;p++){for(var c=n.sequence[p],f=c.start,h=f+c.count,l={name:c.name,repeat:c.repeat,fps:n.frameRate,JIT:0,length:s*c.count,hierarchy:[]},m=n.numJoints,A=n.raw,y=0;y<m;y++){for(var d=o.joint[y],T={parent:d.parentIndex,keys:[]},u=T.keys,R=0,S=f;S<h;S++){var x=S*m*7+7*y;e.makeRotationFromQuaternion(THREE.SEA3D.QUABUF.set(A[x+3],A[x+4],A[x+5],A[x+6])),e.setPosition(THREE.SEA3D.VECBUF.set(A[x],A[x+1],A[x+2])),d.parentIndex>-1?(t.fromArray(o.joint[d.parentIndex].inverseBindMatrix),r.getInverse(t),i.multiplyMatrices(r,e),this.flipBoneMatrix(i),this.flipBoneMatrix(r),r.getInverse(r),e.multiplyMatrices(r,i)):this.flipBoneMatrix(e);var g=THREE.SEA3D.VECBUF.setFromMatrixPosition(e),H=THREE.SEA3D.QUABUF.setFromRotationMatrix(e);u.push({time:R,pos:[g.x,g.y,g.z],rot:[H.x,H.y,H.z,H.w],scl:E}),R+=s}l.hierarchy[y]=T}a.push(THREE.SEA3D.AnimationClip.fromClip(THREE.AnimationClip.parseAnimation(l,o.tag),c.repeat))}this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[n.name+".anm"]=n.tag=a)}}(),THREE.SEA3D.prototype.readMorphLegacy=function(t,e){for(var i=0;i<t.node.length;i++){var r=t.node[i];this.flipVec3(r.vertex),this.flipVec3(r.normal),this.addVector(r.vertex,e.vertex),this.addVector(r.normal,e.normal)}this._readMorph(t)},THREE.SEA3D.prototype.readMorph=function(t){this.isLegacy(t)||this._readMorph(t)},THREE.SEA3D.prototype.readVertexAnimation=function(t){if(this.isLegacy(t))for(var e=0,i=t.frame.length;e<i;e++){var r=t.frame[e];this.flipVec3(r.vertex),this.flipVec3(r.normal)}this._readVertexAnimation(t)},THREE.SEA3D.prototype.readGeometryBuffer=function(t){this.isLegacy(t)&&(this.flipVec3(t.vertex),this.flipVec3(t.normal),this.flipIndexes(t.indexes),t.jointPerVertex>4?this.compressJoints(t):t.jointPerVertex<4&&this.expandJoints(t)),this._readGeometryBuffer(t)},THREE.SEA3D.prototype.readLines=function(t){this.isLegacy(t)&&this.flipVec3(t.vertex),this._readLines(t)},THREE.SEA3D.prototype.onHead=function(t){if("S3D"!=t.sign&&"TJS"!=t.sign)throw new Error("Sign '"+t.sign+"' unknown.")},THREE.SEA3D.EXTENSIONS_LOADER.push({setTypeRead:function(){this.config.legacy=void 0==this.config.legacy||this.config.legacy,this.file.typeRead[SEA3D.Skeleton.prototype.type]=this.readSkeleton}});