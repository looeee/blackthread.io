"use strict";void 0===THREE.LoaderSupport&&(THREE.LoaderSupport={}),THREE.LoaderSupport.Validator={isValid:function(e){return null!==e&&void 0!==e},verifyInput:function(e,t){return null===e||void 0===e?t:e}},THREE.LoaderSupport.ConsoleLogger=function(){function e(e,t){this.enabled=!1!==e,this.debug=!0===t}return e.prototype.setDebug=function(e){this.debug=!0===e},e.prototype.isDebug=function(){return this.isEnabled()&&this.debug},e.prototype.setEnabled=function(e){this.enabled=!0===e},e.prototype.isEnabled=function(){return this.enabled},e.prototype.logDebug=function(e){this.enabled&&this.debug&&console.info(e)},e.prototype.logInfo=function(e){this.enabled&&console.info(e)},e.prototype.logWarn=function(e){console.warn(e)},e.prototype.logError=function(e){console.error(e)},e.prototype.logTimeStart=function(e){this.enabled&&console.time(e)},e.prototype.logTimeEnd=function(e){this.enabled&&console.timeEnd(e)},e}(),THREE.LoaderSupport.Callbacks=function(){var e=THREE.LoaderSupport.Validator;function t(){this.onProgress=null,this.onMeshAlter=null,this.onLoad=null,this.onLoadMaterials=null}return t.prototype.setCallbackOnProgress=function(t){this.onProgress=e.verifyInput(t,this.onProgress)},t.prototype.setCallbackOnMeshAlter=function(t){this.onMeshAlter=e.verifyInput(t,this.onMeshAlter)},t.prototype.setCallbackOnLoad=function(t){this.onLoad=e.verifyInput(t,this.onLoad)},t.prototype.setCallbackOnLoadMaterials=function(t){this.onLoadMaterials=e.verifyInput(t,this.onLoadMaterials)},t}(),THREE.LoaderSupport.LoadedMeshUserOverride=function(){function e(e,t){this.disregardMesh=!0===e,this.alteredMesh=!0===t,this.meshes=[]}return e.prototype.addMesh=function(e){this.meshes.push(e),this.alteredMesh=!0},e.prototype.isDisregardMesh=function(){return this.disregardMesh},e.prototype.providesAlteredMeshes=function(){return this.alteredMesh},e}(),THREE.LoaderSupport.ResourceDescriptor=function(){var e=THREE.LoaderSupport.Validator;function t(t,r){var o=t.split("/");o.length<2?(this.path=null,this.name=t,this.url=t):(this.path=e.verifyInput(o.slice(0,o.length-1).join("/")+"/",null),this.name=e.verifyInput(o[o.length-1],null),this.url=t),this.extension=e.verifyInput(r,"default"),this.extension=this.extension.trim(),this.content=null}return t.prototype.setContent=function(t){this.content=e.verifyInput(t,null)},t}(),THREE.LoaderSupport.PrepData=function(){var e=THREE.LoaderSupport.Validator;function t(t){this.modelName=e.verifyInput(t,""),this.resources=[],this.streamMeshesTo=null,this.materialPerSmoothingGroup=!1,this.useIndices=!1,this.disregardNormals=!1,this.callbacks=new THREE.LoaderSupport.Callbacks,this.crossOrigin,this.useAsync=!1}return t.prototype.setStreamMeshesTo=function(t){this.streamMeshesTo=e.verifyInput(t,null)},t.prototype.setMaterialPerSmoothingGroup=function(e){this.materialPerSmoothingGroup=!0===e},t.prototype.setUseIndices=function(e){this.useIndices=!0===e},t.prototype.setDisregardNormals=function(e){this.disregardNormals=!0===e},t.prototype.getCallbacks=function(){return this.callbacks},t.prototype.setCrossOrigin=function(e){this.crossOrigin=e},t.prototype.addResource=function(e){this.resources.push(e)},t.prototype.setUseAsync=function(e){this.useAsync=!0===e},t.prototype.clone=function(){var e=new THREE.LoaderSupport.PrepData(this.modelName);return e.resources=this.resources,e.streamMeshesTo=this.streamMeshesTo,e.materialPerSmoothingGroup=this.materialPerSmoothingGroup,e.useIndices=this.useIndices,e.disregardNormals=this.disregardNormals,e.callbacks=this.callbacks,e.crossOrigin=this.crossOrigin,e.useAsync=this.useAsync,e},t}(),THREE.LoaderSupport.Builder=function(){var e="1.1.1",t=THREE.LoaderSupport.Validator,r=THREE.LoaderSupport.ConsoleLogger;function o(o){this.logger=t.verifyInput(o,new r),this.logger.logInfo("Using THREE.LoaderSupport.Builder version: "+e),this.callbacks=new THREE.LoaderSupport.Callbacks,this.materials=[]}return o.prototype.setMaterials=function(e){var r={cmd:"materialData",materials:{materialCloneInstructions:null,serializedMaterials:null,runtimeMaterials:t.isValid(this.callbacks.onLoadMaterials)?this.callbacks.onLoadMaterials(e):e}};this.updateMaterials(r)},o.prototype._setCallbacks=function(e){t.isValid(e.onProgress)&&this.callbacks.setCallbackOnProgress(e.onProgress),t.isValid(e.onMeshAlter)&&this.callbacks.setCallbackOnMeshAlter(e.onMeshAlter),t.isValid(e.onLoad)&&this.callbacks.setCallbackOnLoad(e.onLoad),t.isValid(e.onLoadMaterials)&&this.callbacks.setCallbackOnLoadMaterials(e.onLoadMaterials)},o.prototype.processPayload=function(e){return"meshData"===e.cmd?this.buildMeshes(e):"materialData"===e.cmd?(this.updateMaterials(e),null):void 0},o.prototype.buildMeshes=function(e){var r,o,s,i=e.params.meshName,n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e.buffers.vertices),3)),t.isValid(e.buffers.indices)&&n.setIndex(new THREE.BufferAttribute(new Uint32Array(e.buffers.indices),1)),t.isValid(e.buffers.colors)&&n.addAttribute("color",new THREE.BufferAttribute(new Float32Array(e.buffers.colors),3)),t.isValid(e.buffers.normals)?n.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(e.buffers.normals),3)):n.computeVertexNormals(),t.isValid(e.buffers.uvs)&&n.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.buffers.uvs),2));var a=e.materials.materialNames,l=e.materials.multiMaterial,u=[];for(s in a)o=a[s],r=this.materials[o],l&&u.push(r);if(l){r=u;var p,c=e.materials.materialGroups;for(s in c)p=c[s],n.addGroup(p.start,p.count,p.index)}var d,h,g,f=[],m=this.callbacks.onMeshAlter,b=!0;if(t.isValid(m)&&(h=m({detail:{meshName:i,bufferGeometry:n,material:r}}),t.isValid(h))){if(!h.isDisregardMesh()&&h.providesAlteredMeshes())for(var k in h.meshes)f.push(h.meshes[k]);b=!1}if(b&&((d=new THREE.Mesh(n,r)).name=i,f.push(d)),t.isValid(f)&&f.length>0){var y=[];for(var k in f)d=f[k],y[k]=d.name;g="Adding mesh(es) ("+y.length+": "+y+") from input mesh: "+i,g+=" ("+(100*e.progress.numericalValue).toFixed(2)+"%)"}else g="Not adding mesh: "+i,g+=" ("+(100*e.progress.numericalValue).toFixed(2)+"%)";var E=this.callbacks.onProgress;t.isValid(E)&&E(new CustomEvent("BuilderEvent",{detail:{type:"progress",modelName:e.params.meshName,text:g,numericalValue:e.progress.numericalValue}}));return f},o.prototype.updateMaterials=function(e){var r,o,s=e.materials.materialCloneInstructions;if(t.isValid(s)){var i=s.materialNameOrg;r=this.materials[i].clone(),o=s.materialName,r.name=o;var n=s.materialProperties;for(var a in n)r.hasOwnProperty(a)&&n.hasOwnProperty(a)&&(r[a]=n[a]);this.materials[o]=r}var l=e.materials.serializedMaterials;if(t.isValid(l)&&Object.keys(l).length>0){var u,p=new THREE.MaterialLoader;for(o in l)u=l[o],t.isValid(u)&&(r=p.parse(u),this.logger.logInfo('De-serialized material with name "'+o+'" will be added.'),this.materials[o]=r)}if(l=e.materials.runtimeMaterials,t.isValid(l)&&Object.keys(l).length>0)for(o in l)r=l[o],this.logger.logInfo('Material with name "'+o+'" will be added.'),this.materials[o]=r},o.prototype.getMaterialsJSON=function(){var e,t={};for(var r in this.materials)e=this.materials[r],t[r]=e.toJSON();return t},o.prototype.getMaterials=function(){return this.materials},o}(),THREE.LoaderSupport.LoaderBase=function(){var e=THREE.LoaderSupport.Validator,t=THREE.LoaderSupport.ConsoleLogger;function r(r,o){this.manager=e.verifyInput(r,THREE.DefaultLoadingManager),this.logger=e.verifyInput(o,new t),this.modelName="",this.instanceNo=0,this.path="",this.useIndices=!1,this.disregardNormals=!1,this.loaderRootNode=new THREE.Group,this.builder=new THREE.LoaderSupport.Builder(this.logger),this._createDefaultMaterials(),this.callbacks=new THREE.LoaderSupport.Callbacks}return r.prototype._createDefaultMaterials=function(){var e=new THREE.MeshStandardMaterial({color:14479871});e.name="defaultMaterial";var t=new THREE.MeshStandardMaterial({color:14479871});t.name="vertexColorMaterial",t.vertexColors=THREE.VertexColors;var r={};r[e.name]=e,r[t.name]=t,this.builder.updateMaterials({cmd:"materialData",materials:{materialCloneInstructions:null,serializedMaterials:null,runtimeMaterials:r}})},r.prototype._applyPrepData=function(t){e.isValid(t)&&(this.setModelName(t.modelName),this.setStreamMeshesTo(t.streamMeshesTo),this.builder.setMaterials(t.materials),this.setUseIndices(t.useIndices),this.setDisregardNormals(t.disregardNormals),this._setCallbacks(t.getCallbacks()))},r.prototype._setCallbacks=function(t){e.isValid(t.onProgress)&&this.callbacks.setCallbackOnProgress(t.onProgress),e.isValid(t.onMeshAlter)&&this.callbacks.setCallbackOnMeshAlter(t.onMeshAlter),e.isValid(t.onLoad)&&this.callbacks.setCallbackOnLoad(t.onLoad),e.isValid(t.onLoadMaterials)&&this.callbacks.setCallbackOnLoadMaterials(t.onLoadMaterials),this.builder._setCallbacks(this.callbacks)},r.prototype.getLogger=function(){return this.logger},r.prototype.setModelName=function(t){this.modelName=e.verifyInput(t,this.modelName)},r.prototype.setPath=function(t){this.path=e.verifyInput(t,this.path)},r.prototype.setStreamMeshesTo=function(t){this.loaderRootNode=e.verifyInput(t,this.loaderRootNode)},r.prototype.setMaterials=function(e){this.builder.setMaterials(e)},r.prototype.setUseIndices=function(e){this.useIndices=!0===e},r.prototype.setDisregardNormals=function(e){this.disregardNormals=!0===e},r.prototype.onProgress=function(t,r,o){var s=e.isValid(r)?r:"",i={detail:{type:t,modelName:this.modelName,instanceNo:this.instanceNo,text:s,numericalValue:o}};e.isValid(this.callbacks.onProgress)&&this.callbacks.onProgress(i),this.logger.logDebug(s)},r}(),THREE.LoaderSupport.WorkerRunnerRefImpl=function(){function e(){var e=this;self.addEventListener("message",function(t){e.processMessage(t.data)},!1)}return e.prototype.applyProperties=function(e,t){var r,o,s;for(r in t)o="set"+r.substring(0,1).toLocaleUpperCase()+r.substring(1),s=t[r],"function"==typeof e[o]?e[o](s):e.hasOwnProperty(r)&&(e[r]=s)},e.prototype.processMessage=function(e){var t=e.logger.enabled,r=e.logger.enabled;if("run"===e.cmd){var o={callbackBuilder:function(e){self.postMessage(e)},callbackProgress:function(e){t&&r&&console.debug("WorkerRunner: progress: "+e)}},s=new Parser;"function"==typeof s.setLogConfig&&s.setLogConfig(t,r),this.applyProperties(s,e.params),this.applyProperties(s,e.materials),this.applyProperties(s,o),s.workerScope=self,s.parse(e.data.input,e.data.options),t&&console.log("WorkerRunner: Run complete!"),o.callbackBuilder({cmd:"complete",msg:"WorkerRunner completed run."})}else console.error("WorkerRunner: Received unknown command: "+e.cmd)},e}(),THREE.LoaderSupport.WorkerSupport=function(){var e="2.0.1",t=THREE.LoaderSupport.Validator,r=function(){function e(e){this.logger=t.verifyInput(e,new THREE.LoaderSupport.ConsoleLogger),this._reset()}return e.prototype._reset=function(){this.worker=null,this.runnerImplName=null,this.callbacks={builder:null,onLoad:null},this.terminateRequested=!1,this.queuedMessage=null,this.started=!1},e.prototype.initWorker=function(e,t){this.runnerImplName=t;var r=new Blob([e],{type:"application/javascript"});this.worker=new Worker(window.URL.createObjectURL(r)),this.worker.onmessage=this._receiveWorkerMessage,this.worker.runtimeRef=this,this._postMessage()},e.prototype._receiveWorkerMessage=function(e){var t=e.data;switch(t.cmd){case"meshData":case"materialData":case"imageData":this.runtimeRef.callbacks.builder(t);break;case"complete":this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(t.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logger.logInfo("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run is complete. Terminating application on request!"),this.runtimeRef._terminate());break;case"error":this.runtimeRef.logger.logError("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Reported error: "+t.msg),this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(t.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logger.logInfo("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run reported error. Terminating application on request!"),this.runtimeRef._terminate());break;default:this.runtimeRef.logger.logError("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Received unknown command: "+t.cmd)}},e.prototype.setCallbacks=function(e,r){this.callbacks.builder=t.verifyInput(e,this.callbacks.builder),this.callbacks.onLoad=t.verifyInput(r,this.callbacks.onLoad)},e.prototype.run=function(e){if(t.isValid(this.queuedMessage))console.warn("Already processing message. Rejecting new run instruction");else{if(this.queuedMessage=e,this.started=!0,!t.isValid(this.callbacks.builder))throw'Unable to run as no "builder" callback is set.';if(!t.isValid(this.callbacks.onLoad))throw'Unable to run as no "onLoad" callback is set.';"run"!==e.cmd&&(e.cmd="run"),t.isValid(e.logger)?(e.logger.enabled=t.verifyInput(e.logger.enabled,!0),e.logger.debug=t.verifyInput(e.logger.debug,!1)):e.logger={enabled:!0,debug:!1},this._postMessage()}},e.prototype._postMessage=function(){t.isValid(this.queuedMessage)&&t.isValid(this.worker)&&(this.queuedMessage.data.input instanceof ArrayBuffer?this.worker.postMessage(this.queuedMessage,[this.queuedMessage.data.input]):this.worker.postMessage(this.queuedMessage))},e.prototype.setTerminateRequested=function(e){this.terminateRequested=!0===e,this.terminateRequested&&t.isValid(this.worker)&&!t.isValid(this.queuedMessage)&&this.started&&(this.logger.logInfo("Worker is terminated immediately as it is not running!"),this._terminate())},e.prototype._terminate=function(){this.worker.terminate(),this._reset()},e}();function o(o){if(this.logger=t.verifyInput(o,new THREE.LoaderSupport.ConsoleLogger),this.logger.logInfo("Using THREE.LoaderSupport.WorkerSupport version: "+e),void 0===window.Worker)throw"This browser does not support web workers!";if(void 0===window.Blob)throw"This browser does not support Blob!";if("function"!=typeof window.URL.createObjectURL)throw"This browser does not support Object creation from URL!";this.loaderWorker=new r(this.logger)}o.prototype.validate=function(e,r,o,n){if(!t.isValid(this.loaderWorker.worker)){this.logger.logInfo("WorkerSupport: Building worker code..."),this.logger.logTimeStart("buildWebWorkerCode"),t.isValid(n)?this.logger.logInfo('WorkerSupport: Using "'+n.name+'" as Runncer class for worker.'):(n=THREE.LoaderSupport.WorkerRunnerRefImpl,this.logger.logInfo('WorkerSupport: Using DEFAULT "THREE.LoaderSupport.WorkerRunnerRefImpl" as Runncer class for worker.'));var a=e(s,i);a+=i(n.name,n.name,n),a+="new "+n.name+"();\n\n";var l=this;if(t.isValid(r)&&r.length>0){var u="",p=function(e,t){if(0===t.length)l.loaderWorker.initWorker(u+a,l.logger,n.name),l.logger.logTimeEnd("buildWebWorkerCode");else{var r=new THREE.FileLoader;r.setPath(e),r.setResponseType("text"),r.load(t[0],function(r){u+=r,p(e,t)}),t.shift()}};p(o,r)}else this.loaderWorker.initWorker(a,this.logger,n.name),this.logger.logTimeEnd("buildWebWorkerCode")}},o.prototype.setCallbacks=function(e,t){this.loaderWorker.setCallbacks(e,t)},o.prototype.run=function(e){this.loaderWorker.run(e)},o.prototype.setTerminateRequested=function(e){this.loaderWorker.setTerminateRequested(e)};var s=function(e,t){var r,o=e+" = {\n";for(var s in t)"string"==typeof(r=t[s])||r instanceof String?o+="\t"+s+': "'+(r=(r=r.replace("\n","\\n")).replace("\r","\\r"))+'",\n':r instanceof Array?o+="\t"+s+": ["+r+"],\n":Number.isInteger(r)?o+="\t"+s+": "+r+",\n":"function"==typeof r&&(o+="\t"+s+": "+r+",\n");return o+="}\n\n"},i=function(e,t,r){var o,s=e+" = (function () {\n\n";for(var i in s=(s+="\t"+r.prototype.constructor.toString()+"\n\n").replace(r.name,t),r.prototype)"function"==typeof(o=r.prototype[i])&&(s+="\t"+t+".prototype."+i+" = "+o.toString()+";\n\n");return s+="\treturn "+t+";\n",s+="})();\n\n"};return o}(),THREE.LoaderSupport.WorkerDirector=function(){var e="2.1.0",t=THREE.LoaderSupport.Validator,r=16,o=8192;function s(s,i){if(this.logger=t.verifyInput(i,new THREE.LoaderSupport.ConsoleLogger),this.logger.logInfo("Using THREE.LoaderSupport.WorkerDirector version: "+e),this.maxQueueSize=o,this.maxWebWorkers=r,this.crossOrigin=null,!t.isValid(s))throw"Provided invalid classDef: "+s;this.workerDescription={classDef:s,globalCallbacks:{},workerSupports:{}},this.objectsCompleted=0,this.instructionQueue=[],this.instructionQueuePointer=0,this.callbackOnFinishedProcessing=null}return s.prototype.getMaxQueueSize=function(){return this.maxQueueSize},s.prototype.getMaxWebWorkers=function(){return this.maxWebWorkers},s.prototype.setCrossOrigin=function(e){this.crossOrigin=e},s.prototype.prepareWorkers=function(e,s,i){t.isValid(e)&&(this.workerDescription.globalCallbacks=e),this.maxQueueSize=Math.min(s,o),this.maxWebWorkers=Math.min(i,r),this.maxWebWorkers=Math.min(this.maxWebWorkers,this.maxQueueSize),this.objectsCompleted=0,this.instructionQueue=[],this.instructionQueuePointer=0;for(var n=0;n<this.maxWebWorkers;n++)this.workerDescription.workerSupports[n]={instanceNo:n,inUse:!1,terminateRequested:!1,workerSupport:new THREE.LoaderSupport.WorkerSupport(this.logger),loader:null}},s.prototype.enqueueForRun=function(e){this.instructionQueue.length<this.maxQueueSize&&this.instructionQueue.push(e)},s.prototype.isRunning=function(){var e=Object.keys(this.workerDescription.workerSupports);return this.instructionQueue.length>0&&this.instructionQueuePointer<this.instructionQueue.length||e.length>0},s.prototype.processQueue=function(){var e,t;for(var r in this.workerDescription.workerSupports)(t=this.workerDescription.workerSupports[r]).inUse||(this.instructionQueuePointer<this.instructionQueue.length?(e=this.instructionQueue[this.instructionQueuePointer],this._kickWorkerRun(e,t),this.instructionQueuePointer++):this._deregister(t));this.isRunning()||null===this.callbackOnFinishedProcessing||(this.callbackOnFinishedProcessing(),this.callbackOnFinishedProcessing=null)},s.prototype._kickWorkerRun=function(e,r){r.inUse=!0,r.workerSupport.setTerminateRequested(r.terminateRequested),this.logger.logInfo("\nAssigning next item from queue to worker (queue length: "+this.instructionQueue.length+")\n\n");var o=this,s=e.getCallbacks(),i=this.workerDescription.globalCallbacks;r.loader=this._buildLoader(r.instanceNo);var n=new THREE.LoaderSupport.Callbacks;n.setCallbackOnLoad(function(e){t.isValid(i.onLoad)&&i.onLoad(e),t.isValid(s.onLoad)&&s.onLoad(e),o.objectsCompleted++,r.inUse=!1,o.processQueue()}),n.setCallbackOnProgress(function(e){t.isValid(i.onProgress)&&i.onProgress(e),t.isValid(s.onProgress)&&s.onProgress(e)}),n.setCallbackOnMeshAlter(function(e){t.isValid(i.onMeshAlter)&&i.onMeshAlter(e),t.isValid(s.onMeshAlter)&&s.onMeshAlter(e)}),e.callbacks=n,r.loader.run(e,r.workerSupport)},s.prototype._buildLoader=function(e){var r=this.workerDescription.classDef,o=Object.create(r.prototype);if(this.workerDescription.classDef.call(o,THREE.DefaultLoadingManager,this.logger),!o.hasOwnProperty("instanceNo"))throw r.name+' has no property "instanceNo".';if(o.instanceNo=e,!o.hasOwnProperty("workerSupport"))throw r.name+' has no property "workerSupport".';if("function"!=typeof o.run)throw r.name+' has no function "run".';return o.hasOwnProperty("callbacks")&&t.isValid(o.callbacks)||(this.logger.logWarn(r.name+' has an invalid property "callbacks". Will change to "THREE.LoaderSupport.Callbacks"'),o.callbacks=new THREE.LoaderSupport.Callbacks),o},s.prototype._deregister=function(e){if(t.isValid(e)){e.workerSupport.setTerminateRequested(!0),this.logger.logInfo("Requested termination of worker #"+e.instanceNo+".");var r=e.loader.callbacks;t.isValid(r.onProgress)&&r.onProgress({detail:{text:""}}),delete this.workerDescription.workerSupports[e.instanceNo]}},s.prototype.tearDown=function(e){for(var r in this.logger.logInfo("WorkerDirector received the deregister call. Terminating all workers!"),this.instructionQueuePointer=this.instructionQueue.length,this.callbackOnFinishedProcessing=t.verifyInput(e,null),this.workerDescription.workerSupports)this.workerDescription.workerSupports[r].terminateRequested=!0},s}();