!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.THREE=e.THREE||{},e.THREE.XLoader=t())}(this,function(){"use strict";var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),r=function t(){e(this,t),this.animeName="",this.boneName="",this.targetBone=null,this.keyType=4,this.frameStartLv=0,this.keyFrames=[],this.InverseMx=null},a=function(){function r(t){e(this,r),this.fps=30,this.name="xanimation",this.length=0,this.hierarchy=[],this.putFlags=t,void 0===this.putFlags.putPos&&(this.putFlags.putPos=!0),void 0===this.putFlags.putRot&&(this.putFlags.putRot=!0),void 0===this.putFlags.putScl&&(this.putFlags.putScl=!0)}return t(r,[{key:"make",value:function(e){for(var t=0;t<e.length;t++)this.hierarchy.push(this.makeBonekeys(e[t]));this.length=this.hierarchy[0].keys[this.hierarchy[0].keys.length-1].time}},{key:"clone",value:function(){return Object.assign({},this)}},{key:"makeBonekeys",value:function(e){var t={};return t.name=e.boneName,t.parent="",t.keys=this.keyFrameRefactor(e),t.copy=function(){return Object.assign({},this)},t}},{key:"keyFrameRefactor",value:function(e){for(var t=[],r=0;r<e.keyFrames.length;r++){var a={};a.time=e.keyFrames[r].time*this.fps,e.keyFrames[r].pos&&this.putFlags.putPos&&(a.pos=e.keyFrames[r].pos),e.keyFrames[r].rot&&this.putFlags.putRot&&(a.rot=e.keyFrames[r].rot),e.keyFrames[r].scl&&this.putFlags.putScl&&(a.scl=e.keyFrames[r].scl),e.keyFrames[r].matrix&&(a.matrix=e.keyFrames[r].matrix,this.putFlags.putPos&&(a.pos=(new THREE.Vector3).setFromMatrixPosition(a.matrix)),this.putFlags.putRot&&(a.rot=(new THREE.Quaternion).setFromRotationMatrix(a.matrix)),this.putFlags.putScl&&(a.scl=(new THREE.Vector3).setFromMatrixScale(a.matrix))),t.push(a)}return t}}]),r}(),s=function t(){e(this,t),this.index=0,this.Frame=0,this.time=0,this.matrix=null};return function(){function i(t,r){e(this,i),this.debug=!1,this.manager=void 0!==t?t:new THREE.DefaultLoadingManager,this.texloader=void 0!==r?r:new THREE.TextureLoader,this.url="",this.baseDir="",this._putMatLength=0,this._nowMat=null,this._tmpUvArray=[],this._facesNormal=[],this._nowFrameName="",this.frameHierarchie=[],this.Hierarchies={},this.HieStack=[],this._currentObject={},this._currentFrame={},this._data=null,this.onLoad=null,this.IsUvYReverse=!0,this.Meshes=[],this.animations=[],this.animTicksPerSecond=30,this._currentGeo=null,this._currentAnime=null,this._currentAnimeFrames=null}return t(i,[{key:"_setArgOption",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e){for(var r=t;r<e.length;r++)switch(r){case 0:this.url=e[r];break;case 1:this.options=e[r]}void 0===this.options&&(this.options={})}}},{key:"load",value:function(e,t,r,a){var s=this;this._setArgOption(e);var i=new THREE.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.load(this.url,function(e){s._parse(e,t)},r,a)}},{key:"fromResponsedData",value:function(e,t,r){this._setArgOption(t),this._parse(e,r)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(r>-1&&r<2))break;var a=-1;t=(a=e.indexOf("\r\n",t))>0?a+2:(a=e.indexOf("\r",t))>0?a+1:e.indexOf("\n",t)+1}return e.substr(t)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(r>-1&&r<2))break;var a=-1;t=(a=e.indexOf("\r\n",t))>0?a+2:(a=e.indexOf("\r",t))>0?a+1:e.indexOf("\n",t)+1}return e.substr(t)}},{key:"_isBinary",value:function(e){var t=new DataView(e);if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;for(var r=t.byteLength,a=0;a<r;a++)if(t.getUint8(a,!1)>127)return!0;return!1}},{key:"ensureBinary",value:function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t}return e}},{key:"ensureString",value:function(e){return"string"!=typeof e?THREE.LoaderUtils.decodeText(new Uint8Array(e)):e}},{key:"_parse",value:function(e,t){var r=this.ensureBinary(e);return this._data=this.ensureString(e),this.onLoad=t,this._isBinary(r)?this._parseBinary(r):this._parseASCII()}},{key:"_parseBinary",value:function(e){return this._parseASCII(THREE.LoaderUtils.decodeText(new Uint8Array(e)))}},{key:"_parseASCII",value:function(){this.url.lastIndexOf("/")>0&&(this.baseDir=this.url.substr(0,this.url.lastIndexOf("/")+1));this.Hierarchies.children=[],this._hierarchieParse(this.Hierarchies,16),this._changeRoot(),this._currentObject=this.Hierarchies.children.shift(),this.mainloop()}},{key:"_hierarchieParse",value:function(e,t){for(var r=t;;){var a=this._data.indexOf("{",r)+1,s=this._data.indexOf("}",r),i=this._data.indexOf("{",a)+1;if(!(a>0&&s>a)){r=-1===a?this._data.length:s+1;break}var n={children:[]},o=this._readLine(this._data.substr(r,a-r-1)).trim(),h=o.split(/ /g);if(h.length>0?(n.type=h[0],h.length>=2?n.name=h[1]:n.name=h[0]+this.Hierarchies.children.length):(n.name=o,n.type=""),"Animation"===n.type){n.data=this._data.substr(i,s-i).trim();var c=this._hierarchieParse(n,s+1);r=c.end,n.children=c.parent.children}else{var u=this._data.lastIndexOf(";",i>0?Math.min(i,s):s);if(n.data=this._data.substr(a,u-a).trim(),i<=0||s<i)r=s+1;else{var m=Math.max(u+1,a),l=this._hierarchieParse(n,m);r=l.end,n.children=l.parent.children}}n.parent=e,"template"!=n.type&&e.children.push(n)}return{parent:e,end:r}}},{key:"mainloop",value:function(){var e=this;this.mainProc(),this._currentObject.parent||this._currentObject.children.length>0||!this._currentObject.worked?setTimeout(function(){e.mainloop()},1):setTimeout(function(){e.onLoad({models:e.Meshes,animations:e.animations})},1)}},{key:"mainProc",value:function(){for(var e=!1;;){if(!this._currentObject.worked){switch(this._currentObject.type){case"template":break;case"AnimTicksPerSecond":this.animTicksPerSecond=parseInt(this._currentObject.data);break;case"Frame":this._setFrame();break;case"FrameTransformMatrix":this._setFrameTransformMatrix();break;case"Mesh":this._changeRoot(),this._currentGeo={},this._currentGeo.name=this._currentObject.name.trim(),this._currentGeo.parentName=this._getParentName(this._currentObject).trim(),this._currentGeo.VertexSetedBoneCount=[],this._currentGeo.Geometry=new THREE.Geometry,this._currentGeo.Materials=[],this._currentGeo.normalVectors=[],this._currentGeo.BoneInfs=[],this._currentGeo.baseFrame=this._currentFrame,this._makeBoneFrom_CurrentFrame(),this._readVertexDatas(),e=!0;break;case"MeshNormals":this._readVertexDatas();break;case"MeshTextureCoords":this._setMeshTextureCoords();break;case"VertexDuplicationIndices":break;case"MeshMaterialList":this._setMeshMaterialList();break;case"Material":this._setMaterial();break;case"SkinWeights":this._setSkinWeights();break;case"AnimationSet":this._changeRoot(),this._currentAnime={},this._currentAnime.name=this._currentObject.name.trim(),this._currentAnime.AnimeFrames=[];break;case"Animation":this._currentAnimeFrames&&this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=new r,this._currentAnimeFrames.boneName=this._currentObject.data.trim();break;case"AnimationKey":this._readAnimationKey(),e=!0}this._currentObject.worked=!0}if(this._currentObject.children.length>0){if(this._currentObject=this._currentObject.children.shift(),this.debug&&console.log("processing "+this._currentObject.name),e)break}else if(this._currentObject.worked&&this._currentObject.parent&&!this._currentObject.parent.parent&&this._changeRoot(),this._currentObject.parent?this._currentObject=this._currentObject.parent:e=!0,e)break}}},{key:"_changeRoot",value:function(){null!=this._currentGeo&&this._currentGeo.name&&this._makeOutputGeometry(),this._currentGeo={},null!=this._currentAnime&&this._currentAnime.name&&(this._currentAnimeFrames&&(this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=null),this._makeOutputAnimation()),this._currentAnime={}}},{key:"_getParentName",value:function(e){return e.parent?e.parent.name?e.parent.name:this._getParentName(e.parent):""}},{key:"_setFrame",value:function(){this._nowFrameName=this._currentObject.name.trim(),this._currentFrame={},this._currentFrame.name=this._nowFrameName,this._currentFrame.children=[],this._currentObject.parent&&this._currentObject.parent.name&&(this._currentFrame.parentName=this._currentObject.parent.name),this.frameHierarchie.push(this._nowFrameName),this.HieStack[this._nowFrameName]=this._currentFrame}},{key:"_setFrameTransformMatrix",value:function(){this._currentFrame.FrameTransformMatrix=new THREE.Matrix4;var e=this._currentObject.data.split(",");this._ParseMatrixData(this._currentFrame.FrameTransformMatrix,e),this._makeBoneFrom_CurrentFrame()}},{key:"_makeBoneFrom_CurrentFrame",value:function(){if(this._currentFrame.FrameTransformMatrix){var e=new THREE.Bone;if(e.name=this._currentFrame.name,e.applyMatrix(this._currentFrame.FrameTransformMatrix),e.matrixWorld=e.matrix,e.FrameTransformMatrix=this._currentFrame.FrameTransformMatrix,this._currentFrame.putBone=e,this._currentFrame.parentName)for(var t in this.HieStack)this.HieStack[t].name===this._currentFrame.parentName&&this.HieStack[t].putBone.add(this._currentFrame.putBone)}}},{key:"_readVertexDatas",value:function(){for(var e=0,t=0,r=0,a=0,s=0;;){var i=!1;if(0===r){e=this._readInt1(e).endRead,r=1,s=0,(a=this._currentObject.data.indexOf(";;",e)+1)<=0&&(a=this._currentObject.data.length)}else{var n=0;switch(t){case 0:n=this._currentObject.data.indexOf(",",e)+1;break;case 1:n=this._currentObject.data.indexOf(";,",e)+1}switch((0===n||n>a)&&(n=a,r=0,i=!0),this._currentObject.type){case"Mesh":switch(t){case 0:this._readVertex1(this._currentObject.data.substr(e,n-e));break;case 1:this._readFace1(this._currentObject.data.substr(e,n-e))}break;case"MeshNormals":switch(t){case 0:this._readNormalVector1(this._currentObject.data.substr(e,n-e));break;case 1:this._readNormalFace1(this._currentObject.data.substr(e,n-e),s)}}e=n+1,s++,i&&t++}if(e>=this._currentObject.data.length)break}}},{key:"_readInt1",value:function(e){var t=this._currentObject.data.indexOf(";",e);return{refI:parseInt(this._currentObject.data.substr(e,t-e)),endRead:t+1}}},{key:"_readVertex1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.Geometry.vertices.push(new THREE.Vector3(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),this._currentGeo.Geometry.skinIndices.push(new THREE.Vector4(0,0,0,0)),this._currentGeo.Geometry.skinWeights.push(new THREE.Vector4(1,0,0,0)),this._currentGeo.VertexSetedBoneCount.push(0)}},{key:"_readFace1",value:function(e){var t=this._readLine(e.trim()).substr(2,e.length-4).split(",");this._currentGeo.Geometry.faces.push(new THREE.Face3(parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10),new THREE.Vector3(1,1,1).normalize()))}},{key:"_readNormalVector1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.normalVectors.push(new THREE.Vector3(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])))}},{key:"_readNormalFace1",value:function(e,t){var r=this._readLine(e.trim()).substr(2,e.length-4).split(","),a=parseInt(r[0],10),s=this._currentGeo.normalVectors[a];a=parseInt(r[1],10);var i=this._currentGeo.normalVectors[a];a=parseInt(r[2],10);var n=this._currentGeo.normalVectors[a];this._currentGeo.Geometry.faces[t].vertexNormals=[s,i,n]}},{key:"_setMeshNormals",value:function(){for(var e=0,t=0,r=0;;){switch(t){case 0:if(0===r){e=this._readInt1(0).endRead,r=1}else{var a=this._currentObject.data.indexOf(",",e)+1;-1===a&&(a=this._currentObject.data.indexOf(";;",e)+1,t=2,r=0);var s=this._currentObject.data.substr(e,a-e),i=this._readLine(s.trim()).split(";");this._currentGeo.normalVectors.push([parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])]),e=a+1}}if(e>=this._currentObject.data.length)break}}},{key:"_setMeshTextureCoords",value:function(){this._tmpUvArray=[],this._currentGeo.Geometry.faceVertexUvs=[],this._currentGeo.Geometry.faceVertexUvs.push([]);for(var e=0,t=0,r=0;;){switch(t){case 0:if(0===r){e=this._readInt1(0).endRead,r=1}else{var a=this._currentObject.data.indexOf(",",e)+1;0===a&&(a=this._currentObject.data.length,t=2,r=0);var s=this._currentObject.data.substr(e,a-e),i=this._readLine(s.trim()).split(";");this.IsUvYReverse?this._tmpUvArray.push(new THREE.Vector2(parseFloat(i[0]),1-parseFloat(i[1]))):this._tmpUvArray.push(new THREE.Vector2(parseFloat(i[0]),parseFloat(i[1]))),e=a+1}}if(e>=this._currentObject.data.length)break}this._currentGeo.Geometry.faceVertexUvs[0]=[];for(var n=0;n<this._currentGeo.Geometry.faces.length;n++)this._currentGeo.Geometry.faceVertexUvs[0][n]=[],this._currentGeo.Geometry.faceVertexUvs[0][n].push(this._tmpUvArray[this._currentGeo.Geometry.faces[n].a]),this._currentGeo.Geometry.faceVertexUvs[0][n].push(this._tmpUvArray[this._currentGeo.Geometry.faces[n].b]),this._currentGeo.Geometry.faceVertexUvs[0][n].push(this._tmpUvArray[this._currentGeo.Geometry.faces[n].c]);this._currentGeo.Geometry.uvsNeedUpdate=!0}},{key:"_setMeshMaterialList",value:function(){for(var e=0,t=0,r=0;;){if(r<2){e=this._readInt1(e).endRead,r++}else{var a=this._currentObject.data.indexOf(";",e);-1===a&&(a=this._currentObject.data.length,t=3,r=0);for(var s=this._currentObject.data.substr(e,a-e),i=this._readLine(s.trim()).split(","),n=0;n<i.length;n++)this._currentGeo.Geometry.faces[n].materialIndex=parseInt(i[n]);e=this._currentObject.data.length}if(e>=this._currentObject.data.length||t>=3)break}}},{key:"_setMaterial",value:function(){var e=new THREE.MeshPhongMaterial({color:16777215*Math.random()});e.side=THREE.FrontSide,e.name=this._currentObject.name;var t=0,r=this._currentObject.data.indexOf(";;",t),a=this._currentObject.data.substr(t,r-t),s=this._readLine(a.trim()).split(";");e.color.r=parseFloat(s[0]),e.color.g=parseFloat(s[1]),e.color.b=parseFloat(s[2]),t=r+2,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t),e.shininess=parseFloat(this._readLine(a)),t=r+1,r=this._currentObject.data.indexOf(";;",t),a=this._currentObject.data.substr(t,r-t);var i=this._readLine(a.trim()).split(";");e.specular.r=parseFloat(i[0]),e.specular.g=parseFloat(i[1]),e.specular.b=parseFloat(i[2]),t=r+2,-1===(r=this._currentObject.data.indexOf(";;",t))&&(r=this._currentObject.data.length),a=this._currentObject.data.substr(t,r-t);var n=this._readLine(a.trim()).split(";");e.emissive.r=parseFloat(n[0]),e.emissive.g=parseFloat(n[1]),e.emissive.b=parseFloat(n[2]);for(var o=null;this._currentObject.children.length>0;){o=this._currentObject.children.shift(),this.debug&&console.log("processing "+o.name);var h=o.data.substr(1,o.data.length-2);switch(o.type){case"TextureFilename":e.map=this.texloader.load(this.baseDir+h);break;case"BumpMapFilename":e.bumpMap=this.texloader.load(this.baseDir+h),e.bumpScale=.05;break;case"NormalMapFilename":e.normalMap=this.texloader.load(this.baseDir+h),e.normalScale=new THREE.Vector2(2,2);break;case"EmissiveMapFilename":e.emissiveMap=this.texloader.load(this.baseDir+h);break;case"LightMapFilename":e.lightMap=this.texloader.load(this.baseDir+h)}}this._currentGeo.Materials.push(e)}},{key:"_setSkinWeights",value:function(){var t=new function t(){e(this,t),this.boneName="",this.BoneIndex=0,this.Indeces=[],this.Weights=[],this.initMatrix=null,this.OffsetMatrix=null},r=0,a=this._currentObject.data.indexOf(";",r),s=this._currentObject.data.substr(r,a-r);r=a+1,t.boneName=s.substr(1,s.length-2),t.BoneIndex=this._currentGeo.BoneInfs.length,r=(a=this._currentObject.data.indexOf(";",r))+1,a=this._currentObject.data.indexOf(";",r),s=this._currentObject.data.substr(r,a-r);for(var i=this._readLine(s.trim()).split(","),n=0;n<i.length;n++)t.Indeces.push(parseInt(i[n]));r=a+1,a=this._currentObject.data.indexOf(";",r),s=this._currentObject.data.substr(r,a-r);for(var o=this._readLine(s.trim()).split(","),h=0;h<o.length;h++)t.Weights.push(parseFloat(o[h]));r=a+1,(a=this._currentObject.data.indexOf(";",r))<=0&&(a=this._currentObject.data.length),s=this._currentObject.data.substr(r,a-r);var c=this._readLine(s.trim()).split(",");t.OffsetMatrix=new THREE.Matrix4,this._ParseMatrixData(t.OffsetMatrix,c),this._currentGeo.BoneInfs.push(t)}},{key:"_makePutBoneList",value:function(e,t){var r=!1;for(var a in this.HieStack)if(this.HieStack[a].name===e||r){r=!0;var s=new THREE.Bone;if(s.name=this.HieStack[a].name,s.applyMatrix(this.HieStack[a].FrameTransformMatrix),s.matrixWorld=s.matrix,s.FrameTransformMatrix=this.HieStack[a].FrameTransformMatrix,s.pos=(new THREE.Vector3).setFromMatrixPosition(s.FrameTransformMatrix).toArray(),s.rotq=(new THREE.Quaternion).setFromRotationMatrix(s.FrameTransformMatrix).toArray(),s.scl=(new THREE.Vector3).setFromMatrixScale(s.FrameTransformMatrix).toArray(),this.HieStack[a].parentName&&this.HieStack[a].parentName.length>0)for(var i=0;i<t.length;i++)if(this.HieStack[a].parentName===t[i].name){t[i].add(s),s.parent=i;break}t.push(s)}}},{key:"_makeOutputGeometry",value:function(){this._currentGeo.Geometry.computeBoundingBox(),this._currentGeo.Geometry.computeBoundingSphere(),this._currentGeo.Geometry.verticesNeedUpdate=!0,this._currentGeo.Geometry.normalsNeedUpdate=!0,this._currentGeo.Geometry.colorsNeedUpdate=!0,this._currentGeo.Geometry.uvsNeedUpdate=!0,this._currentGeo.Geometry.groupsNeedUpdate=!0;var e=null;if(this._currentGeo.BoneInfs.length>0){var t=[];this._makePutBoneList(this._currentGeo.baseFrame.parentName,t);for(var r=0;r<this._currentGeo.BoneInfs.length;r++){for(var a=0,s=0;s<t.length;s++)if(t[s].name===this._currentGeo.BoneInfs[r].boneName){a=s,t[s].OffsetMatrix=new THREE.Matrix4,t[s].OffsetMatrix.copy(this._currentGeo.BoneInfs[r].OffsetMatrix);break}for(var i=0;i<this._currentGeo.BoneInfs[r].Indeces.length;i++){var n=this._currentGeo.BoneInfs[r].Indeces[i],o=this._currentGeo.BoneInfs[r].Weights[i];switch(this._currentGeo.VertexSetedBoneCount[n]){case 0:this._currentGeo.Geometry.skinIndices[n].x=a,this._currentGeo.Geometry.skinWeights[n].x=o;break;case 1:this._currentGeo.Geometry.skinIndices[n].y=a,this._currentGeo.Geometry.skinWeights[n].y=o;break;case 2:this._currentGeo.Geometry.skinIndices[n].z=a,this._currentGeo.Geometry.skinWeights[n].z=o;break;case 3:this._currentGeo.Geometry.skinIndices[n].w=a,this._currentGeo.Geometry.skinWeights[n].w=o}this._currentGeo.VertexSetedBoneCount[n]++,this._currentGeo.VertexSetedBoneCount[n]>4&&console.log("warn! over 4 bone weight! :"+n)}}for(var h=0;h<this._currentGeo.Materials.length;h++)this._currentGeo.Materials[h].skinning=!0;for(var c=[],u=0;u<t.length;u++)t[u].OffsetMatrix?c.push(t[u].OffsetMatrix):c.push(new THREE.Matrix4);var m=(new THREE.BufferGeometry).fromGeometry(this._currentGeo.Geometry);m.bones=t,(e=new THREE.SkinnedMesh(m,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials)).skeleton.boneInverses=c}else{var l=(new THREE.BufferGeometry).fromGeometry(this._currentGeo.Geometry);e=new THREE.Mesh(l,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials)}e.name=this._currentGeo.name;var _=new THREE.Matrix4,p=this._currentGeo.baseFrame.putBone;if(p&&p.parent){for(;p=p.parent;)_.multiply(p.FrameTransformMatrix);e.applyMatrix(_)}this.Meshes.push(e)}},{key:"_readAnimationKey",value:function(){var e=0,t=this._currentObject.data.indexOf(";",e),r=this._currentObject.data.substr(e,t-e);e=t+1;var a=parseInt(this._readLine(r));e=(t=this._currentObject.data.indexOf(";",e))+1,r=this._currentObject.data.substr(e);for(var i=this._readLine(r.trim()).split(";;,"),n=0;n<i.length;n++){var o=i[n].split(";"),h=new s;if(h.type=a,h.Frame=parseInt(o[0]),h.index=this._currentAnimeFrames.keyFrames.length,h.time=h.Frame,4!=a){for(var c=!1,u=0;u<this._currentAnimeFrames.keyFrames.length;u++)if(this._currentAnimeFrames.keyFrames[u].Frame===h.Frame){h=this._currentAnimeFrames.keyFrames[u],c=!0;break}var m=o[2].split(",");switch(a){case 0:h.rot=new THREE.Quaternion(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]),-1*parseFloat(m[0]));break;case 1:h.scl=new THREE.Vector3(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]));break;case 2:h.pos=new THREE.Vector3(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]))}c||this._currentAnimeFrames.keyFrames.push(h)}else h.matrix=new THREE.Matrix4,this._ParseMatrixData(h.matrix,o[2].split(",")),this._currentAnimeFrames.keyFrames.push(h)}}},{key:"_makeOutputAnimation",value:function(){var e=new a(this.options);e.fps=this.animTicksPerSecond,e.name=this._currentAnime.name,e.make(this._currentAnime.AnimeFrames),this.animations.push(e)}},{key:"assignAnimation",value:function(e,t,r){var a=e,s=t;if(a||(a=this.Meshes[0]),s||(s=this.animations[0]),!a||!s)return null;var i={};i.fps=s.fps,i.name=s.name,i.length=s.length,i.hierarchy=[];for(var n=0;n<a.skeleton.bones.length;n++){for(var o=!1,h=0;h<s.hierarchy.length;h++)if(a.skeleton.bones[n].name===s.hierarchy[h].name){o=!0;var c=s.hierarchy[h].copy();if(c.parent=-1,a.skeleton.bones[n].parent&&"Bone"===a.skeleton.bones[n].parent.type)for(var u=0;u<i.hierarchy.length;u++)i.hierarchy[u].name===a.skeleton.bones[n].parent.name&&(c.parent=u,c.parentName=a.skeleton.bones[n].parent.name);i.hierarchy.push(c);break}if(!o){var m=s.hierarchy[0].copy();m.name=a.skeleton.bones[n].name,m.parent=-1;for(var l=0;l<m.keys.length;l++)m.keys[l].pos&&m.keys[l].pos.set(0,0,0),m.keys[l].scl&&m.keys[l].scl.set(1,1,1),m.keys[l].rot&&m.keys[l].rot.set(0,0,0,1);i.hierarchy.push(m)}}return a.geometry.animations||(a.geometry.animations=[]),a.geometry.animations.push(THREE.AnimationClip.parseAnimation(i,a.skeleton.bones)),a.animationMixer||(a.animationMixer=new THREE.AnimationMixer(a)),i}},{key:"_ParseMatrixData",value:function(e,t){e.set(parseFloat(t[0]),parseFloat(t[4]),parseFloat(t[8]),parseFloat(t[12]),parseFloat(t[1]),parseFloat(t[5]),parseFloat(t[9]),parseFloat(t[13]),parseFloat(t[2]),parseFloat(t[6]),parseFloat(t[10]),parseFloat(t[14]),parseFloat(t[3]),parseFloat(t[7]),parseFloat(t[11]),parseFloat(t[15]))}}]),i}()});