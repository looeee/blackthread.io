!function(){var t=!0;function r(){this.id=0,this.data=null}function e(){}e.prototype={set:function(t,r){this[t]=r},get:function(t,r){return this.hasOwnProperty(t)?this[t]:r}},THREE.AWDLoader=function(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager,this.trunk=new THREE.Object3D,this.materialFactory=void 0,this._url="",this._baseDir="",this._data=void 0,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new r],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1},THREE.AWDLoader.prototype={constructor:THREE.AWDLoader,load:function(t,r,e,s){var a=this;this._url=t,this._baseDir=t.substr(0,t.lastIndexOf("/")+1);var i=new THREE.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.load(t,function(t){r(a.parse(t))},e,s)},parse:function(t){var r=t.byteLength;for(this._ptr=0,this._data=new DataView(t),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==t.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,r-this._ptr);this._ptr<r;)this.parseNextBlock();return this.trunk},parseNextBlock:function(){var t,e,s=this.readU32(),a=(this.readU8(),this.readU8()),i=(this.readU8(),this.readU32());switch(a){case 1:t=this.parseMeshData(i);break;case 22:t=this.parseContainer(i);break;case 23:t=this.parseMeshInstance(i);break;case 81:t=this.parseMaterial(i);break;case 82:t=this.parseTexture(i);break;case 101:t=this.parseSkeleton(i);break;case 112:t=this.parseMeshPoseAnimation(i,!1);break;case 113:t=this.parseVertexAnimationSet(i);break;case 102:t=this.parseSkeletonPose(i);break;case 103:t=this.parseSkeletonAnimation(i);break;case 122:t=this.parseAnimatorSet(i);break;default:this._ptr+=i}this._blocks[s]=e=new r,e.data=t,e.id=s},_parseHeader:function(){var t=this._version;if(4282180!=(this.readU8()<<16|this.readU8()<<8|this.readU8()))throw new Error("AWDLoader - bad magic");t[0]=this.readU8(),t[1]=this.readU8();var r=this.readU16();this._streaming=1==(1&r),2===t[0]&&1===t[1]&&(this._accuracyMatrix=2==(2&r),this._accuracyGeo=4==(4&r),this._accuracyProps=8==(8&r)),this._geoNrType=this._accuracyGeo?8:7,this._matrixNrType=this._accuracyMatrix?8:7,this._propsNrType=this._accuracyProps?8:7,this._optimized_for_accuracy=2==(2&r),this._compression=this.readU8(),this._bodylen=this.readU32()},parseContainer:function(t){var r=new THREE.Object3D,e=this.readU32(),s=this.parseMatrix4();return r.name=this.readUTF(),r.applyMatrix(s),(this._blocks[e].data||this.trunk).add(r),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:4}),r.extra=this.parseUserAttributes(),r},parseMeshInstance:function(t){var r,e,s,a,i,h,n,o,d,p,u,c,l;for(h=this.readU32(),o=this.parseMatrix4(),r=this.readUTF(),n=this.readU32(),c=this.readU16(),s=this.getBlock(n),d=[],l=0;l<c;l++)u=this.readU32(),p=this.getBlock(u),d.push(p);if(i=[],(a=s.length)>1)for(e=new THREE.Object3D,l=0;l<a;l++){var _=new THREE.Mesh(s[l]);i.push(_),e.add(_)}else e=new THREE.Mesh(s[0]),i.push(e);e.applyMatrix(o),e.name=r,(this.getBlock(h)||this.trunk).add(e);var U=d.length,f=Math.max(a,U);for(l=0;l<f;l++)i[l%a].material=d[l%U];return this.parseProperties(null),e.extra=this.parseUserAttributes(),e},parseMaterial:function(t){var r,e,s,a,i,h;for(r=this.readUTF(),e=this.readU8(),h=this.readU8(),s=this.parseProperties({1:3,2:23,11:21,12:7,13:21}),0;0<h;){this.readU16();this.parseProperties(null),this.parseUserAttributes()}if(i=this.parseUserAttributes(),void 0!==this.materialFactory&&(a=this.materialFactory(r)))return a;if(a=new THREE.MeshPhongMaterial,1===e)a.color.setHex(s.get(1,13421772));else if(2===e){var n=s.get(2,0);a.map=this.getBlock(n)}return a.extra=i,a.alphaThreshold=s.get(12,0),a.repeat=s.get(13,!1),a},parseTexture:function(t){var r,e;this.readUTF();if(0===this.readU8()){e=this.readU32();var s=this.readUTFBytes(e);console.log(s),r=this.loadTexture(s)}return this.parseProperties(null),this.parseUserAttributes(),r},loadTexture:function(t){var r=new THREE.Texture;return new THREE.ImageLoader(this.manager).load(this._baseDir+t,function(t){r.image=t,r.needsUpdate=!0}),r},parseSkeleton:function(t){this.readUTF();var r=this.readU16(),e=[],s=0;for(this.parseProperties(null);s<r;){var a,i;this.readU16(),(a=new THREE.Bone).parent=this.readU16()-1,a.name=this.readUTF(),i=this.parseMatrix4(),a.skinMatrix=i,this.parseProperties(null),this.parseUserAttributes(),e.push(a),s++}return this.parseUserAttributes(),e},parseSkeletonPose:function(t){this.readUTF();var r=this.readU16();this.parseProperties(null);for(var e=[],s=0;s<r;){var a;a=1===this.readU8()?this.parseMatrix4():new THREE.Matrix4,e[s]=a,s++}return this.parseUserAttributes(),e},parseSkeletonAnimation:function(t){this.readUTF();var r,e,s,a=[],i=this.readU16();this.parseProperties(null);for(var h=0;h<i;)e=this.readU32(),r=this.readU16(),s=this._blocks[e].data,a.push({pose:s,duration:r}),h++;if(0!==a.length)return this.parseUserAttributes(),a},parseVertexAnimationSet:function(t){this.readUTF();for(var r,e=this.readU16(),s=(this.parseProperties({1:5}),0),a=[];s<e;)r=this.readU32(),a.push(this._blocks[r].data),s++;return this.parseUserAttributes(),a},parseAnimatorSet:function(t){this.readUTF();var r,e,s=this.readU16(),a=this.parseProperties({1:23});r=this.readU32();for(var i=this.readU16(),h=[],n=0;n<i;n++)h.push(this.readU32());this.readU16(),Boolean(this.readU8());this.parseUserAttributes(),this.parseUserAttributes();var o,d=[];for(n=0;n<h.length;n++)d.push(this._blocks[h[n]].data);for(e=this._blocks[r].data,1==s&&(o={animationSet:e,skeleton:this._blocks[a.get(1,0)].data}),n=0;n<d.length;n++)d[n].animator=o;return o},parseMeshData:function(t){var r,e,s=this.readUTF(),a=this.readU16(),i=0,h=[];for(this.parseProperties({1:this._geoNrType,2:this._geoNrType});i<a;){var n,o,d;for((r=new THREE.BufferGeometry).name=s,h.push(r),n=this.readU32(),o=this._ptr+n,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<o;){var p=0,u=this.readU8(),c=(this.readU8(),this.readU32()),l=c+this._ptr;if(1===u)for(e=new Float32Array(c/12*3),d=new THREE.BufferAttribute(e,3),r.addAttribute("position",d),p=0;this._ptr<l;)e[p]=-this.readF32(),e[p+1]=this.readF32(),e[p+2]=this.readF32(),p+=3;else if(2===u)for(e=new Uint16Array(c/2),d=new THREE.BufferAttribute(e,1),r.setIndex(d),p=0;this._ptr<l;)e[p+1]=this.readU16(),e[p]=this.readU16(),e[p+2]=this.readU16(),p+=3;else if(3===u)for(e=new Float32Array(c/8*2),d=new THREE.BufferAttribute(e,2),r.addAttribute("uv",d),p=0;this._ptr<l;)e[p]=this.readF32(),e[p+1]=1-this.readF32(),p+=2;else if(4===u)for(e=new Float32Array(c/12*3),d=new THREE.BufferAttribute(e,3),r.addAttribute("normal",d),p=0;this._ptr<l;)e[p]=-this.readF32(),e[p+1]=this.readF32(),e[p+2]=this.readF32(),p+=3;else this._ptr=l}this.parseUserAttributes(),r.computeBoundingSphere(),i++}return this.parseUserAttributes(),h},parseMeshPoseAnimation:function(t,r){var e,s,a,i,h,n,o,d,p,u=1,c=0,l={},_=[],U=(this.readUTF(),this.readU32()),f=this.getBlock(U);if(null!==f){for((n=f.geometry).morphTargets=[],r||(u=this.readU16()),e=this.readU16(),o=this.readU16(),d=0;d<o;)_.push(this.readU16()),d++;for(p=this.parseProperties({1:21,2:21}),l.looping=p.get(1,!0),l.stitchFinalFrame=p.get(2,!1),s=0;s<u;){for(this.readU16(),a=0;a<e;)for(d=0,i=this.readU32(),h=this._ptr+i;d<o;){if(1===_[d]){var b=new Float32Array(i/4);for(n.morphTargets.push({array:b}),c=0;this._ptr<h;)b[c]=this.readF32(),b[c+1]=this.readF32(),b[c+2]=this.readF32(),c+=3;a++}else this._ptr=h;d++}s++}return this.parseUserAttributes(),null}console.log("parseMeshPoseAnimation target mesh not found at:",U)},getBlock:function(t){return this._blocks[t].data},parseMatrix4:function(){var t=new THREE.Matrix4,r=t.elements;return r[0]=this.readF32(),r[1]=this.readF32(),r[2]=this.readF32(),r[3]=0,r[4]=this.readF32(),r[5]=this.readF32(),r[6]=this.readF32(),r[7]=0,r[8]=this.readF32(),r[9]=this.readF32(),r[10]=this.readF32(),r[11]=0,r[12]=-this.readF32(),r[13]=this.readF32(),r[14]=this.readF32(),r[15]=1,t},parseProperties:function(t){var r=this.readU32(),s=this._ptr+r,a=new e;if(t)for(;this._ptr<s;){var i,h=this.readU16(),n=this.readU32();t.hasOwnProperty(h)?(i=t[h],a.set(h,this.parseAttrValue(i,n))):this._ptr+=n}return a},parseUserAttributes:function(){return this._ptr=this.readU32()+this._ptr,null},parseAttrValue:function(t,r){var e,s;switch(t){case 1:e=1,s=this.readI8;break;case 2:e=2,s=this.readI16;break;case 3:e=4,s=this.readI32;break;case 21:case 4:e=1,s=this.readU8;break;case 5:e=2,s=this.readU16;break;case 6:case 23:e=4,s=this.readU32;break;case 7:e=4,s=this.readF32;break;case 8:e=8,s=this.readF64;break;case 41:case 42:case 43:case 44:case 45:case 46:case 47:e=8,s=this.readF64}if(e<r){var a,i,h;for(a=[],i=0,h=r/e;i<h;)a.push(s.call(this)),i++;return a}return s.call(this)},readU8:function(){return this._data.getUint8(this._ptr++)},readI8:function(){return this._data.getInt8(this._ptr++)},readU16:function(){var r=this._data.getUint16(this._ptr,t);return this._ptr+=2,r},readI16:function(){var r=this._data.getInt16(this._ptr,t);return this._ptr+=2,r},readU32:function(){var r=this._data.getUint32(this._ptr,t);return this._ptr+=4,r},readI32:function(){var r=this._data.getInt32(this._ptr,t);return this._ptr+=4,r},readF32:function(){var r=this._data.getFloat32(this._ptr,t);return this._ptr+=4,r},readF64:function(){var r=this._data.getFloat64(this._ptr,t);return this._ptr+=8,r},readUTF:function(){var t=this.readU16();return this.readUTFBytes(t)},readUTFBytes:function(r){for(var e=[],s=0;e.length<r;){var a=this._data.getUint8(this._ptr++,t);if(a<128)e[s++]=String.fromCharCode(a);else if(a>191&&a<224){var i=this._data.getUint8(this._ptr++,t);e[s++]=String.fromCharCode((31&a)<<6|63&i)}else{i=this._data.getUint8(this._ptr++,t);var h=this._data.getUint8(this._ptr++,t);e[s++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&h)}}return e.join("")}}}();