THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.dracoLoader=null}e.prototype={constructor:e,crossOrigin:"Anonymous",load:function(e,t,a,r){var s=this,n=void 0!==this.path?this.path:THREE.LoaderUtils.extractUrlBase(e),i=new THREE.FileLoader(s.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){try{s.parse(e,n,t,r)}catch(e){if(void 0===r)throw e;r(e)}},a,r)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},setDRACOLoader:function(e){return this.dracoLoader=e,this},parse:function(e,o,l,p){var u,c={};if("string"==typeof e)u=e;else if(THREE.LoaderUtils.decodeText(new Uint8Array(e,0,4))===r){try{c[t.KHR_BINARY_GLTF]=new function(e){this.name=t.KHR_BINARY_GLTF,this.content=null,this.body=null;var a=new DataView(e,0,s);{if(this.header={magic:THREE.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:a.getUint32(4,!0),length:a.getUint32(8,!0)},this.header.magic!==r)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.")}var i=new DataView(e,s),o=0;for(;o<i.byteLength;){var l=i.getUint32(o,!0);o+=4;var p=i.getUint32(o,!0);if(o+=4,p===n.JSON){var u=new Uint8Array(e,s+o,l);this.content=THREE.LoaderUtils.decodeText(u)}else if(p===n.BIN){var c=s+o;this.body=e.slice(c,c+l)}o+=l}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}(e)}catch(e){return void(p&&p(e))}u=c[t.KHR_BINARY_GLTF].content}else u=THREE.LoaderUtils.decodeText(new Uint8Array(e));var d=JSON.parse(u);void 0===d.asset||d.asset.version[0]<2?p&&p(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead.")):(d.extensionsUsed&&(d.extensionsUsed.indexOf(t.KHR_LIGHTS)>=0&&(c[t.KHR_LIGHTS]=new function(e){this.name=t.KHR_LIGHTS,this.lights={};var a=(e.extensions&&e.extensions[t.KHR_LIGHTS]||{}).lights||{};for(var r in a){var s,n=a[r],i=(new THREE.Color).fromArray(n.color);switch(n.type){case"directional":(s=new THREE.DirectionalLight(i)).position.set(0,0,1);break;case"point":s=new THREE.PointLight(i);break;case"spot":(s=new THREE.SpotLight(i)).position.set(0,0,1);break;case"ambient":s=new THREE.AmbientLight(i)}s&&(void 0!==n.constantAttenuation&&(s.intensity=n.constantAttenuation),void 0!==n.linearAttenuation&&(s.distance=1/n.linearAttenuation),void 0!==n.quadraticAttenuation&&(s.decay=n.quadraticAttenuation),void 0!==n.fallOffAngle&&(s.angle=n.fallOffAngle),void 0!==n.fallOffExponent&&console.warn("THREE.GLTFLoader:: light.fallOffExponent not currently supported."),s.name=n.name||"light_"+r,this.lights[r]=s)}}(d)),d.extensionsUsed.indexOf(t.KHR_MATERIALS_UNLIT)>=0&&(c[t.KHR_MATERIALS_UNLIT]=new a(d)),d.extensionsUsed.indexOf(t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS)>=0&&(c[t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]=new function(){return{name:t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return THREE.ShaderMaterial},extendParams:function(e,t,a){var r=t.extensions[this.name],s=THREE.ShaderLib.standard,n=THREE.UniformsUtils.clone(s.uniforms),i=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),l=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),p=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),u=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),c=s.fragmentShader.replace("#include <specularmap_fragment>","").replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",i).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",l).replace("#include <metalnessmap_fragment>",p).replace("#include <lights_physical_fragment>",u);delete n.roughness,delete n.metalness,delete n.roughnessMap,delete n.metalnessMap,n.specular={value:(new THREE.Color).setHex(1118481)},n.glossiness={value:.5},n.specularMap={value:null},n.glossinessMap={value:null},e.vertexShader=s.vertexShader,e.fragmentShader=c,e.uniforms=n,e.defines={STANDARD:""},e.color=new THREE.Color(1,1,1),e.opacity=1;var d=[];if(Array.isArray(r.diffuseFactor)){var E=r.diffuseFactor;e.color.fromArray(E),e.opacity=E[3]}if(void 0!==r.diffuseTexture&&d.push(a.assignTexture(e,"map",r.diffuseTexture.index)),e.emissive=new THREE.Color(0,0,0),e.glossiness=void 0!==r.glossinessFactor?r.glossinessFactor:1,e.specular=new THREE.Color(1,1,1),Array.isArray(r.specularFactor)&&e.specular.fromArray(r.specularFactor),void 0!==r.specularGlossinessTexture){var h=r.specularGlossinessTexture.index;d.push(a.assignTexture(e,"glossinessMap",h)),d.push(a.assignTexture(e,"specularMap",h))}return Promise.all(d)},createMaterial:function(e){var t=new THREE.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var a=this.specularGlossinessParams,r=0,s=a.length;r<s;r++)t[a[r]]=e[a[r]];return t},refreshUniforms:function(e,t,a,r,s,n){if(!0===s.isGLTFSpecularGlossinessMaterial){var i,o,l,p=s.uniforms,u=s.defines;if(p.opacity.value=s.opacity,p.diffuse.value.copy(s.color),p.emissive.value.copy(s.emissive).multiplyScalar(s.emissiveIntensity),p.map.value=s.map,p.specularMap.value=s.specularMap,p.alphaMap.value=s.alphaMap,p.lightMap.value=s.lightMap,p.lightMapIntensity.value=s.lightMapIntensity,p.aoMap.value=s.aoMap,p.aoMapIntensity.value=s.aoMapIntensity,s.map?i=s.map:s.specularMap?i=s.specularMap:s.displacementMap?i=s.displacementMap:s.normalMap?i=s.normalMap:s.bumpMap?i=s.bumpMap:s.glossinessMap?i=s.glossinessMap:s.alphaMap?i=s.alphaMap:s.emissiveMap&&(i=s.emissiveMap),void 0!==i)if(i.isWebGLRenderTarget&&(i=i.texture),void 0!==i.matrix){if(!0===i.matrixAutoUpdate){o=i.offset,l=i.repeat;var c=i.rotation,d=i.center;i.matrix.setUvTransform(o.x,o.y,l.x,l.y,c,d.x,d.y)}p.uvTransform.value.copy(i.matrix)}else o=i.offset,l=i.repeat,p.offsetRepeat.value.set(o.x,o.y,l.x,l.y);p.envMap.value=s.envMap,p.envMapIntensity.value=s.envMapIntensity,p.flipEnvMap.value=s.envMap&&s.envMap.isCubeTexture?-1:1,p.refractionRatio.value=s.refractionRatio,p.specular.value.copy(s.specular),p.glossiness.value=s.glossiness,p.glossinessMap.value=s.glossinessMap,p.emissiveMap.value=s.emissiveMap,p.bumpMap.value=s.bumpMap,p.normalMap.value=s.normalMap,p.displacementMap.value=s.displacementMap,p.displacementScale.value=s.displacementScale,p.displacementBias.value=s.displacementBias,null!==p.glossinessMap.value&&void 0===u.USE_GLOSSINESSMAP&&(u.USE_GLOSSINESSMAP="",u.USE_ROUGHNESSMAP=""),null===p.glossinessMap.value&&void 0!==u.USE_GLOSSINESSMAP&&(delete u.USE_GLOSSINESSMAP,delete u.USE_ROUGHNESSMAP)}}}}),d.extensionsUsed.indexOf(t.KHR_DRACO_MESH_COMPRESSION)>=0&&(c[t.KHR_DRACO_MESH_COMPRESSION]=new i(this.dracoLoader))),console.time("GLTFLoader"),new F(d,c,{path:o||this.path||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(function(e,t,a,r,s){console.timeEnd("GLTFLoader"),l({scene:e,scenes:t,cameras:a,animations:r,asset:s})},p))}};var t={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS:"KHR_lights",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit"};function a(e){this.name=t.KHR_MATERIALS_UNLIT}a.prototype.getMaterialType=function(e){return THREE.MeshBasicMaterial},a.prototype.extendParams=function(e,t,a){var r=[];e.color=new THREE.Color(1,1,1),e.opacity=1;var s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){var n=s.baseColorFactor;e.color.fromArray(n),e.opacity=n[3]}void 0!==s.baseColorTexture&&r.push(a.assignTexture(e,"map",s.baseColorTexture.index))}return Promise.all(r)};var r="glTF",s=12,n={JSON:1313821514,BIN:5130562};function i(e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=t.KHR_DRACO_MESH_COMPRESSION,this.dracoLoader=e}function o(e,t,a,r){THREE.Interpolant.call(this,e,t,a,r)}i.prototype.decodePrimitive=function(e,t){var a=this.dracoLoader,r=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,n={};for(var i in s)i in M&&(n[M[i]]=s[i]);return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t){a.decodeDracoFile(e,t,n)})})},o.prototype=Object.create(THREE.Interpolant.prototype),o.prototype.constructor=o,o.prototype.interpolate_=function(e,t,a,r){for(var s=this.resultBuffer,n=this.sampleValues,i=this.valueSize,o=2*i,l=3*i,p=r-t,u=(a-t)/p,c=u*u,d=c*u,E=e*l,h=E-l,m=2*d-3*c+1,f=d-2*c+u,v=-2*d+3*c,T=d-c,R=0;R!==i;R++){var g=n[h+R+i],M=n[h+R+o]*p,S=n[E+R+i],H=n[E+R]*p;s[R]=m*g+f*M+v*S+T*H}return s};var l=0,p=1,u=2,c=3,d=4,E=5,h=6,m=(Number,THREE.Matrix3,THREE.Matrix4,THREE.Vector2,THREE.Vector3,THREE.Vector4,THREE.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),f={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},v={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},T={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},R={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},g=(THREE.BackSide,THREE.FrontSide,THREE.NeverDepth,THREE.LessDepth,THREE.EqualDepth,THREE.LessEqualDepth,THREE.GreaterEqualDepth,THREE.NotEqualDepth,THREE.GreaterEqualDepth,THREE.AlwaysDepth,THREE.AddEquation,THREE.SubtractEquation,THREE.ReverseSubtractEquation,THREE.ZeroFactor,THREE.OneFactor,THREE.SrcColorFactor,THREE.OneMinusSrcColorFactor,THREE.SrcAlphaFactor,THREE.OneMinusSrcAlphaFactor,THREE.DstAlphaFactor,THREE.OneMinusDstAlphaFactor,THREE.DstColorFactor,THREE.OneMinusDstColorFactor,THREE.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),M={POSITION:"position",NORMAL:"normal",TEXCOORD_0:"uv",TEXCOORD0:"uv",TEXCOORD:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",COLOR0:"color",COLOR:"color",WEIGHTS_0:"skinWeight",WEIGHT:"skinWeight",JOINTS_0:"skinIndex",JOINT:"skinIndex"},S={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},H={CUBICSPLINE:THREE.InterpolateSmooth,LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete},y="OPAQUE",L="MASK",x="BLEND";function A(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e}function w(e,t,a,r){var s=e.geometry,n=e.material,i=a.targets,o=s.morphAttributes;o.position=[],o.normal=[],n.morphTargets=!0;for(var l=0,p=i.length;l<p;l++){var u,c,d=i[l],E="morphTarget"+l;if(void 0!==d.POSITION){u=I(r[d.POSITION]);for(var h=s.attributes.position,m=0,f=u.count;m<f;m++)u.setXYZ(m,u.getX(m)+h.getX(m),u.getY(m)+h.getY(m),u.getZ(m)+h.getZ(m))}else s.attributes.position&&(u=I(s.attributes.position));if(void 0!==u&&(u.name=E,o.position.push(u)),void 0!==d.NORMAL){n.morphNormals=!0,c=I(r[d.NORMAL]);var v=s.attributes.normal;for(m=0,f=c.count;m<f;m++)c.setXYZ(m,c.getX(m)+v.getX(m),c.getY(m)+v.getY(m),c.getZ(m)+v.getZ(m))}else void 0!==s.attributes.normal&&(c=I(s.attributes.normal));void 0!==c&&(c.name=E,o.normal.push(c))}if(e.updateMorphTargets(),void 0!==t.weights)for(l=0,p=t.weights.length;l<p;l++)e.morphTargetInfluences[l]=t.weights[l];if(t.extras&&Array.isArray(t.extras.targetNames))for(l=0,p=t.extras.targetNames.length;l<p;l++)e.morphTargetDictionary[t.extras.targetNames[l]]=l}function _(e,t){if(e.indices!==t.indices)return!1;var a=e.attributes||{},r=t.attributes||{},s=Object.keys(a),n=Object.keys(r);if(s.length!==n.length)return!1;for(var i=0,o=s.length;i<o;i++){var l=s[i];if(a[l]!==r[l])return!1}return!0}function b(e,t){for(var a=0,r=e.length;a<r;a++){var s=e[a];if(_(s.primitive,t))return s.promise}return null}function I(e){if(e.isInterleavedBufferAttribute){for(var t=e.count,a=e.itemSize,r=e.array.slice(0,t*a),s=0;s<t;++s)r[s]=e.getX(s),a>=2&&(r[s+1]=e.getY(s)),a>=3&&(r[s+2]=e.getZ(s)),a>=4&&(r[s+3]=e.getW(s));return new THREE.BufferAttribute(r,a,e.normalized)}return e.clone()}function F(e,t,a){this.json=e||{},this.extensions=t||{},this.options=a||{},this.cache=new function(){var e={};return{get:function(t){return e[t]},add:function(t,a){e[t]=a},remove:function(t){delete e[t]},removeAll:function(){e={}}}},this.primitiveCache=[],this.textureLoader=new THREE.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new THREE.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function G(e,t,a){var r=t.attributes;for(var s in r){var n=M[s],i=a[r[s]];n&&(n in e.attributes||e.addAttribute(n,i))}void 0===t.indices||e.index||e.setIndex(a[t.indices])}return F.prototype.parse=function(e,t){var a=this.json;this.cache.removeAll(),this.markDefs(),this.getMultiDependencies(["scene","animation","camera"]).then(function(t){var r=t.scenes||[],s=r[a.scene||0],n=t.animations||[],i=a.asset,o=t.cameras||[];e(s,r,o,n,i)}).catch(t)},F.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],a=this.json.meshes||[],r={},s={},n=0,i=t.length;n<i;n++)for(var o=t[n].joints,l=0,p=o.length;l<p;l++)e[o[l]].isBone=!0;for(var u=0,c=e.length;u<c;u++){var d=e[u];void 0!==d.mesh&&(void 0===r[d.mesh]&&(r[d.mesh]=s[d.mesh]=0),r[d.mesh]++,void 0!==d.skin&&(a[d.mesh].isSkinnedMesh=!0))}this.json.meshReferences=r,this.json.meshUses=s},F.prototype.getDependency=function(e,t){var a=e+":"+t,r=this.cache.get(a);r||(r=this["load"+e.charAt(0).toUpperCase()+e.slice(1)](t),this.cache.add(a,r));return r},F.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var a=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map(function(t,r){return a.getDependency(e,r)})),this.cache.add(e,t)}return t},F.prototype.getMultiDependencies=function(e){for(var t={},a=[],r=0,s=e.length;r<s;r++){var n=e[r],i=this.getDependencies(n);i=i.then(function(e,a){t[e]=a}.bind(this,n+("mesh"===n?"es":"s"))),a.push(i)}return Promise.all(a).then(function(){return t})},F.prototype.loadBuffer=function(e){var a=this.json.buffers[e],r=this.fileLoader;if(a.type&&"arraybuffer"!==a.type)throw new Error("THREE.GLTFLoader: "+a.type+" buffer type is not supported.");if(void 0===a.uri&&0===e)return Promise.resolve(this.extensions[t.KHR_BINARY_GLTF].body);var s=this.options;return new Promise(function(e,t){r.load(A(a.uri,s.path),e,void 0,function(){t(new Error('THREE.GLTFLoader: Failed to load buffer "'+a.uri+'".'))})})},F.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var a=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+a)})},F.prototype.loadAccessor=function(e){var t=this,a=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse)return null;var s=[];return void 0!==r.bufferView?s.push(this.getDependency("bufferView",r.bufferView)):s.push(null),void 0!==r.sparse&&(s.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(s).then(function(e){var s,n,i=e[0],o=g[r.type],l=m[r.componentType],p=l.BYTES_PER_ELEMENT,u=p*o,c=r.byteOffset||0,d=a.bufferViews[r.bufferView].byteStride,E=!0===r.normalized;if(d&&d!==u){var h="InterleavedBuffer:"+r.bufferView+":"+r.componentType,f=t.cache.get(h);f||(s=new l(i),f=new THREE.InterleavedBuffer(s,d/p),t.cache.add(h,f)),n=new THREE.InterleavedBufferAttribute(f,o,c/p,E)}else s=null===i?new l(r.count*o):new l(i,c,r.count*o),n=new THREE.BufferAttribute(s,o,E);if(void 0!==r.sparse){var v=g.SCALAR,T=m[r.sparse.indices.componentType],R=r.sparse.indices.byteOffset||0,M=r.sparse.values.byteOffset||0,S=new T(e[1],R,r.sparse.count*v),H=new l(e[2],M,r.sparse.count*o);null!==i&&n.setArray(n.array.slice());for(var y=0,L=S.length;y<L;y++){var x=S[y];if(n.setX(x,H[y*o]),o>=2&&n.setY(x,H[y*o+1]),o>=3&&n.setZ(x,H[y*o+2]),o>=4&&n.setW(x,H[y*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return n})},F.prototype.loadTexture=function(e){var t=this.json,a=this.options,r=this.textureLoader,s=window.URL||window.webkitURL,n=t.textures[e],i=t.images[n.source],o=i.uri,l=!1;return void 0!==i.bufferView&&(o=this.getDependency("bufferView",i.bufferView).then(function(e){l=!0;var t=new Blob([e],{type:i.mimeType});return o=s.createObjectURL(t)})),Promise.resolve(o).then(function(e){var t=THREE.Loader.Handlers.get(e)||r;return new Promise(function(r,s){t.load(A(e,a.path),r,void 0,s)})}).then(function(e){!0===l&&s.revokeObjectURL(o),e.flipY=!1,void 0!==n.name&&(e.name=n.name),e.format=void 0!==n.format?T[n.format]:THREE.RGBAFormat,void 0!==n.internalFormat&&e.format!==T[n.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js does not support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),e.type=void 0!==n.type?R[n.type]:THREE.UnsignedByteType;var a=(t.samplers||{})[n.sampler]||{};return e.magFilter=f[a.magFilter]||THREE.LinearFilter,e.minFilter=f[a.minFilter]||THREE.LinearMipMapLinearFilter,e.wrapS=v[a.wrapS]||THREE.RepeatWrapping,e.wrapT=v[a.wrapT]||THREE.RepeatWrapping,e})},F.prototype.assignTexture=function(e,t,a){return this.getDependency("texture",a).then(function(a){e[t]=a})},F.prototype.loadMaterial=function(e){var a,r=this,s=(this.json,this.extensions),n=this.json.materials[e],i={},o=n.extensions||{},l=[];if(o[t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var p=s[t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=p.getMaterialType(n),l.push(p.extendParams(i,n,r))}else if(o[t.KHR_MATERIALS_UNLIT]){var u=s[t.KHR_MATERIALS_UNLIT];a=u.getMaterialType(n),l.push(u.extendParams(i,n,r))}else if(void 0!==n.pbrMetallicRoughness){a=THREE.MeshStandardMaterial;var c=n.pbrMetallicRoughness;if(i.color=new THREE.Color(1,1,1),i.opacity=1,Array.isArray(c.baseColorFactor)){var d=c.baseColorFactor;i.color.fromArray(d),i.opacity=d[3]}if(void 0!==c.baseColorTexture&&l.push(r.assignTexture(i,"map",c.baseColorTexture.index)),i.metalness=void 0!==c.metallicFactor?c.metallicFactor:1,i.roughness=void 0!==c.roughnessFactor?c.roughnessFactor:1,void 0!==c.metallicRoughnessTexture){var E=c.metallicRoughnessTexture.index;l.push(r.assignTexture(i,"metalnessMap",E)),l.push(r.assignTexture(i,"roughnessMap",E))}}else a=THREE.MeshPhongMaterial;!0===n.doubleSided&&(i.side=THREE.DoubleSide);var h=n.alphaMode||y;return h===x?i.transparent=!0:(i.transparent=!1,h===L&&(i.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&a!==THREE.MeshBasicMaterial&&(l.push(r.assignTexture(i,"normalMap",n.normalTexture.index)),i.normalScale=new THREE.Vector2(1,1),void 0!==n.normalTexture.scale&&i.normalScale.set(n.normalTexture.scale,n.normalTexture.scale)),void 0!==n.occlusionTexture&&a!==THREE.MeshBasicMaterial&&(l.push(r.assignTexture(i,"aoMap",n.occlusionTexture.index)),void 0!==n.occlusionTexture.strength&&(i.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&a!==THREE.MeshBasicMaterial&&(i.emissive=(new THREE.Color).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&a!==THREE.MeshBasicMaterial&&l.push(r.assignTexture(i,"emissiveMap",n.emissiveTexture.index)),Promise.all(l).then(function(){var e;return e=a===THREE.ShaderMaterial?s[t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(i):new a(i),void 0!==n.name&&(e.name=n.name),e.normalScale&&(e.normalScale.x=-e.normalScale.x),e.map&&(e.map.encoding=THREE.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=THREE.sRGBEncoding),n.extras&&(e.userData=n.extras),e})},F.prototype.loadGeometries=function(e){var a=this,r=this.extensions,s=this.primitiveCache;return this.getDependencies("accessor").then(function(n){for(var i=[],o=[],l=0,p=e.length;l<p;l++){var u,c=e[l],d=b(s,c);if(d)o.push(d.then(function(e){i.push(e)}));else if(c.extensions&&c.extensions[t.KHR_DRACO_MESH_COMPRESSION]){var E=r[t.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(c,a).then(function(e){return G(e,c,n),i.push(e),e});s.push({primitive:c,promise:E}),o.push(E)}else G(u=new THREE.BufferGeometry,c,n),s.push({primitive:c,promise:Promise.resolve(u)}),i.push(u)}return Promise.all(o).then(function(){return i})})},F.prototype.loadMesh=function(e){var a=this,r=(this.json,this.extensions),s=this.json.meshes[e];return this.getMultiDependencies(["accessor","material"]).then(function(n){var i=new THREE.Group,o=s.primitives;return a.loadGeometries(o).then(function(m){for(var f=0,v=o.length;f<v;f++){var T=o[f],R=m[f],g=void 0===T.material?new THREE.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:THREE.FrontSide}):n.materials[T.material];g.aoMap&&void 0===R.attributes.uv2&&void 0!==R.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),R.addAttribute("uv2",new THREE.BufferAttribute(R.attributes.uv.array,2)));var M,S=void 0!==R.attributes.color,H=void 0===R.attributes.normal,y=!0===s.isSkinnedMesh,L=void 0!==T.targets;if(S||H||y||L)if(g.isGLTFSpecularGlossinessMaterial)g=r[t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(g);else g=g.clone();if(S&&(g.vertexColors=THREE.VertexColors,g.needsUpdate=!0),H&&(g.flatShading=!0),T.mode===d||T.mode===E||T.mode===h||void 0===T.mode)y?(M=new THREE.SkinnedMesh(R,g),g.skinning=!0):M=new THREE.Mesh(R,g),T.mode===E?M.drawMode=THREE.TriangleStripDrawMode:T.mode===h&&(M.drawMode=THREE.TriangleFanDrawMode);else if(T.mode===p||T.mode===c||T.mode===u){var x="LineBasicMaterial:"+g.uuid,A=a.cache.get(x);A||(A=new THREE.LineBasicMaterial,THREE.Material.prototype.copy.call(A,g),A.color.copy(g.color),A.lights=!1,a.cache.add(x,A)),g=A,M=T.mode===p?new THREE.LineSegments(R,g):T.mode===c?new THREE.Line(R,g):new THREE.LineLoop(R,g)}else{if(T.mode!==l)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+T.mode);x="PointsMaterial:"+g.uuid;var _=a.cache.get(x);_||(_=new THREE.PointsMaterial,THREE.Material.prototype.copy.call(_,g),_.color.copy(g.color),_.map=g.map,_.lights=!1,a.cache.add(x,_)),g=_,M=new THREE.Points(R,g)}if(M.name=s.name||"mesh_"+e,L&&w(M,s,T,n.accessors),void 0!==s.extras&&(M.userData=s.extras),void 0!==T.extras&&(M.geometry.userData=T.extras),!0===g.isGLTFSpecularGlossinessMaterial&&(M.onBeforeRender=r[t.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),!(o.length>1))return M;M.name+="_"+f,i.add(M)}return i})})},F.prototype.loadCamera=function(e){var t,a=this.json.cameras[e],r=a[a.type];if(r){if("perspective"===a.type){var s=r.aspectRatio||1,n=r.yfov*s;t=new THREE.PerspectiveCamera(THREE.Math.radToDeg(n),s,r.znear||1,r.zfar||2e6)}else"orthographic"===a.type&&(t=new THREE.OrthographicCamera(r.xmag/-2,r.xmag/2,r.ymag/2,r.ymag/-2,r.znear,r.zfar));return void 0!==a.name&&(t.name=a.name),a.extras&&(t.userData=a.extras),Promise.resolve(t)}console.warn("THREE.GLTFLoader: Missing camera parameters.")},F.prototype.loadSkin=function(e){var t=this.json.skins[e],a={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(a):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return a.inverseBindMatrices=e,a})},F.prototype.loadAnimation=function(e){this.json;var t=this.json.animations[e];return this.getMultiDependencies(["accessor","node"]).then(function(a){for(var r=[],s=0,n=t.channels.length;s<n;s++){var i=t.channels[s],l=t.samplers[i.sampler];if(l){var p=i.target,u=void 0!==p.node?p.node:p.id,c=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output,E=a.accessors[c],h=a.accessors[d],m=a.nodes[u];if(m){var f;switch(m.updateMatrix(),m.matrixAutoUpdate=!0,S[p.path]){case S.weights:f=THREE.NumberKeyframeTrack;break;case S.rotation:f=THREE.QuaternionKeyframeTrack;break;case S.position:case S.scale:default:f=THREE.VectorKeyframeTrack}var v=m.name?m.name:m.uuid,T=void 0!==l.interpolation?H[l.interpolation]:THREE.InterpolateLinear,R=[];S[p.path]===S.weights?m.traverse(function(e){!0===e.isMesh&&!0===e.material.morphTargets&&R.push(e.name?e.name:e.uuid)}):R.push(v);for(var g=0,M=R.length;g<M;g++){var y=new f(R[g]+"."+S[p.path],THREE.AnimationUtils.arraySlice(E.array,0),THREE.AnimationUtils.arraySlice(h.array,0),T);"CUBICSPLINE"===l.interpolation&&(y.createInterpolant=function(e){return new o(this.times,this.values,this.getValueSize()/3,e)},y.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),r.push(y)}}}}u=void 0!==t.name?t.name:"animation_"+e;return new THREE.AnimationClip(u,void 0,r)})},F.prototype.loadNode=function(e){this.json;var a=this.extensions,r=this.json.meshReferences,s=this.json.meshUses,n=this.json.nodes[e];return this.getMultiDependencies(["mesh","skin","camera"]).then(function(e){var i;if(!0===n.isBone)i=new THREE.Bone;else if(void 0!==n.mesh){var o=e.meshes[n.mesh];if(i=o.clone(),!0===o.isGroup)for(var l=0,p=o.children.length;l<p;l++){var u=o.children[l];u.material&&!0===u.material.isGLTFSpecularGlossinessMaterial&&(i.children[l].onBeforeRender=u.onBeforeRender)}else o.material&&!0===o.material.isGLTFSpecularGlossinessMaterial&&(i.onBeforeRender=o.onBeforeRender);r[n.mesh]>1&&(i.name+="_instance_"+s[n.mesh]++)}else if(void 0!==n.camera)i=e.cameras[n.camera];else if(n.extensions&&n.extensions[t.KHR_LIGHTS]&&void 0!==n.extensions[t.KHR_LIGHTS].light){i=a[t.KHR_LIGHTS].lights[n.extensions[t.KHR_LIGHTS].light]}else i=new THREE.Object3D;if(void 0!==n.name&&(i.name=THREE.PropertyBinding.sanitizeNodeName(n.name)),n.extras&&(i.userData=n.extras),void 0!==n.matrix){var c=new THREE.Matrix4;c.fromArray(n.matrix),i.applyMatrix(c)}else void 0!==n.translation&&i.position.fromArray(n.translation),void 0!==n.rotation&&i.quaternion.fromArray(n.rotation),void 0!==n.scale&&i.scale.fromArray(n.scale);return i})},F.prototype.loadScene=function(){function e(t,a,r,s,n){var i=s[t],o=r.nodes[t];if(void 0!==o.skin)for(var l=!0===i.isGroup?i.children:[i],p=0,u=l.length;p<u;p++){for(var c=l[p],d=n[o.skin],E=[],h=[],m=0,f=d.joints.length;m<f;m++){var v=d.joints[m],T=s[v];if(T){E.push(T);var R=new THREE.Matrix4;void 0!==d.inverseBindMatrices&&R.fromArray(d.inverseBindMatrices.array,16*m),h.push(R)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',v)}c.bind(new THREE.Skeleton(E,h),c.matrixWorld)}if(a.add(i),o.children){var g=o.children;for(p=0,u=g.length;p<u;p++){e(g[p],i,r,s,n)}}}return function(a){var r=this.json,s=this.extensions,n=this.json.scenes[a];return this.getMultiDependencies(["node","skin"]).then(function(a){var i=new THREE.Scene;void 0!==n.name&&(i.name=n.name),n.extras&&(i.userData=n.extras);for(var o=n.nodes||[],l=0,p=o.length;l<p;l++)e(o[l],i,r,a.nodes,a.skins);if(n.extensions&&n.extensions[t.KHR_LIGHTS]&&void 0!==n.extensions[t.KHR_LIGHTS].light){var u=s[t.KHR_LIGHTS].lights;i.add(u[n.extensions[t.KHR_LIGHTS].light])}return i})}}(),e}();