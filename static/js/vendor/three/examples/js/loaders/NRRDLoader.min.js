THREE.NRRDLoader=function(r){this.manager=void 0!==r?r:THREE.DefaultLoadingManager},THREE.NRRDLoader.prototype={constructor:THREE.NRRDLoader,load:function(r,e,t,n){var a=this,s=new THREE.FileLoader(a.manager);s.setResponseType("arraybuffer"),s.load(r,function(r){e(a.parse(r))},t,n)},parse:function(r){var e=r,t=0,n=new Int8Array(new Int16Array([1]).buffer)[0]>0,a=!0,s={};var i=function(r,s){void 0!==s&&null!==s||(s=1);var i=1,o=Uint8Array;switch(r){case"uchar":break;case"schar":o=Int8Array;break;case"ushort":o=Uint16Array,i=2;break;case"sshort":o=Int16Array,i=2;break;case"uint":o=Uint32Array,i=4;break;case"sint":o=Int32Array,i=4;break;case"float":o=Float32Array,i=4;break;case"complex":case"double":o=Float64Array,i=8}var c=new o(e.slice(t,t+=s*i));return n!=a&&(c=function(r,e){for(var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=0;n<r.byteLength;n+=e)for(var a=n+e-1,s=n;a>s;a--,s++){var i=t[s];t[s]=t[a],t[a]=i}return r}(c,i)),1==s?c[0]:c}("uchar",r.byteLength),o=i.length,c=null,u=0;for(d=1;d<o;d++)if(10==i[d-1]&&10==i[d]){c=this.parseChars(i,0,d-2),u=d+1;break}!function(r){var e,t,n,a,i,o,c,u,h;for(u=0,h=(o=r.split(/\r?\n/)).length;u<h;u++)(i=o[u]).match(/NRRD\d+/)?s.isNrrd=!0:i.match(/^#/)||(c=i.match(/(.*):(.*)/))&&(t=c[1].trim(),e=c[2].trim(),(n=THREE.NRRDLoader.prototype.fieldFunctions[t])?n.call(s,e):s[t]=e);if(!s.isNrrd)throw new Error("Not an NRRD file");if("bz2"===s.encoding||"bzip2"===s.encoding)throw new Error("Bzip is not supported");if(!s.vectors&&(s.vectors=[new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)],s.spacings))for(a=0;a<=2;a++)isNaN(s.spacings[a])||s.vectors[a].multiplyScalar(s.spacings[a])}(c);e=i.subarray(u);if("gzip"===s.encoding||"gz"===s.encoding){var h=new Zlib.Gunzip(new Uint8Array(e));e=h.decompress()}else if("ascii"===s.encoding||"text"===s.encoding||"txt"===s.encoding||"hex"===s.encoding)e=function(r,e,t){var n,a="";e=e||0,t=t||r.length;var i=s.sizes.reduce(function(r,e){return r*e},1),o=10;"hex"===s.encoding&&(o=16);var c=new s.__array(i),u=0,h=parseInt;s.__array!==Float32Array&&s.__array!==Float64Array||(h=parseFloat);for(var l=e;l<t;l++)((n=r[l])<9||n>13)&&32!==n?a+=String.fromCharCode(n):(""!==a&&(c[u]=h(a,o),u++),a="");return""!==a&&(c[u]=h(a,o),u++),c}(e);else if("raw"===s.encoding){for(var l=new Uint8Array(e.length),d=0;d<e.length;d++)l[d]=e[d];e=l}e=e.buffer;var p=new THREE.Volume;p.header=s,p.data=new s.__array(e);var f=p.computeMinMax(),g=f[0],y=f[1];p.windowLow=g,p.windowHigh=y,p.dimensions=[s.sizes[0],s.sizes[1],s.sizes[2]],p.xLength=p.dimensions[0],p.yLength=p.dimensions[1],p.zLength=p.dimensions[2];var v=new THREE.Vector3(s.vectors[0][0],s.vectors[0][1],s.vectors[0][2]).length(),w=new THREE.Vector3(s.vectors[1][0],s.vectors[1][1],s.vectors[1][2]).length(),E=new THREE.Vector3(s.vectors[2][0],s.vectors[2][1],s.vectors[2][2]).length();p.spacing=[v,w,E],p.matrix=new THREE.Matrix4;var R=1,b=1;if("left-posterior-superior"==s.space?(R=-1,b=-1):"left-anterior-superior"===s.space&&(R=-1),s.vectors){var _=s.vectors;p.matrix.set(R*_[0][0],R*_[1][0],R*_[2][0],0,b*_[0][1],b*_[1][1],b*_[2][1],0,1*_[0][2],1*_[1][2],1*_[2][2],0,0,0,0,1)}else p.matrix.set(R,0,0,0,0,b,0,0,0,0,1,0,0,0,0,1);return p.inverseMatrix=new THREE.Matrix4,p.inverseMatrix.getInverse(p.matrix),p.RASDimensions=new THREE.Vector3(p.xLength,p.yLength,p.zLength).applyMatrix4(p.matrix).round().toArray().map(Math.abs),p.lowerThreshold===-1/0&&(p.lowerThreshold=g),p.upperThreshold===1/0&&(p.upperThreshold=y),p},parseChars:function(r,e,t){void 0===e&&(e=0),void 0===t&&(t=r.length);var n="",a=0;for(a=e;a<t;++a)n+=String.fromCharCode(r[a]);return n},fieldFunctions:{type:function(r){switch(r){case"uchar":case"unsigned char":case"uint8":case"uint8_t":this.__array=Uint8Array;break;case"signed char":case"int8":case"int8_t":this.__array=Int8Array;break;case"short":case"short int":case"signed short":case"signed short int":case"int16":case"int16_t":this.__array=Int16Array;break;case"ushort":case"unsigned short":case"unsigned short int":case"uint16":case"uint16_t":this.__array=Uint16Array;break;case"int":case"signed int":case"int32":case"int32_t":this.__array=Int32Array;break;case"uint":case"unsigned int":case"uint32":case"uint32_t":this.__array=Uint32Array;break;case"float":this.__array=Float32Array;break;case"double":this.__array=Float64Array;break;default:throw new Error("Unsupported NRRD data type: "+r)}return this.type=r},endian:function(r){return this.endian=r},encoding:function(r){return this.encoding=r},dimension:function(r){return this.dim=parseInt(r,10)},sizes:function(r){var e;return this.sizes=function(){var t,n,a,s;for(s=[],t=0,n=(a=r.split(/\s+/)).length;t<n;t++)e=a[t],s.push(parseInt(e,10));return s}()},space:function(r){return this.space=r},"space origin":function(r){return this.space_origin=r.split("(")[1].split(")")[0].split(",")},"space directions":function(r){var e,t,n;return t=r.match(/\(.*?\)/g),this.vectors=function(){var r,a,s;for(s=[],r=0,a=t.length;r<a;r++)n=t[r],s.push(function(){var r,t,a,s;for(s=[],r=0,t=(a=n.slice(1,-1).split(/,/)).length;r<t;r++)e=a[r],s.push(parseFloat(e));return s}());return s}()},spacings:function(r){var e,t;return t=r.split(/\s+/),this.spacings=function(){var r,n,a=[];for(r=0,n=t.length;r<n;r++)e=t[r],a.push(parseFloat(e));return a}()}}};