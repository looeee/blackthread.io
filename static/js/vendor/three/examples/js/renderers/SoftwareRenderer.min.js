THREE.SoftwareRenderer=function(e){console.log("THREE.SoftwareRenderer",THREE.REVISION);var t,a,r,o,l,i,n,f,c,s,h,m,v,d,p,u,M=void 0!==(e=e||{}).canvas?e.canvas:document.createElement("canvas"),E=M.getContext("2d",{alpha:!0===e.alpha}),x=e.alpha,y={},w={},R=new THREE.Color(0),g=1,T=2,b=4,H=(1<<b)-1,S=3,z=1<<S,N=1<<24,O=!1,V=new THREE.Vector3(0,0,1),I=new THREE.Vector3,C=1/0,B=1/0,A=0,j=0,F=1/0,U=1/0,P=0,k=0,q=new THREE.Projector,D=new THREE.Vector4,L=new THREE.Vector4,G=new THREE.Vector4,J=new THREE.Vector2,K=new THREE.Vector2,Q=new THREE.Vector2,W=[],X=0,Y=[],Z=0,$=[],_=0;function ee(e){for(var r=t*a*4,o=0;o<r;o+=4)m[o]=255*e.r|0,m[o+1]=255*e.g|0,m[o+2]=255*e.b|0,m[o+3]=x?0:255;E.fillStyle=x?"rgba(0, 0, 0, 0)":e.getStyle(),E.fillRect(0,0,t,a)}function te(e,t){var a=0,r=0,o=255*e.color.r,l=255*e.color.g,i=255*e.color.b,n=new Uint8Array(768);if(t){for(;a<204;)n[r++]=Math.min(a*o/204,255),n[r++]=Math.min(a*l/204,255),n[r++]=Math.min(a*i/204,255),++a;for(;a<256;)n[r++]=Math.min(o+(a-204)*(255-o)/82,255),n[r++]=Math.min(l+(a-204)*(255-l)/82,255),n[r++]=Math.min(i+(a-204)*(255-i)/82,255),++a}else for(;a<256;)n[r++]=Math.min(a*o/255,255),n[r++]=Math.min(a*l/255,255),n[r++]=Math.min(a*i/255,255),++a;return n}function ae(e,t,a,r,o,l,i,n,f){var c=4*a,s=w[f.map.id];if(s.data){var h=s.width,m=f.transparent,v=h-1,d=s.data,p=4*((l*h&v)*h+(o*h&v));if(m){var u=d[p],M=d[p+1],E=d[p+2],x=d[p+3]*f.opacity/255,y=e[c],R=e[c+1],g=e[c+2];e[c]=u*x+y*(1-x),e[c+1]=M*x+R*(1-x),e[c+2]=E*x+g*(1-x),e[c+3]=(f.opacity<<8)-1,255==e[c+3]&&(t[a]=r)}else e[c]=d[p],e[c+1]=d[p+1],e[c+2]=d[p+2],e[c+3]=(f.opacity<<8)-1,t[a]=r}}function re(e,t,a,r,o,l,i,n,f){var c=4*a,s=w[f.map.id];if(s.data){var h=s.width,m=f.transparent,v=3*(i>0?~~i:0),d=h-1,p=s.data,u=4*((l*h&d)*h+(o*h&d));if(m){var M=f.palette[v]*p[u],E=f.palette[v+1]*p[u+1],x=f.palette[v+2]*p[u+2],y=p[u+3]*f.opacity/256,R=e[c],g=e[c+1],T=e[c+2];e[c]=M*y+R*(1-y),e[c+1]=E*y+g*(1-y),e[c+2]=x*y+T*(1-y),e[c+3]=(f.opacity<<8)-1,255==e[c+3]&&(t[a]=r)}else e[c]=f.palette[v]*p[u]>>8,e[c+1]=f.palette[v+1]*p[u+1]>>8,e[c+2]=f.palette[v+2]*p[u+2]>>8,e[c+3]=(f.opacity<<8)-1,t[a]=r}}function oe(e){var t=e.id,a=y[t];if(a&&e.map&&!w[e.map.id]&&delete y[t],void 0===y[t]||!0===e.needsUpdate){if(e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial||e instanceof THREE.SpriteMaterial)if(e instanceof THREE.MeshLambertMaterial?e.palette||(e.palette=te(e,!1)):e instanceof THREE.MeshPhongMaterial&&(e.palette||(e.palette=te(e,!0))),e.map){var r=new THREE.SoftwareRenderer.Texture;if(r.fromImage(e.map.image),!r.data)return;w[e.map.id]=r,a=e instanceof THREE.MeshBasicMaterial||e instanceof THREE.SpriteMaterial?ae:re}else o=e.vertexColors===THREE.FaceColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),a=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",o);else if(e instanceof THREE.LineBasicMaterial){var o=["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * (color1.r+color2.r) * 0.5 * 255;","buffer[ colorOffset + 1 ] = material.color.g * (color1.g+color2.g) * 0.5 * 255;","buffer[ colorOffset + 2 ] = material.color.b * (color1.b+color2.b) * 0.5 * 255;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");a=new Function("buffer, depthBuf, offset, depth, color1, color2, material",o)}else{o=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");a=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",o)}y[t]=a,e.needsUpdate=!1}return a}function le(e,o,h,d,M,E,x,y,w){if(!(e.z<-1||e.z>1||o.z<-1||o.z>1||h.z<-1||h.z>1)){var R=1<<b,N=e.x*l+f|0,O=o.x*l+f|0,V=h.x*l+f|0,I=e.y*i+c|0,F=o.y*i+c|0,U=h.y*i+c|0,P=y.vertexNormalsModel&&y.vertexNormalsModel.length,k=d&&M&&E,q=Math.max(Math.sqrt((N-O)*(N-O)+(I-F)*(I-F)),Math.sqrt((O-V)*(O-V)+(F-U)*(F-U)),Math.sqrt((V-N)*(V-N)+(U-I)*(U-I)));if(!(y instanceof THREE.RenderableSprite)&&q>100*R){var D,L,G,J,K,Q,ee,te,ae,re,oe={vertexNormalsModel:[],color:y.color};if(k)_===$.length?(D=new THREE.Vector2,$.push(D),++_,L=new THREE.Vector2,$.push(L),++_,G=new THREE.Vector2,$.push(G),++_):(D=$[_],L=$[++_],G=$[++_],++_),J=(1+o.z)*(o.w/e.w)/(1+e.z),D.copy(d).multiplyScalar(J).add(M).multiplyScalar(1/(J+1)),J=(1+h.z)*(h.w/o.w)/(1+o.z),L.copy(M).multiplyScalar(J).add(E).multiplyScalar(1/(J+1)),J=(1+e.z)*(e.w/h.w)/(1+h.z),G.copy(E).multiplyScalar(J).add(d).multiplyScalar(1/(J+1));return X===W.length?(K=new THREE.Vector4,W.push(K),++X,Q=new THREE.Vector4,W.push(Q),++X,ee=new THREE.Vector4,W.push(ee),++X):(K=W[X],Q=W[++X],ee=W[++X],++X),K.copy(e).add(o).multiplyScalar(.5),Q.copy(o).add(h).multiplyScalar(.5),ee.copy(h).add(e).multiplyScalar(.5),P&&(Z===Y.length?(te=new THREE.Vector3,Y.push(te),++Z,ae=new THREE.Vector3,Y.push(ae),++Z,re=new THREE.Vector3,Y.push(re),++Z):(te=Y[Z],ae=Y[++Z],re=Y[++Z],++Z),te.copy(y.vertexNormalsModel[0]).add(y.vertexNormalsModel[1]).normalize(),ae.copy(y.vertexNormalsModel[1]).add(y.vertexNormalsModel[2]).normalize(),re.copy(y.vertexNormalsModel[2]).add(y.vertexNormalsModel[0]).normalize()),P&&(oe.vertexNormalsModel[0]=y.vertexNormalsModel[0],oe.vertexNormalsModel[1]=te,oe.vertexNormalsModel[2]=re),le(e,K,ee,d,D,G,x,oe,w),P&&(oe.vertexNormalsModel[0]=y.vertexNormalsModel[1],oe.vertexNormalsModel[1]=ae,oe.vertexNormalsModel[2]=te),le(o,Q,K,M,L,D,x,oe,w),P&&(oe.vertexNormalsModel[0]=te,oe.vertexNormalsModel[1]=ae,oe.vertexNormalsModel[2]=re),le(K,Q,ee,D,L,G,x,oe,w),P&&(oe.vertexNormalsModel[0]=y.vertexNormalsModel[2],oe.vertexNormalsModel[1]=re,oe.vertexNormalsModel[2]=ae),void le(h,ee,Q,E,G,L,x,oe,w)}var ie,fe,ce,se,he,me,ve,de,pe,ue,Me,Ee,xe=e.z*n+s|0,ye=o.z*n+s|0,we=h.z*n+s|0;k=!1;d&&M&&E&&(k=!0,ie=d.x,fe=1-d.y,ce=M.x,se=1-M.y,he=E.x,me=1-E.y),P&&(ve=y.vertexNormalsModel[0],de=y.vertexNormalsModel[1],pe=y.vertexNormalsModel[2],ue=255*ve.z,Me=255*de.z,Ee=255*pe.z);var Re=N-O,ge=F-I,Te=O-V,be=U-F,He=V-N,Se=I-U,ze=Math.max(Math.min(N,O,V)+H>>b,0),Ne=Math.min(Math.max(N,O,V)+H>>b,t),Oe=Math.max(Math.min(I,F,U)+H>>b,0),Ve=Math.min(Math.max(I,F,U)+H>>b,a);C=Math.min(ze,C),A=Math.max(Ne,A),B=Math.min(Oe,B),j=Math.max(Ve,j);var Ie=z,Ce=(ze&=~(Ie-1))<<b,Be=(Oe&=~(Ie-1))<<b,Ae=ge*(Ce-N)+Re*(Be-I),je=be*(Ce-O)+Te*(Be-F),Fe=Se*(Ce-V)+He*(Be-U);(ge>0||0==ge&&Re>0)&&Ae++,(be>0||0==be&&Te>0)&&je++,(Se>0||0==Se&&He>0)&&Fe++,Ae=Ae-1>>b,je=je-1>>b,Fe=Fe-1>>b;var Ue,Pe,ke,qe,De,Le=xe-ye,Ge=we-xe,Je=1/(Re*Se-He*ge),Ke=Je*(Le*Se-Ge*ge),Qe=Je*(Le*He-Re*Ge),We=xe+(Ce-N)*Ke+(Be-I)*Qe|0;if(Ke=Ke*R|0,Qe=Qe*R|0,k){var Xe=ie-ce,Ye=he-ie,Ze=Je*(Xe*Se-Ye*ge),$e=Je*(Xe*He-Re*Ye),_e=fe-se,et=me-fe;ke=ie+(Ce-N)*Ze+(Be-I)*$e,qe=fe+(Ce-N)*(Ue=Je*(_e*Se-et*ge))+(Be-I)*(Pe=Je*(_e*He-Re*et)),Ze*=R,$e*=R,Ue*=R,Pe*=R}if(P){var tt,at=ue-Me,rt=Ee-ue,ot=Je*(at*Se-rt*ge);De=ue+(Ce-N)*ot+(Be-I)*(tt=Je*(at*He-Re*rt)),ot*=R,tt*=R}var lt=Ie-1,it=0,nt=0,ft=0,ct=0,st=0,ht=0,mt=0,vt=0;Re>=0?nt-=lt*Re:it-=lt*Re,ge>=0?nt-=lt*ge:it-=lt*ge,Te>=0?ct-=lt*Te:ft-=lt*Te,be>=0?ct-=lt*be:ft-=lt*be,He>=0?ht-=lt*He:st-=lt*He,Se>=0?ht-=lt*Se:st-=lt*Se,Ke>=0?vt+=lt*Ke:mt+=lt*Ke,Qe>=0?vt+=lt*Qe:mt+=lt*Qe;var dt,pt,ut,Mt=t-Ie,Et=Ae,xt=je,yt=Fe,wt=We,Rt=-Ie,gt=Rt*ge,Tt=Rt*be,bt=Rt*Se,Ht=Rt*Ke;k&&(dt=Rt*Ze,pt=Rt*Ue),P&&(ut=Rt*ot);for(var St=ze,zt=Oe;zt<Ve;zt+=Ie){for(;St>=ze&&St<Ne&&Et>=nt&&xt>=ct&&yt>=ht;)St+=Rt,Et+=gt,xt+=Tt,yt+=bt,wt+=Ht,k&&(ke+=dt,qe+=pt),P&&(De+=ut);for(Rt=-Rt,gt=-gt,Tt=-Tt,bt=-bt,Ht=-Ht,k&&(dt=-dt,pt=-pt),P&&(ut=-ut);St+=Rt,Et+=gt,xt+=Tt,yt+=bt,wt+=Ht,k&&(ke+=dt,qe+=pt),P&&(De+=ut),!(St<ze||St>=Ne);)if(Et<nt){if(gt<0)break}else if(xt<ct){if(Tt<0)break}else if(yt<ht){if(bt<0)break}else{var Nt=St>>S,Ot=zt>>S,Vt=Nt+Ot*r,It=wt+mt;if(!(p[Vt]<It)){var Ct=u[Vt];Ct&T&&ne(Nt,Ot),u[Vt]=Ct&~(g|T);var Bt=St+zt*t;if(Et>=it&&xt>=ft&&yt>=st){var At=wt+vt;p[Vt]=Math.min(p[Vt],At);var jt=Et,Ft=xt,Ut=wt;k&&(Gt=ke,Jt=qe),P&&(Kt=De);for(var Pt=0;Pt<Ie;Pt++){var kt=jt,qt=Ft,Dt=Ut;k&&(Wt=Gt,Xt=Jt),P&&(Yt=Kt);for(var Lt=0;Lt<Ie;Lt++){($t=Dt)<v[Bt]&&x(m,v,Bt,$t,Wt,Xt,Yt,y,w),kt+=ge,qt+=be,Dt+=Ke,k&&(Wt+=Ze,Xt+=Ue),P&&(Yt+=ot),Bt++}jt+=Re,Ft+=Te,Ut+=Qe,k&&(Gt+=$e,Jt+=Pe),P&&(Kt+=tt),Bt+=Mt}}else{jt=Et,Ft=xt;var Gt,Jt,Kt,Qt=yt;Ut=wt;k&&(Gt=ke,Jt=qe),P&&(Kt=De);for(Pt=0;Pt<Ie;Pt++){kt=jt,qt=Ft;var Wt,Xt,Yt,Zt=Qt;Dt=Ut;k&&(Wt=Gt,Xt=Jt),P&&(Yt=Kt);for(Lt=0;Lt<Ie;Lt++){var $t;if((kt|qt|Zt)>=0)($t=Dt)<v[Bt]&&x(m,v,Bt,$t,Wt,Xt,Yt,y,w);kt+=ge,qt+=be,Zt+=Se,Dt+=Ke,k&&(Wt+=Ze,Xt+=Ue),P&&(Yt+=ot),Bt++}jt+=Re,Ft+=Te,Qt+=He,Ut+=Qe,k&&(Gt+=$e,Jt+=Pe),P&&(Kt+=tt),Bt+=Mt}}}}Et+=Ie*Re,xt+=Ie*Te,yt+=Ie*He,wt+=Ie*Qe,k&&(ke+=Ie*$e,qe+=Ie*Pe),P&&(De+=Ie*tt)}}}function ie(e,y,w,F,U,P){if(O||(O=!0,z=1<<(S=0),function(e,y){r=Math.floor(e/z),o=Math.floor(y/z);var w=1<<b;l=w*(t=r*z)/2,i=-w*(a=o*z)/2,n=N/2,f=w*t/2+.5,c=w*a/2+.5,s=N/2+.5,M.width=t,M.height=a,E.fillStyle=x?"rgba(0, 0, 0, 0)":R.getStyle(),E.fillRect(0,0,t,a),h=E.getImageData(0,0,t,a),m=h.data,v=new Int32Array(m.length/4),d=r*o,p=new Int32Array(d),u=new Uint8Array(d);for(var T=0,H=v.length;T<H;T++)v[T]=N;for(T=0;T<d;T++)u[T]=g;ee(R)}(M.width,M.height)),!(e.z<-1||e.z>1||y.z<-1||y.z>1)){var k=Math.floor(.5*(P.linewidth-1)),q=e.x*l+f|0,D=y.x*l+f|0,L=e.y*i+c|0,G=y.y*i+c|0,J=e.z*n+s|0,K=y.z*n+s|0,Q=q-D,W=L-G,X=J-K,Y=Math.max(Math.min(q,D)+H>>b,0),Z=Math.min(Math.max(q,D)+H>>b,t),$=Math.max(Math.min(L,G)+H>>b,0),_=Math.min(Math.max(L,G)+H>>b,a),te=Math.max(Math.min(J,K)+H>>b,0),ae=Math.max(J,K)+H>>b;C=Math.min(Y,C),A=Math.max(Z,A),B=Math.min($,B),j=Math.max(_,j);var re,oe,le,ie,fe,ce=Math.sqrt(W*W+Q*Q),se=Q/ce,he=W/ce,me=X/ce;for(I.set(se,he,me),I.cross(V),I.normalize();ce>0;){re=(re=D+ce*se)+H>>b,oe=(oe=G+ce*he)+H>>b,fe=K+ce*me+H>>b;for(var ve=-k;ve<=k;++ve)if(le=Math.floor(re+I.x*ve),ie=Math.floor(oe+I.y*ve),!(C>=le||A<=le||B>=ie||j<=ie)){var de=le>>S,pe=ie>>S,ue=de+pe*r;if(!(p[ue]<te)){p[ue]=Math.min(p[ue],ae);var Me=u[ue];Me&T&&ne(de,pe),u[ue]=Me&~(g|T);var Ee=le+ie*t;fe<v[Ee]&&U(m,v,Ee,fe,w,F,P)}}--ce}}}function ne(e,a){for(var r=e*z+a*z*t,o=4*r,l=t-z,i=4*l,n=0;n<z;n++){for(var f=0;f<z;f++)v[r++]=N,m[o++]=255*R.r|0,m[o++]=255*R.g|0,m[o++]=255*R.b|0,m[o++]=x?0:255;r+=l,o+=i}}this.domElement=M,this.autoClear=!0,this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e){R.set(e),ee(R)},this.setPixelRatio=function(){},this.setSize=function(e,y){r=Math.floor(e/z),o=Math.floor(y/z);var w=1<<b;l=w*(t=r*z)/2,i=-w*(a=o*z)/2,n=N/2,f=w*t/2+.5,c=w*a/2+.5,s=N/2+.5,M.width=t,M.height=a,E.fillStyle=x?"rgba(0, 0, 0, 0)":R.getStyle(),E.fillRect(0,0,t,a),h=E.getImageData(0,0,t,a),m=h.data,v=new Int32Array(m.length/4),d=r*o,p=new Int32Array(d),u=new Uint8Array(d);for(var T=0,H=v.length;T<H;T++)v[T]=N;for(T=0;T<d;T++)u[T]=g;ee(R)},this.setSize(M.width,M.height),this.clear=function(){C=1/0,B=1/0,A=0,j=0,X=0,Z=0,_=0;for(var e=0;e<d;e++)p[e]=N,u[e]=u[e]&g?g:T},this.render=function(e,t){this.clear();var a=e.background;a&&a.isColor&&ee(a);for(var l=q.projectScene(e,t,!1,!1).elements,i=0,n=l.length;i<n;i++){var f=l[i],c=f.material;if(v=oe(c))if(f instanceof THREE.RenderableFace)f.uvs?le(f.v1.positionScreen,f.v2.positionScreen,f.v3.positionScreen,f.uvs[0],f.uvs[1],f.uvs[2],v,f,c):le(f.v1.positionScreen,f.v2.positionScreen,f.v3.positionScreen,null,null,null,v,f,c);else if(f instanceof THREE.RenderableSprite){var s=.5*f.scale.x,m=.5*f.scale.y;D.copy(f),D.x-=s,D.y+=m,L.copy(f),L.x-=s,L.y-=m,G.copy(f),G.x+=s,G.y+=m,c.map?(J.set(0,1),K.set(0,0),Q.set(1,1),le(D,L,G,J,K,Q,v,f,c)):le(D,L,G,null,null,null,v,f,c),D.copy(f),D.x+=s,D.y+=m,L.copy(f),L.x-=s,L.y-=m,G.copy(f),G.x+=s,G.y-=m,c.map?(J.set(1,1),K.set(0,0),Q.set(1,0),le(D,L,G,J,K,Q,v,f,c)):le(D,L,G,null,null,null,v,f,c)}else if(f instanceof THREE.RenderableLine){var v=oe(c);ie(f.v1.positionScreen,f.v2.positionScreen,f.vertexColors[0],f.vertexColors[1],v,c)}}!function(){for(var e=0,t=0;t<o;t++)for(var a=0;a<r;a++)u[e]&T&&(ne(a,t),u[e]=g),e++}();var d=Math.min(C,F),p=Math.min(B,U),M=Math.max(A,P)-d,x=Math.max(j,k)-p;d!==1/0&&E.putImageData(h,0,0,d,p,M,x),F=C,U=B,P=A,k=j}},THREE.SoftwareRenderer.Texture=function(){var e;this.fromImage=function(t){if(!(!t||t.width<=0||t.height<=0)){void 0===e&&(e=document.createElement("canvas"));var a=t.width>t.height?t.width:t.height;a=THREE.Math.nextPowerOfTwo(a),e.width==a&&e.height==a||(e.width=a,e.height=a);var r=e.getContext("2d");r.clearRect(0,0,a,a),r.drawImage(t,0,0,a,a);var o=r.getImageData(0,0,a,a);this.data=o.data,this.width=a,this.height=a,this.srcUrl=t.src}}};