var WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987},THREE_TO_WEBGL={1003:WEBGL_CONSTANTS.NEAREST,1004:WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,1005:WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,1006:WEBGL_CONSTANTS.LINEAR,1007:WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,1008:WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR},PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};THREE.GLTFExporter=function(){},THREE.GLTFExporter.prototype={constructor:THREE.GLTFExporter,parse:function(e,r,t){(t=Object.assign({},{trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,animations:[],forceIndices:!1,forcePowerOfTwoTextures:!1},t)).animations.length>0&&(t.trs=!0);var n,a={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},i=0,s=[],o=[],u={},l=[],E={materials:{},textures:{}};function f(e,r){return e.length===r.length&&e.every(function(e,t){return e===r[t]})}function T(e){return 4*Math.ceil(e/4)}function c(e){var r=T(e.byteLength);if(r!==e.byteLength){var t=new ArrayBuffer(r);return new Uint8Array(t).set(new Uint8Array(e)),t}return e}function m(e){return a.buffers||(a.buffers=[{byteLength:0}]),s.push(e),0}function h(e,r){a.accessors||(a.accessors=[]);var n;if(e.array.constructor===Float32Array)n=WEBGL_CONSTANTS.FLOAT;else if(e.array.constructor===Uint32Array)n=WEBGL_CONSTANTS.UNSIGNED_INT;else{if(e.array.constructor!==Uint16Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");n=WEBGL_CONSTANTS.UNSIGNED_SHORT}var s,o=function(e){for(var r={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},t=0;t<e.count;t++)for(var n=0;n<e.itemSize;n++){var a=e.array[t*e.itemSize+n];r.min[n]=Math.min(r.min[n],a),r.max[n]=Math.max(r.max[n],a)}return r}(e),u=0,l=e.count;(t.truncateDrawRange&&void 0!==r&&null===r.index&&(u=r.drawRange.start,l=r.drawRange.count!==1/0?r.drawRange.count:e.count),void 0!==r)&&(s=n===WEBGL_CONSTANTS.FLOAT?WEBGL_CONSTANTS.ARRAY_BUFFER:WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER);var E=function(e,r,t,n,s){a.bufferViews||(a.bufferViews=[]);for(var o=r===WEBGL_CONSTANTS.UNSIGNED_SHORT?2:4,u=T(n*e.itemSize*o),l=new DataView(new ArrayBuffer(u)),E=0,f=t;f<t+n;f++)for(var c=0;c<e.itemSize;c++){var h=e.array[f*e.itemSize+c];r===WEBGL_CONSTANTS.FLOAT?l.setFloat32(E,h,!0):r===WEBGL_CONSTANTS.UNSIGNED_INT?l.setUint32(E,h,!0):r===WEBGL_CONSTANTS.UNSIGNED_SHORT&&l.setUint16(E,h,!0),E+=o}var p={buffer:m(l.buffer),byteOffset:i,byteLength:u};return void 0!==s&&(p.target=s),s===WEBGL_CONSTANTS.ARRAY_BUFFER&&(p.byteStride=e.itemSize*o),i+=u,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}(e,n,u,l,s),f={bufferView:E.id,byteOffset:E.byteOffset,componentType:n,count:l,max:o.max,min:o.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return a.accessors.push(f),a.accessors.length-1}function p(e){a.images||(a.images=[]);var r,s=e.format===THREE.RGBAFormat?"image/png":"image/jpeg",u={mimeType:s};if(t.embedImages){var l=n=n||document.createElement("canvas");l.width=e.image.width,l.height=e.image.height,!t.forcePowerOfTwoTextures||(r=e.image,THREE.Math.isPowerOfTwo(r.width)&&THREE.Math.isPowerOfTwo(r.height))||(console.warn("GLTFExporter: Resized non-power-of-two image.",e.image),l.width=THREE.Math.floorPowerOfTwo(l.width),l.height=THREE.Math.floorPowerOfTwo(l.height));var E=l.getContext("2d");!0===e.flipY&&(E.translate(0,l.height),E.scale(1,-1)),E.drawImage(e.image,0,0,l.width,l.height),!0===t.binary?o.push(new Promise(function(e){l.toBlob(function(r){var t;(t=r,a.bufferViews||(a.bufferViews=[]),new Promise(function(e){var r=new window.FileReader;r.readAsArrayBuffer(t),r.onloadend=function(){var t=c(r.result),n={buffer:m(t),byteOffset:i,byteLength:t.byteLength};i+=t.byteLength,a.bufferViews.push(n),e(a.bufferViews.length-1)}})).then(function(r){u.bufferView=r,e()})},s)})):u.uri=l.toDataURL(s)}else u.uri=e.image.src;return a.images.push(u),a.images.length-1}function g(e){if(void 0!==E.textures[e.uuid])return E.textures[e.uuid];a.textures||(a.textures=[]);var r={sampler:function(e){a.samplers||(a.samplers=[]);var r={magFilter:THREE_TO_WEBGL[e.magFilter],minFilter:THREE_TO_WEBGL[e.minFilter],wrapS:THREE_TO_WEBGL[e.wrapS],wrapT:THREE_TO_WEBGL[e.wrapT]};return a.samplers.push(r),a.samplers.length-1}(e),source:p(e)};a.textures.push(r);var t=a.textures.length-1;return E.textures[e.uuid]=t,t}function d(e){a.meshes||(a.meshes=[]);var r,n=e.geometry;if(e instanceof THREE.LineSegments)r=WEBGL_CONSTANTS.LINES;else if(e instanceof THREE.LineLoop)r=WEBGL_CONSTANTS.LINE_LOOP;else if(e instanceof THREE.Line)r=WEBGL_CONSTANTS.LINE_STRIP;else if(e instanceof THREE.Points)r=WEBGL_CONSTANTS.POINTS;else{if(!n.isBufferGeometry){var i=new THREE.BufferGeometry;i.fromGeometry(n),n=i}e.drawMode===THREE.TriangleFanDrawMode?(console.warn("GLTFExporter: TriangleFanDrawMode and wireframe incompatible."),r=WEBGL_CONSTANTS.TRIANGLE_FAN):r=e.drawMode===THREE.TriangleStripDrawMode?e.material.wireframe?WEBGL_CONSTANTS.LINE_STRIP:WEBGL_CONSTANTS.TRIANGLE_STRIP:e.material.wireframe?WEBGL_CONSTANTS.LINES:WEBGL_CONSTANTS.TRIANGLES}var s={primitives:[{mode:r,attributes:{}}]},o=function(e){if(void 0!==E.materials[e.uuid])return E.materials[e.uuid];if(a.materials||(a.materials=[]),e instanceof THREE.ShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;e instanceof THREE.MeshStandardMaterial||console.warn("GLTFExporter: Currently just THREE.MeshStandardMaterial is supported. Material conversion may lose information.");var r={pbrMetallicRoughness:{}},t=e.color.toArray().concat([e.opacity]);if(f(t,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=t),e instanceof THREE.MeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),(e.metalnessMap||e.roughnessMap)&&(e.metalnessMap===e.roughnessMap?r.pbrMetallicRoughness.metallicRoughnessTexture={index:g(e.metalnessMap)}:console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.")),e.map&&(r.pbrMetallicRoughness.baseColorTexture={index:g(e.map)}),e instanceof THREE.MeshBasicMaterial||e instanceof THREE.LineBasicMaterial||e instanceof THREE.PointsMaterial);else{var n=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();f(n,[0,0,0])||(r.emissiveFactor=n),e.emissiveMap&&(r.emissiveTexture={index:g(e.emissiveMap)})}e.normalMap&&(r.normalTexture={index:g(e.normalMap)},-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),r.normalTexture.scale=e.normalScale.x)),e.aoMap&&(r.occlusionTexture={index:g(e.aoMap)},1!==e.aoMapIntensity&&(r.occlusionTexture.strength=e.aoMapIntensity)),(e.transparent||e.alphaTest>0)&&(r.alphaMode=e.opacity<1?"BLEND":"MASK",e.alphaTest>0&&.5!==e.alphaTest&&(r.alphaCutoff=e.alphaTest)),e.side===THREE.DoubleSide&&(r.doubleSided=!0),""!==e.name&&(r.name=e.name),a.materials.push(r);var i=a.materials.length-1;return E.materials[e.uuid]=i,i}(e.material);if(null!==o&&(s.primitives[0].material=o),n.index)s.primitives[0].indices=h(n.index,n);else if(t.forceIndices){for(var u=n.attributes.position.count,l=new Uint32Array(u),T=0;T<u;T++)l[T]=T;s.primitives[0].indices=h(new THREE.Uint32BufferAttribute(l,1),n)}var c=s.primitives[0].attributes,m={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"};for(var p in n.attributes){var d=n.attributes[p];"MORPH"!==(p=m[p]||p.toUpperCase()).substr(0,5)&&(c[p]=h(d,n))}if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var R=[],N=[],S={};if(void 0!==e.morphTargetDictionary)for(var A in e.morphTargetDictionary)S[e.morphTargetDictionary[A]]=A;s.primitives[0].targets=[];for(T=0;T<e.morphTargetInfluences.length;++T){var L={},v=!1;for(var p in n.morphAttributes)if("position"===p||"normal"===p){d=n.morphAttributes[p][T];for(var w=n.attributes[p],y=d.clone(),b=0,I=d.count;b<I;b++)y.setXYZ(b,d.getX(b)-w.getX(b),d.getY(b)-w.getY(b),d.getZ(b)-w.getZ(b));L[p.toUpperCase()]=h(y,n)}else v||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),v=!0);s.primitives[0].targets.push(L),R.push(e.morphTargetInfluences[T]),void 0!==e.morphTargetDictionary&&N.push(S[T])}s.weights=R,N.length>0&&(s.extras={},s.extras.targetNames=N)}return a.meshes.push(s),a.meshes.length-1}function R(e,r){a.animations||(a.animations=[]);for(var t=[],n=[],i=0;i<e.tracks.length;++i){var s=e.tracks[i],o=THREE.PropertyBinding.parseTrackName(s.name),l=THREE.PropertyBinding.findNode(r,o.nodeName),E=PATH_PROPERTIES[o.propertyName];if("bones"===o.objectName&&(l=!0===l.isSkinnedMesh?l.skeleton.getBoneByName(o.objectIndex):void 0),!l||!E)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',s.name),null;var f,T=s.values.length/s.times.length;E===PATH_PROPERTIES.morphTargetInfluences&&(T/=l.morphTargetInfluences.length),!0===s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(f="CUBICSPLINE",T/=3):f=s.getInterpolation()===THREE.InterpolateDiscrete?"STEP":"LINEAR",n.push({input:h(new THREE.BufferAttribute(s.times,1)),output:h(new THREE.BufferAttribute(s.values,T)),interpolation:f}),t.push({sampler:n.length-1,target:{node:u[l.uuid],path:E}})}return a.animations.push({name:e.name||"clip_"+a.animations.length,samplers:n,channels:t}),a.animations.length-1}function N(e){var r=a.nodes[u[e.uuid]],t=e.skeleton,n=e.skeleton.bones[0];if(void 0===n)return null;for(var i=[],s=new Float32Array(16*t.bones.length),o=0;o<t.bones.length;++o)i.push(u[t.bones[o].uuid]),t.boneInverses[o].toArray(s,16*o);return void 0===a.skins&&(a.skins=[]),a.skins.push({inverseBindMatrices:h(new THREE.BufferAttribute(s,16)),joints:i,skeleton:u[n.uuid]}),r.skin=a.skins.length-1}function S(e){if(e instanceof THREE.Light)return console.warn("GLTFExporter: Unsupported node type:",e.constructor.name),null;a.nodes||(a.nodes=[]);var r={};if(t.trs){var n=e.quaternion.toArray(),i=e.position.toArray(),s=e.scale.toArray();f(n,[0,0,0,1])||(r.rotation=n),f(i,[0,0,0])||(r.translation=i),f(s,[1,1,1])||(r.scale=s)}else e.updateMatrix(),f(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(r.matrix=e.matrix.elements);if(""!==e.name&&(r.name=String(e.name)),e.userData&&Object.keys(e.userData).length>0)try{r.extras=JSON.parse(JSON.stringify(e.userData))}catch(e){throw new Error("THREE.GLTFExporter: userData can't be serialized")}if(e instanceof THREE.Mesh||e instanceof THREE.Line||e instanceof THREE.Points?r.mesh=d(e):e instanceof THREE.Camera&&(r.camera=function(e){a.cameras||(a.cameras=[]);var r=e instanceof THREE.OrthographicCamera,t={type:r?"orthographic":"perspective"};return r?t.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:t.perspective={aspectRatio:e.aspect,yfov:THREE.Math.degToRad(e.fov)/e.aspect,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(t.name=e.type),a.cameras.push(t),a.cameras.length-1}(e)),e instanceof THREE.SkinnedMesh&&l.push(e),e.children.length>0){for(var o=[],E=0,T=e.children.length;E<T;E++){var c=e.children[E];if(c.visible||!1===t.onlyVisible){var m=S(c);null!==m&&o.push(m)}}o.length>0&&(r.children=o)}return a.nodes.push(r),u[e.uuid]=a.nodes.length-1}function A(e){a.scenes||(a.scenes=[],a.scene=0);var r={nodes:[]};""!==e.name&&(r.name=e.name),a.scenes.push(r);for(var n=[],i=0,s=e.children.length;i<s;i++){var o=e.children[i];if(o.visible||!1===t.onlyVisible){var u=S(o);null!==u&&n.push(u)}}n.length>0&&(r.nodes=n)}!function(e){e=e instanceof Array?e:[e];for(var r=[],n=0;n<e.length;n++)e[n]instanceof THREE.Scene?A(e[n]):r.push(e[n]);for(r.length>0&&function(e){var r=new THREE.Scene;r.name="AuxScene";for(var t=0;t<e.length;t++)r.children.push(e[t]);A(r)}(r),n=0;n<l.length;++n)N(l[n]);for(n=0;n<t.animations.length;++n)R(t.animations[n],e[0])}(e),Promise.all(o).then(function(){var e=new Blob(s,{type:"application/octet-stream"});if(a.buffers&&a.buffers.length>0){a.buffers[0].byteLength=e.size;var n=new window.FileReader;if(!0===t.binary){n.readAsArrayBuffer(e),n.onloadend=function(){var e=c(n.result),t=new DataView(new ArrayBuffer(8));t.setUint32(0,e.byteLength,!0),t.setUint32(4,5130562,!0);var i=function(e,r){if(r)for(var t=T(e.length)-e.length,n=0;n<t;n++)e+=" ";if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;var a=new ArrayBuffer(e.length),i=new Uint8Array(a);for(n=0;n<e.length;++n)i[n]=e.charCodeAt(n);return a}(JSON.stringify(a),!0),s=new DataView(new ArrayBuffer(8));s.setUint32(0,i.byteLength,!0),s.setUint32(4,1313821514,!0);var o=new ArrayBuffer(12),u=new DataView(o);u.setUint32(0,1179937895,!0),u.setUint32(4,2,!0);var l=12+s.byteLength+i.byteLength+t.byteLength+e.byteLength;u.setUint32(8,l,!0);var E=new Blob([o,s,i,t,e],{type:"application/octet-stream"}),f=new window.FileReader;f.readAsArrayBuffer(E),f.onloadend=function(){r(f.result)}}}else n.readAsDataURL(e),n.onloadend=function(){var e=n.result;a.buffers[0].uri=e,r(a)}}else r(a)})}};