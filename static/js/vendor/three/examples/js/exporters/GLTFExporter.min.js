var WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987},THREE_TO_WEBGL={1003:WEBGL_CONSTANTS.NEAREST,1004:WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,1005:WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,1006:WEBGL_CONSTANTS.LINEAR,1007:WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,1008:WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR},PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};THREE.GLTFExporter=function(){},THREE.GLTFExporter.prototype={constructor:THREE.GLTFExporter,parse:function(e,r,t){(t=Object.assign({},{trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,animations:[]},t)).animations.length>0&&(t.trs=!0);var a,n={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},i=0,s=[],o={},l=[],E={images:{},materials:{}};function u(e,r){return e.length===r.length&&e.every(function(e,t){return e===r[t]})}function T(e,r,t,a,o){n.bufferViews||(n.bufferViews=[]);var l=r===WEBGL_CONSTANTS.UNSIGNED_SHORT?2:4,E=a*e.itemSize*l,u={buffer:function(e,r,t,a){n.buffers||(n.buffers=[{byteLength:0,uri:""}]);for(var i=0,o=r===WEBGL_CONSTANTS.UNSIGNED_SHORT?2:4,l=a*e.itemSize*o,E=new DataView(new ArrayBuffer(l)),u=t;u<t+a;u++)for(var T=0;T<e.itemSize;T++){var c=e.array[u*e.itemSize+T];r===WEBGL_CONSTANTS.FLOAT?E.setFloat32(i,c,!0):r===WEBGL_CONSTANTS.UNSIGNED_INT?E.setUint8(i,c,!0):r===WEBGL_CONSTANTS.UNSIGNED_SHORT&&E.setUint16(i,c,!0),i+=o}return s.push(E),0}(e,r,t,a),byteOffset:i,byteLength:E};return void 0!==o&&(u.target=o),o===WEBGL_CONSTANTS.ARRAY_BUFFER&&(u.byteStride=e.itemSize*l),i+=E,n.bufferViews.push(u),{id:n.bufferViews.length-1,byteLength:0}}function c(e,r){n.accessors||(n.accessors=[]);var a;if(e.array.constructor===Float32Array)a=WEBGL_CONSTANTS.FLOAT;else if(e.array.constructor===Uint32Array)a=WEBGL_CONSTANTS.UNSIGNED_INT;else{if(e.array.constructor!==Uint16Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");a=WEBGL_CONSTANTS.UNSIGNED_SHORT}var i,s=function(e){for(var r={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},t=0;t<e.count;t++)for(var a=0;a<e.itemSize;a++){var n=e.array[t*e.itemSize+a];r.min[a]=Math.min(r.min[a],n),r.max[a]=Math.max(r.max[a],n)}return r}(e),o=0,l=e.count;(t.truncateDrawRange&&void 0!==r&&null===r.index&&(o=r.drawRange.start,l=r.drawRange.count!==1/0?r.drawRange.count:e.count),void 0!==r)&&(i=a===WEBGL_CONSTANTS.FLOAT?WEBGL_CONSTANTS.ARRAY_BUFFER:WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER);var E=T(e,a,o,l,i),u={bufferView:E.id,byteOffset:E.byteOffset,componentType:a,count:l,max:s.max,min:s.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return n.accessors.push(u),n.accessors.length-1}function m(e){n.textures||(n.textures=[]);var r={sampler:function(e){n.samplers||(n.samplers=[]);var r={magFilter:THREE_TO_WEBGL[e.magFilter],minFilter:THREE_TO_WEBGL[e.minFilter],wrapS:THREE_TO_WEBGL[e.wrapS],wrapT:THREE_TO_WEBGL[e.wrapT]};return n.samplers.push(r),n.samplers.length-1}(e),source:function(e){if(void 0!==E.images[e.uuid])return E.images[e.uuid];n.images||(n.images=[]);var r=e.format===THREE.RGBAFormat?"image/png":"image/jpeg",i={mimeType:r};if(t.embedImages){var s=a=a||document.createElement("canvas");s.width=e.image.width,s.height=e.image.height;var o=s.getContext("2d");!0===e.flipY&&(o.translate(0,e.image.height),o.scale(1,-1)),o.drawImage(e.image,0,0),i.uri=s.toDataURL(r)}else i.uri=e.image.src;n.images.push(i);var l=n.images.length-1;return E.images[e.uuid]=l,l}(e)};return n.textures.push(r),n.textures.length-1}function f(e){n.meshes||(n.meshes=[]);var r,t=e.geometry;if(e instanceof THREE.LineSegments)r=WEBGL_CONSTANTS.LINES;else if(e instanceof THREE.LineLoop)r=WEBGL_CONSTANTS.LINE_LOOP;else if(e instanceof THREE.Line)r=WEBGL_CONSTANTS.LINE_STRIP;else if(e instanceof THREE.Points)r=WEBGL_CONSTANTS.POINTS;else{if(!t.isBufferGeometry){var a=new THREE.BufferGeometry;a.fromGeometry(t),t=a}e.drawMode===THREE.TriangleFanDrawMode?(console.warn("GLTFExporter: TriangleFanDrawMode and wireframe incompatible."),r=WEBGL_CONSTANTS.TRIANGLE_FAN):r=e.drawMode===THREE.TriangleStripDrawMode?e.material.wireframe?WEBGL_CONSTANTS.LINE_STRIP:WEBGL_CONSTANTS.TRIANGLE_STRIP:e.material.wireframe?WEBGL_CONSTANTS.LINES:WEBGL_CONSTANTS.TRIANGLES}var i={primitives:[{mode:r,attributes:{}}]},s=function(e){if(void 0!==E.materials[e.uuid])return E.materials[e.uuid];if(n.materials||(n.materials=[]),e instanceof THREE.ShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;e instanceof THREE.MeshStandardMaterial||console.warn("GLTFExporter: Currently just THREE.StandardMaterial is supported. Material conversion may lose information.");var r={pbrMetallicRoughness:{}},t=e.color.toArray().concat([e.opacity]);if(u(t,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=t),e instanceof THREE.MeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),e.map&&(r.pbrMetallicRoughness.baseColorTexture={index:m(e.map)}),e instanceof THREE.MeshBasicMaterial||e instanceof THREE.LineBasicMaterial||e instanceof THREE.PointsMaterial);else{var a=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();u(a,[0,0,0])||(r.emissiveFactor=a),e.emissiveMap&&(r.emissiveTexture={index:m(e.emissiveMap)})}e.normalMap&&(r.normalTexture={index:m(e.normalMap)},-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),r.normalTexture.scale=e.normalScale.x)),e.aoMap&&(r.occlusionTexture={index:m(e.aoMap)},1!==e.aoMapIntensity&&(r.occlusionTexture.strength=e.aoMapIntensity)),(e.transparent||e.alphaTest>0)&&(r.alphaMode=e.opacity<1?"BLEND":"MASK",e.alphaTest>0&&.5!==e.alphaTest&&(r.alphaCutoff=e.alphaTest)),e.side===THREE.DoubleSide&&(r.doubleSided=!0),e.name&&(r.name=e.name),n.materials.push(r);var i=n.materials.length-1;return E.materials[e.uuid]=i,i}(e.material);null!==s&&(i.primitives[0].material=s),t.index&&(i.primitives[0].indices=c(t.index,t));var o=i.primitives[0].attributes,l={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"};for(var T in t.attributes){var f=t.attributes[T];"MORPH"!==(T=l[T]||T.toUpperCase()).substr(0,5)&&(o[T]=c(f,t))}if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){i.primitives[0].targets=[];for(var p=0;p<e.morphTargetInfluences.length;++p){var h={};for(var T in t.morphAttributes){f=t.morphAttributes[T][p];h[T=l[T]||T.toUpperCase()]=c(f,t)}i.primitives[0].targets.push(h)}}return n.meshes.push(i),n.meshes.length-1}function p(e,r){n.animations||(n.animations=[]);for(var t=[],a=[],i=0;i<e.tracks.length;++i){var s=e.tracks[i],l=THREE.PropertyBinding.parseTrackName(s.name),E=THREE.PropertyBinding.findNode(r,l.nodeName),u=PATH_PROPERTIES[l.propertyName];if("bones"===l.objectName&&(E=!0===E.isSkinnedMesh?E.skeleton.getBoneByName(l.objectIndex):void 0),!E||!u)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',s.name),null;var T=s.values.length/s.times.length;u===PATH_PROPERTIES.morphTargetInfluences&&(T/=E.morphTargetInfluences.length),a.push({input:c(new THREE.BufferAttribute(s.times,1)),output:c(new THREE.BufferAttribute(s.values,T)),interpolation:s.interpolation===THREE.InterpolateDiscrete?"STEP":"LINEAR"}),t.push({sampler:a.length-1,target:{node:o[E.uuid],path:u}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:a,channels:t}),n.animations.length-1}function h(e){var r=n.nodes[o[e.uuid]],t=e.skeleton,a=e.skeleton.bones[0];if(void 0===a)return null;for(var i=[],s=new Float32Array(16*t.bones.length),l=0;l<t.bones.length;++l)i.push(o[t.bones[l].uuid]),t.boneInverses[l].toArray(s,16*l);return void 0===n.skins&&(n.skins=[]),n.skins.push({inverseBindMatrices:c(new THREE.BufferAttribute(s,16)),joints:i,skeleton:o[a.uuid]}),r.skin=n.skins.length-1}function N(e){if(e instanceof THREE.Light)return console.warn("GLTFExporter: Unsupported node type:",e.constructor.name),null;n.nodes||(n.nodes=[]);var r={};if(t.trs){var a=e.quaternion.toArray(),i=e.position.toArray(),s=e.scale.toArray();u(a,[0,0,0,1])||(r.rotation=a),u(i,[0,0,0])||(r.translation=i),u(s,[1,1,1])||(r.scale=s)}else e.updateMatrix(),u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(r.matrix=e.matrix.elements);if(e.name&&(r.name=e.name),e.userData&&Object.keys(e.userData).length>0)try{r.extras=JSON.parse(JSON.stringify(e.userData))}catch(e){throw new Error("THREE.GLTFExporter: userData can't be serialized")}if(e instanceof THREE.Mesh||e instanceof THREE.Line||e instanceof THREE.Points?r.mesh=f(e):e instanceof THREE.Camera&&(r.camera=function(e){n.cameras||(n.cameras=[]);var r=e instanceof THREE.OrthographicCamera,t={type:r?"orthographic":"perspective"};return r?t.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far,znear:e.near}:t.perspective={aspectRatio:e.aspect,yfov:THREE.Math.degToRad(e.fov)/e.aspect,zfar:e.far,znear:e.near},e.name&&(t.name=e.type),n.cameras.push(t),n.cameras.length-1}(e)),e instanceof THREE.SkinnedMesh&&l.push(e),e.children.length>0){for(var E=[],T=0,c=e.children.length;T<c;T++){var m=e.children[T];if(m.visible||!1===t.onlyVisible){var p=N(m);null!==p&&E.push(p)}}E.length>0&&(r.children=E)}return n.nodes.push(r),o[e.uuid]=n.nodes.length-1}function S(e){n.scenes||(n.scenes=[],n.scene=0);var r={nodes:[]};e.name&&(r.name=e.name),n.scenes.push(r);for(var a=[],i=0,s=e.children.length;i<s;i++){var o=e.children[i];if(o.visible||!1===t.onlyVisible){var l=N(o);null!==l&&a.push(l)}}a.length>0&&(r.nodes=a)}!function(e){e=e instanceof Array?e:[e];for(var r=[],a=0;a<e.length;a++)e[a]instanceof THREE.Scene?S(e[a]):r.push(e[a]);for(r.length>0&&function(e){var r=new THREE.Scene;r.name="AuxScene";for(var t=0;t<e.length;t++)r.children.push(e[t]);S(r)}(r),a=0;a<l.length;++a)h(l[a]);for(a=0;a<t.animations.length;++a)p(t.animations[a],e[0])}(e);var R=new Blob(s,{type:"application/octet-stream"});if(n.buffers&&n.buffers.length>0){n.buffers[0].byteLength=R.size;var g=new window.FileReader;if(!0===t.binary){g.readAsArrayBuffer(R),g.onloadend=function(){var e=g.result,t=new DataView(new ArrayBuffer(8));t.setUint32(0,e.byteLength,!0),t.setUint32(4,5130562,!0),delete n.buffers[0].uri;var a=function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var r=new ArrayBuffer(e.length),t=new Uint8Array(r),a=0;a<e.length;++a)t[a]=e.charCodeAt(a);return r}(JSON.stringify(n)),i=new DataView(new ArrayBuffer(8));i.setUint32(0,a.byteLength,!0),i.setUint32(4,1313821514,!0);var s=new ArrayBuffer(12),o=new DataView(s);o.setUint32(0,1179937895,!0),o.setUint32(4,2,!0);var l=12+i.byteLength+a.byteLength+t.byteLength+e.byteLength;o.setUint32(8,l,!0);var E=new Blob([s,i,a,t,e],{type:"application/octet-stream"}),u=new window.FileReader;u.readAsArrayBuffer(E),u.onloadend=function(){r(u.result)}}}else g.readAsDataURL(R),g.onloadend=function(){var e=g.result;n.buffers[0].uri=e,r(n)}}else r(n)}};